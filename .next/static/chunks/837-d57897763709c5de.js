"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[837],{94508:function(e,t,o){o.d(t,{K0:function(){return j},UF:function(){return u},_2:function(){return m},ab:function(){return h},az:function(){return _},bh:function(){return g},fc:function(){return d},ji:function(){return l},xG:function(){return f}});var r=o(31559),n=o(13657),c=o(61069),s=o(55463),a=o(14613);function i(e,t){let o=[],a=(0,r.Z)(e),i=(0,n.Z)(t);for(;a<=i;)o.push((0,c.Z)(a,"yyyy-MM")),a=(0,s.Z)(a,1);return o}function l(){let e=new Date(2022,0,1),t=new Date;return i(e,(0,s.Z)(t,24))}function u(){let e=new Date;return i((0,a.Z)(e,12),(0,s.Z)(e,12))}function h(e,t,o){let r=t||[],n=o||{},s=l();return(e||[]).map(e=>{let t=r.filter(t=>t.project_id===e.project_id),o=s.map(o=>{var r,s,a;let i=t.filter(e=>(0,c.Z)(new Date(e.date),"yyyy-MM")===o),l=i.reduce((e,t)=>e+t.billed_amount,0),u=i.reduce((e,t)=>e+t.unbilled_amount,0),h=(null===(a=n[e.project_id])||void 0===a?void 0:null===(s=a.months)||void 0===s?void 0:null===(r=s[o])||void 0===r?void 0:r.value)||0;return{month:o,billed:l,unbilled:u,projected:h,actual:l+u}}),a=o.reduce((e,t)=>e+t.billed,0),i=o.reduce((e,t)=>e+t.unbilled,0),l=o.reduce((e,t)=>e+t.projected,0);return{projectId:e.project_id,projectName:e.project_name,customerName:e.customer_name,signedFee:void 0,monthlyData:o,totalBilled:a,totalUnbilled:i,totalProjected:l}})}function d(e,t){if(!e||!Array.isArray(e))return{totalProjects:0,totalBilled:0,totalUnbilled:0,totalProjected:0,activeProjects:0};let o=e.length,r=t?t.size:0,n=m("monthlyProjections")||{},c=m("monthlyStatuses")||{},s=new Date().getFullYear().toString(),a=0;Object.keys(n).forEach(e=>{let t=n[e],o=c[e];t&&o&&Object.keys(t).forEach(e=>{e.startsWith(s)&&"Billed"===o[e]&&(a+=t[e]||0)})});let i=new Date().toISOString().slice(0,7),l=0;return Object.keys(n).forEach(e=>{let t=n[e],o=c[e];t&&o&&Object.keys(t).forEach(e=>{e>=i&&"Billed"!==o[e]&&(l+=t[e]||0)})}),{totalProjects:o,totalBilled:a,totalUnbilled:l,totalProjected:e.reduce((e,t)=>e+t.totalProjected,0),activeProjects:o-r}}function f(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e)}function g(e){let[t,o]=e.split("-"),r=new Date(parseInt(t),parseInt(o)-1);return(0,c.Z)(r,"MMM yyyy")}function p(){try{let e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}function m(e){if(!p())return console.warn("localStorage is not available"),null;try{let t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.error("Error reading from localStorage key '".concat(e,"':"),t),null}}function _(e,t){if(!p())return console.warn("localStorage is not available"),!1;try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(t){return console.error("Error writing to localStorage key '".concat(e,"':"),t),!1}}function j(e){let t=l(),o={};return(e||[]).forEach(e=>{o[e.project_id]={months:{},asrFee:0},t.forEach(t=>{let r=t>(0,c.Z)(new Date,"yyyy-MM");o[e.project_id].months[t]={value:0,isEditable:r,isProjected:r}})}),o}},10398:function(e,t,o){o.d(t,{VC:function(){return c},WM:function(){return a},bl:function(){return s}});var r=o(83464);class n{_startAutoRefresh(){this.autoRefreshTimer&&clearInterval(this.autoRefreshTimer),this.autoRefreshTimer=setInterval(async()=>{try{console.log("Auto-refreshing Zoho token (45-minute interval)..."),this.lastRefreshTime=Date.now(),await this.forceRefreshToken(),console.log("Auto-refresh completed successfully")}catch(e){console.error("Auto-refresh failed:",e)}},this.AUTO_REFRESH_INTERVAL),this.lastRefreshTime=Date.now(),console.log("Automatic Zoho token refresh started (every 45 minutes)")}_stopAutoRefresh(){this.autoRefreshTimer&&(clearInterval(this.autoRefreshTimer),this.autoRefreshTimer=null,console.log("Automatic Zoho token refresh stopped"))}async getAccessToken(){if(this.accessToken&&Date.now()<this.tokenExpiry-this.TOKEN_REFRESH_BUFFER)return this.accessToken;if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this.refreshAccessToken();try{return await this.refreshPromise}finally{this.refreshPromise=null}}async refreshAccessToken(){try{console.log("Refreshing Zoho access token...");let e=new URLSearchParams;e.append("refresh_token","1000.4bf26c4881dfba83aae32546453d662d.a9353e91362a18c457b5cbec86b10ed2"),e.append("client_id","1000.8RL8WMTDXS0WIP2EJF2XUS6NDSLQEP"),e.append("client_secret","8a7ee3c04f0a0d860dd215c4449deab9bf15d1d00b"),e.append("grant_type","refresh_token");let t=await r.Z.post("https://accounts.zoho.com/oauth/v2/token",e,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return this.accessToken=t.data.access_token,this.tokenExpiry=Date.now()+1e3*t.data.expires_in,console.log("Token refreshed successfully. Expires in ".concat(Math.round(t.data.expires_in/60)," minutes")),this.accessToken}catch(e){throw console.error("Error refreshing Zoho access token:",e),Error("Failed to authenticate with Zoho")}}async makeRequest(e){let t=await this.getAccessToken();try{return(await r.Z.get("https://www.zohoapis.com/books/v3/".concat(e),{headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},params:{organization_id:"652094923"}})).data}catch(t){var o;if((null===(o=t.response)||void 0===o?void 0:o.status)===401){console.log("Token expired, refreshing..."),this.accessToken=null,this.tokenExpiry=0;let t=await this.getAccessToken();return(await r.Z.get("https://www.zohoapis.com/books/v3/".concat(e),{headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},params:{organization_id:"652094923"}})).data}throw console.error("Error making Zoho request to ".concat(e,":"),t),Error("Failed to fetch data from Zoho: ".concat(e))}}async getProjects(){try{let t=[],o=1;for(;;){var e;let r=await this.makeRequest("projects?page=".concat(o,"&per_page=").concat(200)),n=(null===(e=r.projects)||void 0===e?void 0:e.map(e=>(1===o&&0===t.length&&console.log("Sample Zoho project data:",JSON.stringify(e,null,2)),{project_id:e.project_id,project_name:e.project_name||e.name||"",description:e.description||"",status:e.status||"active",start_date:e.start_date||"",end_date:e.end_date||"",budget_amount:e.budget_amount||0,rate_per_hour:e.rate_per_hour||0,customer_id:e.customer_id||"",customer_name:e.customer_name||"",signed_fee:void 0})))||[];if(t=t.concat(n),n.length<200)break;o++}return console.log("Fetched ".concat(t.length," projects from Zoho")),t}catch(e){return console.error("Error fetching projects:",e),[]}}async getProjectsWithRevenueBudget(){try{console.log("Fetching projects with revenue budget data...");let e=await this.getProjects(),t=e.filter(e=>{let t=e.signed_fee&&e.signed_fee>0;return t&&console.log("Project ".concat(e.project_name," has revenue budget: $").concat(e.signed_fee)),t});return console.log("Found ".concat(t.length," projects with revenue budget data")),e}catch(e){return console.error("Error fetching projects with revenue budget:",e),[]}}async debugProjectFields(){try{console.log("Debugging Zoho project fields...");let e=await this.makeRequest("projects?page=1&per_page=5");if(e.projects&&e.projects.length>0){console.log("Available fields in Zoho project response:");let t=e.projects[0];Object.keys(t).forEach(e=>{console.log("  ".concat(e,": ").concat(t[e]," (").concat(typeof t[e],")"))}),void 0!==t.revenue_budget?console.log("✅ Found revenue_budget field: ".concat(t.revenue_budget)):(console.log("❌ revenue_budget field not found in Zoho response"),console.log("Available budget-related fields:"),Object.keys(t).forEach(e=>{(e.toLowerCase().includes("budget")||e.toLowerCase().includes("revenue"))&&console.log("  ".concat(e,": ").concat(t[e]))}))}else console.log("No projects found in Zoho response")}catch(e){console.error("Error debugging project fields:",e)}}async getProjectsWithEstimates(){try{let e=await this.getProjects();return[...await Promise.all(e.slice(0,5).map(async e=>{try{let t=await this.getProjectEstimates(e.project_id),o=t.reduce((e,t)=>e+(t.total||0),0);return console.log("Project ".concat(e.project_name," estimates:"),t.length,"total amount:",o),{...e,signed_fee:e.signed_fee||o||0}}catch(t){return console.error("Error fetching estimates for project ".concat(e.project_id,":"),t),e}})),...e.slice(5)]}catch(e){return console.error("Error fetching projects with estimates:",e),[]}}async getProjectsWithInvoiceTotals(){try{let[e,t]=await Promise.all([this.getProjects(),this.getInvoices()]);return e.map(e=>{let o=t.filter(t=>t.project_id===e.project_id),r=o.reduce((e,t)=>e+t.amount,0);return console.log("Project ".concat(e.project_name," invoices:"),o.length,"total amount:",r),{...e,signed_fee:e.signed_fee||r||0}})}catch(e){return console.error("Error fetching projects with invoice totals:",e),[]}}async getInvoices(){try{var e;let t=await this.makeRequest("invoices");return(null===(e=t.invoices)||void 0===e?void 0:e.map(e=>({invoice_id:e.invoice_id,project_id:e.project_id,invoice_number:e.invoice_number,date:e.date,amount:e.total,status:e.status,billed_amount:e.billed_amount||0,unbilled_amount:e.unbilled_amount||0})))||[]}catch(e){return console.error("Error fetching invoices:",e),[]}}async getProjectInvoices(e){try{var t;let o=await this.makeRequest("projects/".concat(e,"/invoices"));return(null===(t=o.invoices)||void 0===t?void 0:t.map(e=>({invoice_id:e.invoice_id,project_id:e.project_id,invoice_number:e.invoice_number,date:e.date,amount:e.total,status:e.status,billed_amount:e.billed_amount||0,unbilled_amount:e.unbilled_amount||0})))||[]}catch(e){return console.error("Error fetching project invoices:",e),[]}}async getProjectDetails(e){try{let t=await this.makeRequest("projects/".concat(e));return console.log("Project ".concat(e," details:"),JSON.stringify(t,null,2)),t}catch(e){return console.error("Error fetching project details:",e),null}}async getProjectEstimates(e){try{let t=await this.makeRequest("projects/".concat(e,"/estimates"));return console.log("Project ".concat(e," estimates:"),JSON.stringify(t,null,2)),t.estimates||[]}catch(e){return console.error("Error fetching project estimates:",e),[]}}async getProjectContracts(e){try{let t=await this.makeRequest("projects/".concat(e,"/contracts"));return console.log("Project ".concat(e," contracts:"),JSON.stringify(t,null,2)),t.contracts||[]}catch(e){return console.error("Error fetching project contracts:",e),[]}}async forceRefreshToken(){this.accessToken=null,this.tokenExpiry=0,this.lastRefreshTime=Date.now(),await this.getAccessToken()}getTokenStatus(){let e=Date.now();return{hasToken:!!this.accessToken,expiresIn:this.tokenExpiry-e,isExpired:e>=this.tokenExpiry}}getAutoRefreshStatus(){let e=Date.now()-this.lastRefreshTime,t=Math.max(0,this.AUTO_REFRESH_INTERVAL-e);return{isActive:!!this.autoRefreshTimer,nextRefreshIn:t}}enableAutoRefresh(){this._startAutoRefresh()}disableAutoRefresh(){this._stopAutoRefresh()}getStatus(){return{...this.getTokenStatus(),autoRefresh:this.getAutoRefreshStatus()}}constructor(){this.accessToken=null,this.tokenExpiry=0,this.refreshPromise=null,this.TOKEN_REFRESH_BUFFER=3e5,this.autoRefreshTimer=null,this.AUTO_REFRESH_INTERVAL=27e5,this.lastRefreshTime=0,this._startAutoRefresh()}}let c=new n,s=async()=>{try{console.log("Client: Fetching projects from API");let e=await fetch("/api/projects"),t=await e.json();if(t.success)return console.log("Client: Successfully fetched",t.count,"projects"),t.data;throw console.error("Client: API returned error:",t.error),Error(t.error)}catch(e){throw console.error("Client: Error fetching projects:",e),e}},a=async()=>{try{console.log("Client: Fetching invoices from API");let e=await fetch("/api/invoices"),t=await e.json();if(t.success)return console.log("Client: Successfully fetched",t.count,"invoices"),t.data;throw console.error("Client: API returned error:",t.error),Error(t.error)}catch(e){throw console.error("Client: Error fetching invoices:",e),e}}}}]);