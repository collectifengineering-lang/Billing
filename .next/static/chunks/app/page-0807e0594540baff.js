(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{78929:function(e,t,r){Promise.resolve().then(r.bind(r,25789))},25789:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return el}});var s=r(57437),a=r(2265),o=r(99376),l=r(90483),n=r(58091),i=r(94508),c=r(10398),d=r(40257);class u{getHeaders(){if(!this.apiKey)throw Error("Clockify API key not configured");return{"X-Api-Key":this.apiKey,"Content-Type":"application/json"}}async makeRequest(e,t){if(!this._isConfigured)throw Error("Clockify service not properly configured");try{let r=new URL("".concat(this.baseUrl).concat(e));t&&Object.keys(t).forEach(e=>{void 0!==t[e]&&null!==t[e]&&r.searchParams.append(e,t[e])});let s=await fetch(r.toString(),{method:"GET",headers:this.getHeaders()});if(401===s.status)throw Error("Clockify API authentication failed - check your API key");if(403===s.status)throw Error("Clockify API access forbidden - check your workspace ID and permissions");if(429===s.status)throw Error("Clockify API rate limit exceeded - try again later");if(!s.ok)throw Error("Clockify API error: ".concat(s.status," ").concat(s.statusText));return await s.json()}catch(e){if(e instanceof Error)throw e;throw Error("Clockify API request failed: ".concat(e))}}isConfigured(){return this._isConfigured}getConfigurationStatus(){return{configured:this._isConfigured,hasApiKey:!!(this.apiKey&&"your_clockify_api_key_here"!==this.apiKey),hasWorkspaceId:!!(this.workspaceId&&"your_clockify_workspace_id_here"!==this.workspaceId)}}getConfigStatus(){return this.getConfigurationStatus()}setWorkspaceId(e){this.workspaceId=e,this.apiKey&&"your_clockify_api_key_here"!==this.apiKey&&(this._isConfigured=!0)}async getUser(){try{return await this.makeRequest("/user")}catch(e){return console.error("Failed to get Clockify user:",e),{id:"mock-user-id",name:"Mock User",email:"user@example.com",status:"ACTIVE"}}}async getWorkspaces(){try{return await this.makeRequest("/workspaces")}catch(e){return console.error("Failed to get Clockify workspaces:",e),[{id:"mock-workspace-id",name:"Mock Workspace",hourlyRate:{amount:100,currency:"USD"}}]}}async getProjects(){try{if(!this.workspaceId)throw Error("Workspace ID not configured");return await this.makeRequest("/workspaces/".concat(this.workspaceId,"/projects"))}catch(e){return console.error("Failed to get Clockify projects:",e),[{id:"mock-project-1",name:"Mock Project 1",clientId:"mock-client-1",clientName:"Mock Client 1",status:"ACTIVE",billable:!0,hourlyRate:{amount:150,currency:"USD"}},{id:"mock-project-2",name:"Mock Project 2",clientId:"mock-client-2",clientName:"Mock Client 2",status:"ACTIVE",billable:!0,hourlyRate:{amount:175,currency:"USD"}}]}}async getTimeEntries(e,t,r){try{if(!this.workspaceId)throw Error("Workspace ID not configured");return await this.makeRequest("/workspaces/".concat(this.workspaceId,"/projects/").concat(e,"/time-entries"),{start:t,end:r})}catch(e){return console.error("Failed to get Clockify time entries:",e),[{id:"mock-time-entry-1",description:"Mock work session",timeInterval:{start:t,end:r,duration:"PT2H30M"},billable:!0,userId:"mock-user-id",userName:"Mock User"}]}}async getAllTimeEntries(e,t){try{if(!this.workspaceId)throw Error("Workspace ID not configured");return await this.makeRequest("/workspaces/".concat(this.workspaceId,"/time-entries"),{start:e,end:t})}catch(r){return console.error("Failed to get all Clockify time entries:",r),[{id:"mock-time-entry-1",description:"Mock work session",timeInterval:{start:e,end:t,duration:"PT8H0M"},billable:!0,userId:"mock-user-id",userName:"Mock User",projectId:"mock-project-1",projectName:"Mock Project 1"}]}}async getUsers(){try{if(!this.workspaceId)throw Error("Workspace ID not configured");return await this.makeRequest("/workspaces/".concat(this.workspaceId,"/users"))}catch(e){return console.error("Failed to get Clockify users:",e),[{id:"mock-user-1",name:"Mock User 1",email:"user1@example.com",status:"ACTIVE",hourlyRate:{amount:100,currency:"USD"}},{id:"mock-user-2",name:"Mock User 2",email:"user2@example.com",status:"ACTIVE",hourlyRate:{amount:120,currency:"USD"}}]}}async getProjectTimeReport(e,t,r){try{var s,a,o;if(!this.workspaceId)throw Error("Workspace ID not configured");let l=await this.getTimeEntries(e,t,r),n=await this.getProjects().then(t=>t.find(t=>t.id===e));if(!n)throw Error("Project not found");let i=l.reduce((e,t)=>{let r=t.timeInterval.duration,s=this.parseDuration(r);return e+s},0),c=l.filter(e=>e.billable).reduce((e,t)=>{let r=t.timeInterval.duration,s=this.parseDuration(r);return e+s},0),d=i-c;return{projectId:e,projectName:n.name,totalHours:i,billableHours:c,nonBillableHours:d,totalAmount:i*((null===(s=n.hourlyRate)||void 0===s?void 0:s.amount)||0),billableAmount:c*((null===(a=n.hourlyRate)||void 0===a?void 0:a.amount)||0),nonBillableAmount:d*((null===(o=n.hourlyRate)||void 0===o?void 0:o.amount)||0),entries:l,period:{start:t,end:r}}}catch(e){return console.error("Failed to get project time report:",e),null}}async getAllProjectsTimeSummary(e,t){try{if(!this.workspaceId)throw Error("Workspace ID not configured");let r=await this.getProjects(),s=[];for(let a of r){let r=await this.getProjectTimeReport(a.id,e,t);r&&s.push(r)}return s}catch(e){return console.error("Failed to get all projects time summary:",e),[]}}parseDuration(e){let t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return t?parseInt(t[1]||"0")+parseInt(t[2]||"0")/60+parseInt(t[3]||"0")/3600:0}constructor(){this.apiKey=null,this.workspaceId=null,this.baseUrl="https://api.clockify.me/api/v1",this._isConfigured=!1,this.apiKey=d.env.CLOCKIFY_API_KEY||null,this.workspaceId=d.env.CLOCKIFY_WORKSPACE_ID||null,this.apiKey&&"your_clockify_api_key_here"!==this.apiKey&&this.workspaceId&&"your_clockify_workspace_id_here"!==this.workspaceId?(this._isConfigured=!0,console.log("Clockify service initialized with valid credentials")):(this._isConfigured=!1,console.warn("Clockify service initialized without valid credentials - will use mock data"),console.warn("Please set CLOCKIFY_API_KEY and CLOCKIFY_WORKSPACE_ID in your environment variables"))}}let m=new u,h=async(e,t)=>{try{return await m.getAllProjectsTimeSummary(e,t)}catch(e){return console.error("Error fetching Clockify time summaries:",e),[]}};var x=r(7586),g=r(46221),f=r(98728),p=r(91723),j=r(27648),b=r(33145);function y(e){var t;let{cacheInfo:r,autoRefreshStatus:a}=e,{user:o}=(0,l.a)();return(0,s.jsx)("div",{className:"bg-white shadow-sm border-b border-gray-200",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex items-center justify-between h-16",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-8",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("div",{className:"relative w-12 h-12",children:(0,s.jsx)(b.default,{src:"/collectif-logo.png",alt:"Collectif Logo",fill:!0,className:"object-contain"})}),(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Collectif MEP's Billings"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsxs)(j.default,{href:"/projects",className:"flex items-center text-gray-600 hover:text-gray-900 transition-colors",children:[(0,s.jsx)(x.Z,{className:"h-5 w-5 mr-2"}),"Project Summary"]}),(null==o?void 0:o.isAdmin)&&(0,s.jsxs)(j.default,{href:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-900 transition-colors",children:[(0,s.jsx)(g.Z,{className:"h-5 w-5 mr-2"}),"Financial Dashboard"]}),(null==o?void 0:o.isAdmin)&&(0,s.jsxs)(j.default,{href:"/settings",className:"flex items-center text-gray-600 hover:text-gray-900 transition-colors",children:[(0,s.jsx)(f.Z,{className:"h-5 w-5 mr-2"}),"Settings"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[a&&(0,s.jsxs)("div",{className:"flex items-center space-x-2 text-xs text-gray-500",children:[(0,s.jsx)(p.Z,{className:"h-3 w-3"}),(0,s.jsx)("span",{className:a.isActive?"text-green-600":"text-gray-400",children:a.isActive?"Auto-refresh":"Auto-refresh off"}),a.isActive&&(0,s.jsxs)("span",{className:"text-gray-400",children:["(",(t=a.nextRefreshIn,"".concat(Math.floor(t/6e4),":").concat(Math.floor(t%6e4/1e3).toString().padStart(2,"0"))),")"]})]}),r&&(0,s.jsxs)("div",{className:"text-xs text-gray-500",children:[r.fromCache?"From cache":"Fresh data",r.changes&&(0,s.jsxs)("span",{className:"ml-2 text-green-600",children:["+",Object.values(r.changes).flat().length," changes"]})]})]})]})})})}var v=r(48736),w=r(95252),N=r(70525),k=r(95805);function S(e){let{billingData:t,closedProjects:r,stats:a}=e,o=a||(0,i.fc)(t,r),l=[{name:"Total Projects",value:o.totalProjects,icon:v.Z,color:"bg-blue-500"},{name:"Total Billed YTD",value:(0,i.xG)(o.totalBilled),icon:w.Z,color:"bg-green-500"},{name:"Backlog",value:(0,i.xG)(o.totalUnbilled),icon:N.Z,color:"bg-yellow-500"},{name:"Active Projects",value:o.activeProjects,icon:k.Z,color:"bg-purple-500"}];return(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:l.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value})]})]})},e.name))})}var C=r(58896),I=r(11239),P=r(42488),E=r(33327);function A(e){let{stats:t}=e,r=[{name:"Total Projects",value:t.totalProjects,icon:v.Z,color:"bg-blue-500",description:"Active and closed projects"},{name:"Total Billed YTD",value:(0,i.xG)(t.totalBilled),icon:w.Z,color:"bg-green-500",description:"Year-to-date billed amount"},{name:"Backlog",value:(0,i.xG)(t.totalUnbilled),icon:N.Z,color:"bg-yellow-500",description:"Unbilled work in progress"},{name:"Active Projects",value:t.activeProjects,icon:k.Z,color:"bg-purple-500",description:"Currently active projects"}],a=[{name:"Total Hours",value:(0,i.bx)(t.totalHours),icon:p.Z,color:"bg-indigo-500",description:"Total tracked hours"},{name:"Billable Hours",value:(0,i.bx)(t.billableHours),icon:C.Z,color:"bg-emerald-500",description:"Billable time tracked"},{name:"Efficiency",value:(0,i.sP)(t.efficiency),icon:g.Z,color:"bg-orange-500",description:"Billable hours ratio"},{name:"Avg Hourly Rate",value:(0,i.xG)(t.averageHourlyRate),icon:I.Z,color:"bg-pink-500",description:"Average billable rate"}],o=[{name:"Total Time Value",value:(0,i.xG)(t.totalTimeValue),icon:P.Z,color:"bg-cyan-500",description:"Total value of tracked time"},{name:"Avg Hours/Project",value:(0,i.bx)(t.averageHoursPerProject),icon:E.Z,color:"bg-violet-500",description:"Average hours per project"}];return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Billing Overview"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:r.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Time Tracking KPIs"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:a.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Performance Metrics"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:o.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.name))})]}),t.topPerformingProjects.length>0&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Top Performing Projects"}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.topPerformingProjects.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:(0,s.jsx)("div",{className:"w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white text-sm font-bold",children:t+1})})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("p",{className:"text-sm font-medium text-gray-900 truncate",children:["Project ",e]}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"High efficiency & hours"})]})]},e))})})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,s.jsx)("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-medium opacity-90",children:"Total Revenue"}),(0,s.jsx)("p",{className:"text-2xl font-bold",children:(0,i.xG)(t.totalBilled+t.totalUnbilled)})]}),(0,s.jsx)(w.Z,{className:"h-8 w-8 opacity-80"})]})}),(0,s.jsx)("div",{className:"bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow p-6 text-white",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-medium opacity-90",children:"Time Value"}),(0,s.jsx)("p",{className:"text-2xl font-bold",children:(0,i.xG)(t.totalTimeValue)})]}),(0,s.jsx)(p.Z,{className:"h-8 w-8 opacity-80"})]})}),(0,s.jsx)("div",{className:"bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow p-6 text-white",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-medium opacity-90",children:"Efficiency"}),(0,s.jsx)("p",{className:"text-2xl font-bold",children:(0,i.sP)(t.efficiency)})]}),(0,s.jsx)(g.Z,{className:"h-8 w-8 opacity-80"})]})})]})]})}var T=r(47625),O=r(7476),D=r(56940),F=r(97059),R=r(62994),Z=r(8147),_=r(22190),M=r(23263),L=r(77086);function U(e){let{billingData:t,closedProjects:r}=e,o=t||[],l=r||new Set,[n,c]=(0,a.useState)(0),d=e=>fetch(e).then(e=>e.json()),{data:u}=(0,L.ZP)("/api/projections",d),{data:m}=(0,L.ZP)("/api/statuses",d);(0,a.useEffect)(()=>{let e=()=>{c(e=>e+1)};return window.addEventListener("projectionsUpdated",e),window.addEventListener("statusUpdated",e),()=>{window.removeEventListener("projectionsUpdated",e),window.removeEventListener("statusUpdated",e)}},[]);let h=u||{},x=m||{},g=(0,i.UF)().map(e=>{let t=0,r=0,s=new Set([...o.map(e=>e.projectId),...Array.from(l)]);s.forEach(s=>{let a=h[s],o=x[s];if(a&&a[e]){let s=a[e];o&&"Billed"===o[e]?r+=s:t+=s}});let a=t;return e===new Date().toISOString().slice(0,7)&&console.log("BillingChart: Current month data:",{month:e,monthProjected:t,monthBilled:r,monthUnbilled:a,allProjectIdsCount:s.size,activeProjectsCount:o.length,closedProjectsCount:l.size}),{month:e,name:(0,i.bh)(e),billed:r,unbilled:a,projected:t,total:t}});return(0,s.jsx)("div",{className:"h-80",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsx)("div",{className:"chart-container",children:(0,s.jsx)(T.h,{width:"100%",height:320,children:(0,s.jsxs)(O.T,{data:g,margin:{top:20,right:30,left:20,bottom:5},children:[(0,s.jsx)(D.q,{strokeDasharray:"3 3"}),(0,s.jsx)(F.K,{dataKey:"name",angle:-45,textAnchor:"end",height:80,fontSize:12,interval:0}),(0,s.jsx)(R.B,{tickFormatter:e=>"$".concat((e/1e3).toFixed(0),"k"),fontSize:12,label:{value:"Amount (USD)",angle:-90,position:"insideLeft"}}),(0,s.jsx)(Z.u,{content:(0,s.jsx)(e=>{let{active:t,payload:r,label:a}=e;return t&&r&&r.length?(0,s.jsxs)("div",{className:"bg-white p-4 border rounded-lg shadow-lg",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900",children:a}),r.map((e,t)=>(0,s.jsxs)("p",{className:"text-sm",style:{color:e.color},children:[e.name,": ",(0,i.xG)(e.value)]},t))]}):null},{})}),(0,s.jsx)(_.D,{}),(0,s.jsx)(M.u,{type:"monotone",dataKey:"projected",stackId:"1",stroke:"#f97316",fill:"#f97316",fillOpacity:.6,name:"Projected"}),(0,s.jsx)(M.u,{type:"monotone",dataKey:"billed",stackId:"1",stroke:"#10b981",fill:"#10b981",fillOpacity:.6,name:"Billed"})]})})})})})}var B=r(29),z=r.n(B),H=r(60413),J=r(22135),K=r(40875),V=r(73247),W=r(32489),Y=r(92369),G=r(30401),q=r(69064),X=r(92735),$=r(17689),Q=r(65302),ee=r(22252);function et(e){let t=[],r="",s=!1;for(let a=0;a<e.length;a++){let o=e[a];'"'===o?s&&'"'===e[a+1]?(r+='"',a++):s=!s:","!==o||s?r+=o:(t.push(r.trim()),r="")}return t.push(r.trim()),t}function er(e){let[t,r]=e.split("-");return new Date(parseInt(t),parseInt(r)-1).toLocaleDateString("en-US",{month:"short",year:"numeric"})}function es(e,t){let r=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");if(void 0!==s.download){let e=URL.createObjectURL(r);s.setAttribute("href",e),s.setAttribute("download",t),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}}function ea(e){let{billingData:t,monthlyProjections:r,asrFees:o,signedFees:l,monthRange:n,onImportData:i}=e,[c,d]=(0,a.useState)(!1),[u,m]=(0,a.useState)(null),[h,x]=(0,a.useState)(!1),g=(0,a.useRef)(null),f=async e=>{var r;let s=null===(r=e.target.files)||void 0===r?void 0:r[0];if(s){if(!s.name.toLowerCase().endsWith(".csv")){q.Am.error("Please select a CSV file");return}d(!0),m(null);try{let e=await new Promise((e,t)=>{let r=new FileReader;r.onload=t=>{var r;e(null===(r=t.target)||void 0===r?void 0:r.result)},r.onerror=()=>{t(Error("Failed to read CSV file"))},r.readAsText(s)}),r=function(e,t){try{let r=e.trim().split("\n");if(r.length<2)return{success:!1,errors:["CSV file must have at least a header row and one data row"]};let s=et(r[0]),a=r.slice(1),o=["Project ID","Project Name","Customer Name","Signed Fee","ASR Fee"].filter(e=>!s.includes(e));if(o.length>0)return{success:!1,errors:["Missing required headers: ".concat(o.join(", "))]};let l=s.slice(5),n=l.filter(e=>!/^\d{4}-\d{2}$/.test(e));if(n.length>0)return{success:!1,errors:["Invalid month format found: ".concat(n.join(", "),". Expected format: YYYY-MM")]};let i={},c=[];if(a.forEach((e,r)=>{let a=et(e);if(a.length!==s.length){c.push("Row ".concat(r+2,": Column count mismatch. Expected ").concat(s.length,", got ").concat(a.length));return}let o=a[0].trim();if(a[1],a[2],parseFloat(a[3]),parseFloat(a[4]),!t.some(e=>e.projectId===o)){c.push("Row ".concat(r+2,': Project ID "').concat(o,'" not found in current data'));return}let n={};l.forEach((e,t)=>{let r=parseFloat(a[5+t])||0;n[e]=r}),i[o]=n}),c.length>0)return{success:!1,errors:c,data:i};return{success:!0,data:i,message:"Successfully imported ".concat(Object.keys(i).length," projects with ").concat(l.length," months of data")}}catch(e){return{success:!1,errors:["Error parsing CSV: ".concat(e instanceof Error?e.message:"Unknown error")]}}}(e,t);m(r),r.success&&r.data?q.Am.success(r.message||"Import completed successfully!"):q.Am.error("Import failed. Please check the errors below.")}catch(e){console.error("Import error:",e),q.Am.error("Failed to read CSV file"),m({success:!1,errors:["Failed to read CSV file"]})}finally{d(!1)}}},p=()=>{x(!1),m(null),g.current&&(g.current.value="")};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,s.jsxs)("button",{onClick:()=>{try{let e=function(e,t,r,s,a){let o=["Project ID","Project Name","Customer Name","Signed Fee","ASR Fee",...a.map(e=>er(e))],l=e.map(e=>{let o={projectId:e.projectId,projectName:e.projectName,customerName:e.customerName,signedFee:s[e.projectId]||e.signedFee||0,asrFee:r[e.projectId]||0};return a.forEach(r=>{var s;let a=(null===(s=t[e.projectId])||void 0===s?void 0:s[r])||0;o[r]=a}),o});return[o.join(","),...l.map(e=>o.map(t=>{let r;if("Project ID"===t){let t=e.projectId;console.log("CSV Export - Project ID type:",typeof t,"value:",t),console.log("CSV Export - Final Project ID value:",r="number"==typeof t||"string"==typeof t?String(t):"")}else if("Project Name"===t)r=e.projectName;else if("Customer Name"===t)r=e.customerName;else if("Signed Fee"===t)r=e.signedFee;else if("ASR Fee"===t)r=e.asrFee;else{let s=a.find(e=>er(e)===t);r=s?e[s]:0}let s=String(r).replace(/"/g,'""');return'"'.concat(s,'"')}).join(","))].join("\n")}(t,r,o,l,n),s=function(){let e=new Date,t=e.toISOString().slice(0,10),r=e.toTimeString().slice(0,8).replace(/:/g,"-");return"projections-export-".concat(t,"-").concat(r,".csv")}();es(e,s),q.Am.success("Projections exported successfully!")}catch(e){console.error("Export error:",e),q.Am.error("Failed to export projections")}},className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[(0,s.jsx)(X.Z,{className:"w-4 h-4"}),"Export to CSV"]}),(0,s.jsxs)("button",{onClick:()=>{x(!0),m(null)},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[(0,s.jsx)($.Z,{className:"w-4 h-4"}),"Import from CSV"]}),(0,s.jsxs)("button",{onClick:()=>{es("Project ID,Project Name,Customer Name,Signed Fee,ASR Fee,2024-01,2024-02,2024-03,2024-04,2024-05,2024-06\n910829000008470049,Sample Project,Sample Customer,50000,10000,5000,7500,6000,8000,9000,7000","projections-template.csv"),q.Am.success("Template downloaded successfully!")},className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:[(0,s.jsx)(v.Z,{className:"w-4 h-4"}),"Download Template"]})]}),h&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsxs)("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[(0,s.jsx)(v.Z,{className:"w-5 h-5"}),"Import Projections from CSV"]}),(0,s.jsx)("button",{onClick:p,className:"text-gray-500 hover:text-gray-700",children:(0,s.jsx)(W.Z,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"Select a CSV file to import projections data. The file should include:"}),(0,s.jsxs)("ul",{className:"text-sm text-gray-600 list-disc list-inside mb-4",children:[(0,s.jsx)("li",{children:"Project ID, Project Name, Customer Name"}),(0,s.jsx)("li",{children:"Signed Fee and ASR Fee columns"}),(0,s.jsx)("li",{children:"Monthly projection columns (format: YYYY-MM)"})]}),(0,s.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:(0,s.jsxs)("p",{className:"text-sm text-blue-800",children:[(0,s.jsx)("strong",{children:"Tip:"}),' Use the "Download Template" button to get a sample CSV file with the correct format.']})}),(0,s.jsx)("input",{ref:g,type:"file",accept:".csv",onChange:f,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",disabled:c})]}),u&&(0,s.jsxs)("div",{className:"mb-4",children:[u.success?(0,s.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg",children:[(0,s.jsx)(Q.Z,{className:"w-5 h-5 text-green-600"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-green-800 font-medium",children:"Import Successful"}),(0,s.jsx)("p",{className:"text-green-700 text-sm",children:u.message})]})]}):(0,s.jsxs)("div",{className:"flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-lg",children:[(0,s.jsx)(ee.Z,{className:"w-5 h-5 text-red-600 mt-0.5"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-red-800 font-medium",children:"Import Failed"}),u.errors&&(0,s.jsx)("ul",{className:"text-red-700 text-sm mt-1",children:u.errors.map((e,t)=>(0,s.jsx)("li",{className:"list-disc list-inside",children:e},t))})]})]}),!u.success&&u.data&&Object.keys(u.data).length>0&&(0,s.jsx)("div",{className:"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:(0,s.jsx)("p",{className:"text-yellow-800 text-sm",children:'Some data was successfully parsed. You can still import the valid data by clicking "Import Valid Data".'})})]}),(0,s.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,s.jsx)("button",{onClick:p,className:"px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"}),(null==u?void 0:u.data)&&Object.keys(u.data).length>0&&(0,s.jsxs)("button",{onClick:()=>{(null==u?void 0:u.success)&&u.data&&(i(u.data),x(!1),m(null),q.Am.success("Data imported successfully!"))},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:["Import ",u.success?"All":"Valid"," Data"]})]})]})})]})}function eo(e){let{billingData:t,projections:r,onUpdateProjections:o,closedProjects:l,onClosedProjectsChange:n,useDB:c=!0}=e,d=t||[],[u,m]=(0,a.useState)(null),[h,x]=(0,a.useState)(null),[g,f]=(0,a.useState)(null),[p,j]=(0,a.useState)(""),[b,y]=(0,a.useState)(null),[v,w]=(0,a.useState)(null),N=(0,a.useRef)(null),[k,S]=(0,a.useState)(null),[C,I]=(0,a.useState)(null),P=(0,a.useRef)(null),[E,A]=(0,a.useState)(null),[T,O]=(0,a.useState)(""),[D,F]=(0,a.useState)(null),[R,Z]=(0,a.useState)(l||new Set),[_,M]=(0,a.useState)([]),[U,B]=(0,a.useState)({}),[X,$]=(0,a.useState)(!1),[Q,ee]=(0,a.useState)({field:"projectName",direction:"asc"}),[et,er]=(0,a.useState)(""),es=e=>fetch(e).then(e=>e.json()),eo={revalidateOnFocus:!0,revalidateOnReconnect:!0,refreshInterval:0},{data:el,mutate:en}=(0,L.ZP)("/api/signed-fees",es,eo),{data:ei,mutate:ec}=(0,L.ZP)("/api/asr-fees",es,eo),{data:ed,mutate:eu}=(0,L.ZP)("/api/projections",es,eo),{data:em,mutate:eh}=(0,L.ZP)("/api/statuses",es,eo),{data:ex,mutate:eg}=(0,L.ZP)("/api/comments",es,eo),{data:ef,mutate:ep}=(0,L.ZP)("/api/closed-projects",es,eo),{data:ej,mutate:eb}=(0,L.ZP)("/api/project-assignments",es,eo),{data:ey,mutate:ev}=(0,L.ZP)("/api/project-managers",es,eo),[ew,eN]=(0,a.useState)({}),[ek,eS]=(0,a.useState)({}),[eC,eI]=(0,a.useState)({}),[eP,eE]=(0,a.useState)({}),[eA,eT]=(0,a.useState)({}),eO=(0,a.useRef)(null),eD=(0,a.useRef)(null),eF=(0,a.useRef)(null),eR=(0,a.useRef)(null),eZ=(0,a.useRef)(null),e_=(0,a.useRef)(null),eM=(0,a.useRef)(null),eL=(0,a.useRef)(null),[eU,eB]=(0,a.useState)(0),[ez,eH]=(0,a.useState)(0),[eJ,eK]=(0,a.useState)(!1),[eV,eW]=(0,a.useState)(0),[eY,eG]=(0,a.useState)(0),eq=(0,a.useMemo)(()=>(0,i.ji)(),[]),eX=(0,a.useMemo)(()=>new Date().toISOString().slice(0,7),[]);(0,a.useEffect)(()=>{el&&Object.keys(el).length>0&&eN(el)},[el]),(0,a.useEffect)(()=>{ei&&Object.keys(ei).length>0&&eS(ei)},[ei]),(0,a.useEffect)(()=>{ed&&Object.keys(ed).length>0&&eI(ed)},[ed]),(0,a.useEffect)(()=>{em&&Object.keys(em).length>0&&eE(em)},[em]),(0,a.useEffect)(()=>{ex&&Object.keys(ex).length>0&&eT(ex)},[ex]),(0,a.useEffect)(()=>{if(ef&&Array.isArray(ef)){let e=new Set(ef);Z(e),null==n||n(e)}},[ef,n]),(0,a.useEffect)(()=>{ej&&"object"==typeof ej&&B(ej)},[ej]),(0,a.useEffect)(()=>{ey&&Array.isArray(ey)&&M(ey)},[ey]),(0,a.useEffect)(()=>()=>{},[]),(0,a.useEffect)(()=>{console.log("HighPerformanceTable: projectManagers state changed:",_)},[_]),(0,a.useEffect)(()=>{let e=setInterval(()=>{let e=localStorage.getItem("projectManagers");e&&Array.isArray(JSON.parse(e))&&0===_.length&&(console.log("HighPerformanceTable: Periodic check found project managers but state is empty, reloading"),M(JSON.parse(e)))},5e3);return()=>clearInterval(e)},[_.length]),(0,a.useEffect)(()=>{let e=e=>{if(b&&v){let t=e.target,r=document.querySelector('[data-dropdown="true"]');r&&!r.contains(t)&&(y(null),w(null))}if(k&&C){let t=e.target,r=document.querySelector('[data-dropdown="true"]');r&&!r.contains(t)&&(S(null),I(null))}if(E&&eL.current){let t=e.target;eL.current.contains(t)||(A(null),O(""),F(null))}};return(b||k||E)&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[b,v,k,C,E]),(0,a.useEffect)(()=>{var e,t;let r=()=>{eO.current&&eD.current&&(eD.current.scrollTop=eO.current.scrollTop)},s=()=>{eO.current&&eD.current&&(eO.current.scrollTop=eD.current.scrollTop)};return null===(e=eO.current)||void 0===e||e.addEventListener("scroll",r),null===(t=eD.current)||void 0===t||t.addEventListener("scroll",s),()=>{var e,t;null===(e=eO.current)||void 0===e||e.removeEventListener("scroll",r),null===(t=eD.current)||void 0===t||t.removeEventListener("scroll",s)}},[]),(0,a.useEffect)(()=>{if(!b||!v)return;let e=window.requestAnimationFrame(()=>{let e=N.current;if(!e)return;let{offsetWidth:t,offsetHeight:r}=e,s=window.innerWidth,a=window.innerHeight,o=v.x,l=v.y;o+t+8>s&&(o=Math.max(8,s-t-8)),l+r+8>a&&(l=Math.max(8,l-r)),(Math.abs(o-v.x)>1||Math.abs(l-v.y)>1)&&w({x:o,y:l})});return()=>window.cancelAnimationFrame(e)},[b,v]),(0,a.useEffect)(()=>{if(!k||!C)return;let e=window.requestAnimationFrame(()=>{let e=P.current;if(!e)return;let{offsetWidth:t,offsetHeight:r}=e,s=window.innerWidth,a=window.innerHeight,o=C.x,l=C.y;o+t+8>s&&(o=Math.max(8,s-t-8)),l+r+8>a&&(l=Math.max(8,l-r)),(Math.abs(o-C.x)>1||Math.abs(l-C.y)>1)&&I({x:o,y:l})});return()=>window.cancelAnimationFrame(e)},[k,C]),(0,a.useEffect)(()=>{eO.current&&eO.current.classList.add("hide-scrollbar"),eD.current&&(eD.current.style.overflowX="hidden")},[]),(0,a.useEffect)(()=>{if(eZ.current){let e=eq.indexOf(eX);-1!==e&&(eZ.current.scrollLeft=128*e)}},[eq,eX]),(0,a.useEffect)(()=>{var e;let t=()=>{eZ.current&&$(eZ.current.scrollLeft>0)};return null===(e=eZ.current)||void 0===e||e.addEventListener("scroll",t),()=>{var e;null===(e=eZ.current)||void 0===e||e.removeEventListener("scroll",t)}},[]),(0,a.useEffect)(()=>{e_.current&&eB(e_.current.clientHeight);let e=new ResizeObserver(()=>{e_.current&&eB(e_.current.clientHeight)});return e_.current&&e.observe(e_.current),()=>e.disconnect()},[]),(0,a.useEffect)(()=>{eM.current&&eH(eM.current.clientHeight);let e=new ResizeObserver(()=>{eM.current&&eH(eM.current.clientHeight)});return eM.current&&e.observe(eM.current),()=>e.disconnect()},[]),(0,a.useEffect)(()=>{eW((()=>{let e=document.createElement("div");e.style.overflowY="scroll",e.style.width="50px",e.style.height="50px",e.style.visibility="hidden",document.body.appendChild(e);let t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t})())},[]),(0,a.useEffect)(()=>{eG((()=>{let e=document.createElement("div");e.style.overflowX="scroll",e.style.height="50px",e.style.width="50px",e.style.visibility="hidden",document.body.appendChild(e);let t=e.offsetHeight-e.clientHeight;return document.body.removeChild(e),t})())},[]);let e$=(0,a.useCallback)((e,t)=>{var r;return(null==ed?void 0:null===(r=ed[e])||void 0===r?void 0:r[t])||0},[ed]),eQ=(0,a.useCallback)(e=>(null==ei?void 0:ei[e])||0,[ei]),e0=(0,a.useCallback)(e=>((null==el?void 0:el[e.projectId])||0)+eQ(e.projectId),[el,eQ]),e5=(0,a.useCallback)(e=>eq.reduce((t,r)=>t+e$(e,r),0),[eq,e$]);(0,a.useCallback)(e=>{let t=null==ej?void 0:ej[e];if(!t)return;if(ey&&!Array.isArray(ey)){var r;return null===(r=ey[t])||void 0===r?void 0:r.color}let s=null==ey?void 0:ey.find(e=>e.id===t);return null==s?void 0:s.color},[ej,ey]);let e6=(0,a.useCallback)((e,t)=>{var r;return(null==em?void 0:null===(r=em[e])||void 0===r?void 0:r[t])||""},[em]),e2=(0,a.useCallback)((e,t)=>{var r;return(null==ex?void 0:null===(r=ex[e])||void 0===r?void 0:r[t])||""},[ex]),e1=e=>{switch(e){case"Confirmed":return"bg-blue-50";case"Estimate":return"bg-yellow-50";case"Billed":return"bg-green-50";case"Other":return"bg-purple-50";default:return""}},e8=(0,a.useCallback)((e,t,r)=>{m({projectId:e,month:t}),j(r.toString())},[]),e9=(0,a.useCallback)(async()=>{if(!u)return;let{projectId:e,month:t}=u,r=parseFloat(p)||0;try{await fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,value:r})}),eu(),window.dispatchEvent(new CustomEvent("projectionsUpdated")),m(null),j("")}catch(e){console.error("Error saving projection:",e),q.ZP.error("Failed to save projection")}},[u,p,eu]),e7=(0,a.useCallback)(async()=>{if(!h)return;let e=parseFloat(p)||0;try{await fetch("/api/asr-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:h,value:e})}),eS(t=>({...t,[h]:e})),ec(),x(null),j("")}catch(e){console.error("Error saving ASR fee:",e),q.ZP.error("Failed to save ASR fee")}},[h,p,ec]),e4=(0,a.useCallback)(async()=>{if(!g)return;let e=parseFloat(p)||0;try{await fetch("/api/signed-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:g,value:e})}),eN(t=>({...t,[g]:e})),en(),f(null),j("")}catch(e){console.error("Error saving signed fee:",e),q.ZP.error("Failed to save signed fee")}},[g,p,en]),e3=(0,a.useCallback)(async e=>{try{await fetch("/api/closed-projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})});let t=new Set(R);t.add(e),Z(t),null==n||n(t),ep(),y(null),q.ZP.success("Project closed")}catch(e){console.error("Error closing project:",e),q.ZP.error("Failed to close project")}},[R,n,ep]);(0,a.useCallback)(async e=>{try{await fetch("/api/closed-projects",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})});let t=new Set(R);t.delete(e),Z(t),null==n||n(t),ep(),q.ZP.success("Project reopened")}catch(e){console.error("Error reopening project:",e),q.ZP.error("Failed to reopen project")}},[R,n,ep]);let te=async e=>{if(!k)return;let{projectId:t,month:r}=k;try{"Clear"===e?await fetch("/api/statuses",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:r})}):await fetch("/api/statuses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:r,status:e})}),eh(),window.dispatchEvent(new CustomEvent("projectionsUpdated")),S(null),I(null)}catch(e){console.error("Error updating status:",e),q.ZP.error("Failed to update status")}},tt=async e=>{if(!k)return;let{projectId:t,month:r}=k;if("AddComment"===e||"EditComment"===e){A(k),O(e2(t,r)),F(C),S(null),I(null);return}if("RemoveComment"===e){try{await fetch("/api/comments",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:r})}),eg(),S(null),I(null)}catch(e){console.error("Error removing comment:",e),q.ZP.error("Failed to remove comment")}return}await te(e)},tr=(0,a.useCallback)(e=>[...e].sort((e,t)=>{let r,s;switch(Q.field){case"projectName":r=e.projectName.toLowerCase(),s=t.projectName.toLowerCase();break;case"signedFee":r=ew[e.projectId]||e.signedFee||0,s=ew[t.projectId]||t.signedFee||0;break;case"asrFee":r=eQ(e.projectId),s=eQ(t.projectId);break;case"totalFee":r=e0(e),s=e0(t);break;case"projected":r=e5(e.projectId),s=e5(t.projectId);break;default:if(!eq.includes(Q.field))return 0;r=e$(e.projectId,Q.field),s=e$(t.projectId,Q.field)}return r<s?"asc"===Q.direction?-1:1:r>s?"asc"===Q.direction?1:-1:0}),[Q,ew,eQ,e0,e5,eq,e$]),ts=(0,a.useCallback)(e=>{ee(t=>({field:e,direction:t.field===e&&"asc"===t.direction?"desc":"asc"}))},[]),ta=e=>Q.field!==e?null:"asc"===Q.direction?(0,s.jsx)(J.Z,{className:"h-4 w-4"}):(0,s.jsx)(K.Z,{className:"h-4 w-4"}),to=e=>Q.field!==e?null:"asc"===Q.direction?(0,s.jsx)(J.Z,{className:"h-3 w-3"}):(0,s.jsx)(K.Z,{className:"h-3 w-3"}),tl=(0,a.useMemo)(()=>ef&&Array.isArray(ef)?new Set(ef):new Set,[ef]),tn=tr(d.filter(e=>!tl.has(e.projectId))),ti=(0,a.useMemo)(()=>et.trim()?tn.filter(e=>e.projectName.toLowerCase().includes(et.toLowerCase())):tn,[tn,et]);console.log("HighPerformanceTable: safeBillingData length:",d.length),console.log("HighPerformanceTable: activeProjects length:",tn.length),console.log("HighPerformanceTable: filteredProjects length:",ti.length),console.log("HighPerformanceTable: closedProjects size:",R.size),d.length>0&&console.log("HighPerformanceTable: First billing data item:",d[0]),(0,a.useEffect)(()=>{let e=()=>{if(e_.current){let e=e_.current.scrollHeight>e_.current.clientHeight;eK(e);let t=eV||15,r=e?"".concat(t,"px"):"0";eF.current&&eF.current.firstChild&&(eF.current.firstChild.style.paddingRight=r),eR.current&&eR.current.firstChild&&(eR.current.firstChild.style.paddingRight=r)}};e();let t=new ResizeObserver(e);e_.current&&t.observe(e_.current);let r=setInterval(e,500);return()=>{t.disconnect(),clearInterval(r)}},[tn.length,eV]);let tc=async e=>{try{let t=[];Object.keys(e).forEach(r=>{Object.keys(e[r]).forEach(s=>{let a=e[r][s];0!==a&&t.push(fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:r,month:s,value:a})}))})}),t.length>0&&(await Promise.all(t),eu(),q.ZP.success("Data imported successfully")),o&&o(e)}catch(e){console.error("Error importing data:",e),q.ZP.error("Failed to import data")}};return(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 bg-white rounded-lg shadow overflow-hidden",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 px-6 py-4 border-b border-gray-200",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex items-center justify-between mb-4",children:(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750",children:[(0,s.jsx)("h3",{className:"jsx-19280ab6560fe750 text-lg font-medium text-gray-900",children:"Projections Table"}),(0,s.jsxs)("p",{className:"jsx-19280ab6560fe750 text-sm text-gray-600",children:["Virtualized table with ",ti.length," active projects - click any cell to edit"]})]})}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 mb-4",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 relative",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,s.jsx)(V.Z,{className:"h-4 w-4 text-gray-400"})}),(0,s.jsx)("input",{type:"text",placeholder:"Filter projects by name...",value:et,onChange:e=>er(e.target.value),className:"jsx-19280ab6560fe750 block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),et&&(0,s.jsx)("button",{onClick:()=>er(""),className:"jsx-19280ab6560fe750 absolute inset-y-0 right-0 pr-3 flex items-center",children:(0,s.jsx)(W.Z,{className:"h-4 w-4 text-gray-400 hover:text-gray-600"})})]}),et&&(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 mt-2 text-sm text-gray-600",children:["Showing ",ti.length," of ",tn.length," projects"]})]}),(0,s.jsx)(ea,{billingData:d,monthlyProjections:eC,asrFees:ek,signedFees:ew,monthRange:eq,onImportData:tc})]}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 relative table-container",children:[(0,s.jsxs)("div",{style:{width:"776px",height:"600px"},className:"jsx-19280ab6560fe750 absolute left-0 top-0 z-30 bg-white flex flex-col",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-b border-gray-200 sticky-header",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-[264px] bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("projectName"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-start cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Project"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("projectName")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("signedFee"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Signed Fee"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("signedFee")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("asrFee"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Total ASR Fee"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("asrFee")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("totalFee"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Total Fee"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("totalFee")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("projected"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Projected"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("projected")})]})})]}),(0,s.jsx)("div",{ref:eM,style:{overflowY:"auto",overflowX:"hidden"},className:"jsx-19280ab6560fe750 flex-1 hide-scrollbar",children:(0,s.jsx)(H.t7,{height:ez,itemCount:ti.length,itemSize:72,width:776,outerRef:eO,overscanCount:5,children:e=>{let{index:t,style:r}=e,a=ti[t];if(!a)return null;let o=e5(a.projectId),l=e0(a),n=eQ(a.projectId),c=h===a.projectId,d=(null==ej?void 0:ej[a.projectId])||U[a.projectId],u=(null==ey?void 0:ey[d])||_.find(e=>e.id===d);return(0,s.jsxs)("div",{style:r,className:"jsx-19280ab6560fe750 flex border-b border-gray-200 sticky-column",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-[264px] bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex items-center h-18 px-4",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex-1 min-w-0 flex flex-col justify-center overflow-hidden",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex items-center",children:[u&&(0,s.jsx)("div",{style:{backgroundColor:u.color},className:"jsx-19280ab6560fe750 w-3 h-3 rounded-full mr-2"}),(0,s.jsx)("span",{title:a.projectName,className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-900 truncate",children:a.projectName})]}),u&&(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs text-gray-500 italic truncate",children:u.name})]}),(0,s.jsx)("button",{onClick:e=>{y(a.projectId),w({x:e.clientX,y:e.clientY})},className:"jsx-19280ab6560fe750 ml-2 p-1 text-gray-400 hover:text-gray-600",children:(0,s.jsx)(Y.Z,{className:"h-4 w-4"})})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center",children:g===a.projectId?(0,s.jsx)("input",{type:"number",value:p,onChange:e=>j(e.target.value),onBlur:e4,onKeyDown:e=>"Enter"===e.key&&e4(),autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-blue-300 rounded text-sm"}):(()=>{let e=ew[a.projectId],t=null==el?void 0:el[a.projectId],r=void 0!==e?e:void 0!==t?t:0;return(0,s.jsx)("div",{onClick:()=>{f(a.projectId),j(r.toString())},className:"jsx-19280ab6560fe750 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded",children:(0,i.xG)(r)})})()})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center",children:c?(0,s.jsx)("input",{type:"number",value:p,onChange:e=>j(e.target.value),onBlur:e7,onKeyDown:e=>"Enter"===e.key&&e7(),autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-blue-300 rounded text-sm"}):(0,s.jsx)("div",{onClick:()=>{x(a.projectId),j(n.toString())},className:"jsx-19280ab6560fe750 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded",children:(0,i.xG)(n)})})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium",children:(0,i.xG)(l)})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium",children:(0,i.xG)(o)})})]})}})}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-t border-gray-200",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-[264px] bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-left text-sm font-medium text-gray-900",children:"Totals"})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>{let r=ew[t.projectId],s=null==el?void 0:el[t.projectId];return e+(void 0!==r?r:void 0!==s?s:0)},0))})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>e+eQ(t.projectId),0))})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>e+e0(t),0))})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>e+e5(t.projectId),0))})})]}),(0,s.jsx)("div",{style:{height:"".concat(eY,"px")},className:"jsx-19280ab6560fe750"})]}),(0,s.jsx)("div",{ref:eZ,style:{height:"600px",marginLeft:"776px"},className:"jsx-19280ab6560fe750 "+"overflow-x-auto overflow-y-hidden scrollable-outer ".concat(X?"scrolled-horizontal":""),children:(0,s.jsxs)("div",{style:{width:"".concat(128*eq.length,"px"),height:"100%",display:"flex",flexDirection:"column"},className:"jsx-19280ab6560fe750",children:[(0,s.jsx)("div",{ref:eF,className:"jsx-19280ab6560fe750 scrollable-header",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-b border-gray-200 sticky-header header-flex",children:eq.map(e=>(0,s.jsx)("div",{onClick:()=>ts(e),title:"Click to sort by ".concat((0,i.bh)(e)," projections"),className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 flex items-center justify-center px-4 py-3 border-r border-gray-200 h-18 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors group",children:(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex flex-col items-center group-hover:text-gray-700",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:(0,i.bh)(e)}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 text-gray-400 mt-0.5 group-hover:text-gray-600",children:to(e)})]})},e))})}),(0,s.jsx)("div",{ref:e_,style:{overflowY:"auto",overflowX:"hidden"},className:"jsx-19280ab6560fe750 flex-1 body-wrapper",children:(0,s.jsx)(H.t7,{height:eU,itemCount:ti.length,itemSize:72,width:128*eq.length,outerRef:eD,overscanCount:5,children:e=>{let{index:t,style:r}=e,a=ti[t];return a?(0,s.jsx)("div",{style:r,className:"jsx-19280ab6560fe750 flex border-b border-gray-200",children:eq.map(e=>{let t=e$(a.projectId,e),r=(null==u?void 0:u.projectId)===a.projectId&&(null==u?void 0:u.month)===e;return(0,s.jsxs)("div",{onClick:()=>e8(a.projectId,e,t),title:e2(a.projectId,e),className:"jsx-19280ab6560fe750 "+"flex-shrink-0 w-32 h-18 px-4 py-2 text-center text-sm border-r border-gray-200 cursor-pointer relative ".concat(e1(e6(a.projectId,e))||"bg-white"),children:[r?(0,s.jsx)("input",{type:"number",value:p,onChange:e=>j(e.target.value),onBlur:e9,onKeyDown:e=>"Enter"===e.key&&e9(),autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-blue-300 rounded text-sm"}):(0,i.xG)(t),(0,s.jsx)("button",{onClick:t=>{t.stopPropagation(),S({projectId:a.projectId,month:e}),I({x:t.clientX,y:t.clientY})},className:"jsx-19280ab6560fe750 absolute top-1 right-1 text-gray-400 hover:text-gray-600 text-xs",children:""})]},e)})}):null}})}),(0,s.jsx)("div",{ref:eR,className:"jsx-19280ab6560fe750 scrollable-footer",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-t border-gray-200 footer-flex",children:eq.map((e,t)=>{let r=eq.map(e=>d.reduce((t,r)=>t+e$(r.projectId,e),0));return(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900 border-r border-gray-200 bg-gray-50",children:(0,i.xG)(r[t])},e)})})})]})})]}),b&&v&&(0,s.jsxs)("div",{ref:N,"data-dropdown":"true",style:{left:"".concat(v.x,"px"),top:"".concat(v.y,"px"),pointerEvents:"auto"},className:"jsx-19280ab6560fe750 fixed bg-white border border-gray-200 rounded-lg shadow-xl z-[9999] min-w-[220px] py-2",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 py-1",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 pb-1 text-[11px] font-medium text-gray-500 uppercase tracking-wider",children:"Assign Project Manager"}),ey&&0!==Object.keys(ey).length||0!==_.length?(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 space-y-0.5",children:(()=>{let e=(null==ej?void 0:ej[b])||U[b];return ey&&Object.keys(ey).length>0?Object.entries(ey).map(t=>{let[r,a]=t;return(0,s.jsxs)("button",{onClick:async()=>{try{await fetch("/api/project-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:b,managerId:r})}),eb(),y(null)}catch(e){console.error("Error assigning project manager:",e),q.ZP.error("Failed to assign project manager")}},className:"jsx-19280ab6560fe750 "+"w-full px-3 py-2 text-left text-sm flex items-center justify-between hover:bg-gray-50 ".concat(e===r?"bg-gray-50":""),children:[(0,s.jsxs)("span",{className:"jsx-19280ab6560fe750 flex items-center space-x-2",children:[(0,s.jsx)("span",{style:{backgroundColor:a.color},className:"jsx-19280ab6560fe750 w-3 h-3 rounded-full inline-block"}),(0,s.jsx)("span",{className:"jsx-19280ab6560fe750",children:a.name})]}),e===r&&(0,s.jsx)(G.Z,{className:"h-4 w-4 text-green-600"})]},r)}):_.map(t=>(0,s.jsxs)("button",{onClick:()=>{let e={...U,[b]:t.id};B(e),localStorage.setItem("projectAssignments",JSON.stringify(e)),y(null)},className:"jsx-19280ab6560fe750 "+"w-full px-3 py-2 text-left text-sm flex items-center justify-between hover:bg-gray-50 ".concat(e===t.id?"bg-gray-50":""),children:[(0,s.jsxs)("span",{className:"jsx-19280ab6560fe750 flex items-center space-x-2",children:[(0,s.jsx)("span",{style:{backgroundColor:t.color},className:"jsx-19280ab6560fe750 w-3 h-3 rounded-full inline-block"}),(0,s.jsx)("span",{className:"jsx-19280ab6560fe750",children:t.name})]}),e===t.id&&(0,s.jsx)(G.Z,{className:"h-4 w-4 text-green-600"})]},t.id))})()}):(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 py-2 text-xs text-gray-400 italic",children:"No project managers available"})]}),((null==ej?void 0:ej[b])||U[b])&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 my-1 border-t border-gray-200"}),(0,s.jsxs)("button",{onClick:async()=>{try{await fetch("/api/project-assignments",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:b})}),eb(),y(null)}catch(e){console.error("Error removing project manager:",e),q.ZP.error("Failed to remove project manager")}},className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm text-orange-600 hover:bg-orange-50 flex items-center",children:[(0,s.jsx)(Y.Z,{className:"h-4 w-4 mr-2"}),"Remove Manager"]})]}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 my-1 border-t border-gray-200"}),(0,s.jsxs)("button",{onClick:()=>e3(b),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center",children:[(0,s.jsx)(W.Z,{className:"h-4 w-4 mr-2"}),"Close Project"]})]}),k&&C&&(0,s.jsxs)("div",{ref:P,"data-dropdown":"true",style:{left:"".concat(C.x,"px"),top:"".concat(C.y,"px"),pointerEvents:"auto"},className:"jsx-19280ab6560fe750 fixed bg-white border border-gray-200 rounded-lg shadow-xl z-[9999] min-w-[200px] py-2 backdrop-blur-sm",children:[(()=>{let e=e6(k.projectId,k.month);return(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 py-1",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 pb-1 text-[11px] font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),["Confirmed","Estimate","Billed","Other"].map(t=>(0,s.jsxs)("button",{onClick:()=>tt(t),className:"jsx-19280ab6560fe750 "+"w-full px-3 py-2 text-left text-sm flex items-center justify-between hover:bg-gray-50 ".concat(e===t?"bg-gray-50":""),children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750",children:t}),e===t&&(0,s.jsx)(G.Z,{className:"h-4 w-4 text-green-600"})]},t)),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 my-1 border-t border-gray-200"}),(0,s.jsx)("button",{onClick:()=>tt("Clear"),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50",children:"Clear"})]})})(),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 py-1",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 pb-1 text-[11px] font-medium text-gray-500 uppercase tracking-wider",children:"Comment"}),(0,s.jsx)("button",{onClick:()=>tt(e2(k.projectId,k.month)?"EditComment":"AddComment"),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm hover:bg-gray-50",children:e2(k.projectId,k.month)?"Edit Comment":"Add Comment"}),e2(k.projectId,k.month)&&(0,s.jsx)("button",{onClick:()=>tt("RemoveComment"),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm hover:bg-gray-50",children:"Remove Comment"})]})]}),E&&D&&(0,s.jsxs)("div",{ref:eL,style:{left:"".concat(D.x,"px"),top:"".concat(D.y,"px"),pointerEvents:"auto"},className:"jsx-19280ab6560fe750 fixed bg-white border border-gray-200 rounded-md shadow-lg z-[9999] min-w-[300px] max-w-md comment-modal",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 px-4 py-3 border-b border-gray-200 flex justify-between items-center",children:[(0,s.jsx)("h3",{className:"jsx-19280ab6560fe750 text-lg font-medium text-gray-900",children:"Edit Comment"}),(0,s.jsx)("button",{onClick:()=>{A(null),O(""),F(null)},className:"jsx-19280ab6560fe750 text-gray-400 hover:text-gray-600",children:(0,s.jsx)(W.Z,{className:"h-5 w-5"})})]}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 p-4",children:(0,s.jsx)("textarea",{value:T,onChange:e=>O(e.target.value),rows:4,autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-gray-300 rounded text-sm"})}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 px-4 py-3 border-t border-gray-200 flex justify-end",children:[(0,s.jsx)("button",{onClick:async()=>{let{projectId:e,month:t}=E,r=T.trim();try{r?await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,comment:r})}):await fetch("/api/comments",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t})}),eg(),A(null),O(""),F(null)}catch(e){console.error("Error saving comment:",e),q.ZP.error("Failed to save comment")}},className:"jsx-19280ab6560fe750 px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-md",children:"Save Comment"}),(0,s.jsx)("button",{onClick:()=>{A(null),O(""),F(null)},className:"jsx-19280ab6560fe750 ml-2 px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md",children:"Cancel"})]})]}),(0,s.jsx)(z(),{id:"19280ab6560fe750",children:".table-container.jsx-19280ab6560fe750{position:relative;overflow:hidden}.sticky-header.jsx-19280ab6560fe750{position:-webkit-sticky;position:sticky;top:0;z-index:40;background:inherit;overflow:hidden}.sticky-column.jsx-19280ab6560fe750{position:-webkit-sticky;position:sticky;left:0;z-index:30;background:white;overflow:hidden}.scrolled-horizontal.jsx-19280ab6560fe750{-webkit-box-shadow:inset -10px 0 8px -8px rgba(0,0,0,.1);-moz-box-shadow:inset -10px 0 8px -8px rgba(0,0,0,.1);box-shadow:inset -10px 0 8px -8px rgba(0,0,0,.1)}.hide-scrollbar.jsx-19280ab6560fe750::-webkit-scrollbar{display:none}.hide-scrollbar.jsx-19280ab6560fe750{-ms-overflow-style:none;scrollbar-width:none}.hide-horizontal-scrollbar.jsx-19280ab6560fe750{overflow-x:hidden!important}.body-wrapper.jsx-19280ab6560fe750{scrollbar-gutter:stable}.scrollable-header.jsx-19280ab6560fe750,.scrollable-footer.jsx-19280ab6560fe750{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}.header-flex.jsx-19280ab6560fe750,.footer-flex.jsx-19280ab6560fe750{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}.scrollable-outer.jsx-19280ab6560fe750{scrollbar-gutter:stable}"})]})}function el(){let{user:e,loading:t}=(0,l.a)(),{isMigrating:r,isMigrated:d,hasLocalData:u,migrateData:m}=(0,n.c)(),x=(0,o.useRouter)(),[g,f]=(0,a.useState)([]),[p,j]=(0,a.useState)([]),[b,v]=(0,a.useState)([]),[w,N]=(0,a.useState)(!1),[k,C]=(0,a.useState)(null),[I,P]=(0,a.useState)({}),[E,T]=(0,a.useState)(null),[O,D]=(0,a.useState)(new Set),[F,R]=(0,a.useState)([]),[Z,_]=(0,a.useState)(!1),[M,L]=(0,a.useState)({configured:!1}),[B,z]=(0,a.useState)({}),[H,J]=(0,a.useState)({}),[K,V]=(0,a.useState)(null);(0,a.useEffect)(()=>{if(!t&&!e){x.push("/login");return}if(!t&&e&&!e.isBasic){x.push("/unauthorized");return}},[e,t,x]),(0,a.useEffect)(()=>{!u||d||r||(console.log("Dashboard: Found localStorage data, starting migration"),m())},[u,d,r,m]),(0,a.useEffect)(()=>{console.log("Dashboard: useEffect triggered - user:",!!e,"isBasic:",null==e?void 0:e.isBasic,"loading:",t),e&&e.isBasic?(console.log("Dashboard: User authenticated and authorized, fetching data"),G()):console.log("Dashboard: User not authenticated or not authorized:",{user:!!e,isBasic:null==e?void 0:e.isBasic,loading:t})},[e]),(0,a.useEffect)(()=>{let e=()=>{T(c.VC.getAutoRefreshStatus())};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[]),(0,a.useEffect)(()=>{let t=async()=>{try{let[e,t]=await Promise.all([fetch("/api/projections"),fetch("/api/statuses")]);if(e.ok){let t=await e.json();z(t)}if(t.ok){let e=await t.json();J(e)}}catch(e){console.error("Error fetching database data:",e)}};e&&e.isBasic&&t()},[e]),(0,a.useEffect)(()=>{if(g.length>0||p.length>0){console.log("Dashboard: Processing data - projects:",g.length,"invoices:",p.length),console.log("Dashboard: User state:",{user:!!e,isBasic:null==e?void 0:e.isBasic,loading:t});let r=(0,i.K0)(g);P(r);let s=(0,i.ab)(g,p,r);console.log("Dashboard: Processed billing data:",s.length),console.log("Dashboard: First processed item:",s[0]),console.log("Dashboard: Projections initialized:",Object.keys(r).length),v(s)}else console.log("Dashboard: No projects or invoices to process"),console.log("Dashboard: Projects length:",g.length),console.log("Dashboard: Invoices length:",p.length)},[g,p,e,t]),(0,a.useEffect)(()=>{b.length>0&&V((0,i.fc)(b,O,B,H))},[b,O,B,H]),(0,a.useEffect)(()=>{b.length>0&&F.length>0&&(console.log("Dashboard: Enhancing billing data with Clockify data"),v((0,i.sJ)(b,F)),_(!0))},[b,F]),(0,a.useEffect)(()=>{W()},[]);let W=async()=>{try{console.log("Dashboard: Testing Clockify connection...");let e=await fetch("/api/clockify?action=test-connection"),t=await e.json();t.success?(console.log("Dashboard: Clockify connection successful"),L({configured:!0,workspaces:t.workspaces}),await Y()):(console.log("Dashboard: Clockify connection failed:",t.error),L({configured:!1,error:t.error}))}catch(e){console.error("Dashboard: Error testing Clockify connection:",e),L({configured:!1,error:"Failed to connect to Clockify"})}},Y=async()=>{try{console.log("Dashboard: Fetching Clockify data...");let e=new Date;e.setMonth(e.getMonth()-12);let t=new Date,r=await h(e.toISOString().split("T")[0],t.toISOString().split("T")[0]);R(r),console.log("Dashboard: Clockify data fetched:",r.length)}catch(e){console.error("Dashboard: Error fetching Clockify data:",e),R([])}},G=async()=>{console.log("Dashboard: Starting fetchData"),console.log("Dashboard: User state during fetch:",{user:!!e,isBasic:null==e?void 0:e.isBasic,loading:t}),N(!0);try{let[e,t]=await Promise.all([(0,c.bl)(),(0,c.WM)()]);console.log("Dashboard: API responses - projects:",null==e?void 0:e.length,"invoices:",null==t?void 0:t.length),f(e||[]),j(t||[]),C({fromCache:!1,changes:null})}catch(e){console.error("Error fetching data:",e),f([]),j([])}finally{N(!1)}};return r?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Migrating data to database..."}),(0,s.jsx)("p",{className:"mt-2 text-sm text-gray-500",children:"This may take a few moments"})]})}):t?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Checking authentication..."})]})}):e&&e.isBasic?w?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading data..."})]})}):(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,s.jsx)(y,{cacheInfo:k,autoRefreshStatus:E}),(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[M.configured&&(0,s.jsx)("div",{className:"mb-6 bg-green-50 border border-green-200 rounded-md p-4",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:(0,s.jsx)("div",{className:"w-2 h-2 bg-green-400 rounded-full"})}),(0,s.jsxs)("div",{className:"ml-3",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-green-800",children:"Clockify Integration Active"}),(0,s.jsx)("p",{className:"text-xs text-green-600",children:"Time tracking data will be included in dashboard metrics"})]})]})}),Z&&K?(0,s.jsx)(A,{stats:K}):(0,s.jsx)(S,{billingData:b,closedProjects:O,stats:K}),(0,s.jsx)("div",{className:"mt-8",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Billing Overview"}),(0,s.jsx)(U,{billingData:b,closedProjects:O})]})}),(0,s.jsx)("div",{className:"mt-8",children:(0,s.jsx)(eo,{billingData:b,projections:I,onUpdateProjections:e=>{P(e)},closedProjects:O,onClosedProjectsChange:D,useDB:!0})})]})]}):null}},90483:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return f},a:function(){return p}});var s=r(57437),a=r(2265),o=r(96244),l=r(40257);let n="72ed6933-6bc6-430e-a75a-cb5d2e1c20e1",i="e4748cdc-321b-4db0-bc36-141b121a9117";n&&i||(console.warn("Azure AD environment variables are not set. Authentication will not work."),console.warn("Please set NEXT_PUBLIC_AZURE_AD_CLIENT_ID and NEXT_PUBLIC_AZURE_AD_TENANT_ID in your .env.local file"));let c={auth:{clientId:n||"dummy-client-id",authority:"https://login.microsoftonline.com/".concat(i||"dummy-tenant-id"),redirectUri:window.location.origin},cache:{cacheLocation:"sessionStorage",storeAuthStateInCookie:!1}},d=new o.Lx(c),u={scopes:["User.Read","Directory.Read.All"]};async function m(){try{if(!n||!i)throw Error("Azure AD environment variables are not configured. Please set NEXT_PUBLIC_AZURE_AD_CLIENT_ID and NEXT_PUBLIC_AZURE_AD_TENANT_ID in your .env.local file");return await d.loginRedirect(u),null}catch(e){throw console.error("Sign in error:",e),e}}async function h(){try{await d.logoutPopup()}catch(e){console.error("Sign out error:",e)}}async function x(){try{var e,t,r,s,a;let o=d.getActiveAccount();if(!o)return null;let n=await d.acquireTokenSilent({scopes:["User.Read","Directory.Read.All"]}),i=await fetch("https://graph.microsoft.com/v1.0/me",{headers:{Authorization:"Bearer ".concat(n.accessToken)}});if(!i.ok)throw Error("Failed to fetch user details");let c=await i.json(),u=(null===(e=l.env.NEXT_PUBLIC_ADMIN_EMAILS)||void 0===e?void 0:e.split(","))||[],m=u.includes(c.mail)||u.includes(c.userPrincipalName)||(null===(t=c.mail)||void 0===t?void 0:t.endsWith("@collectif.nyc"))||(null===(r=c.mail)||void 0===r?void 0:r.endsWith("@yourcompany.com"));return console.log("Auth Debug:",{userEmail:c.mail,userPrincipalName:c.userPrincipalName,adminEmails:u,isAdmin:m,adminEmailsIncludes:u.includes(c.mail),adminEmailsIncludesPrincipal:u.includes(c.userPrincipalName),endsWithCollectif:null===(s=c.mail)||void 0===s?void 0:s.endsWith("@collectif.nyc"),endsWithLegacy:null===(a=c.mail)||void 0===a?void 0:a.endsWith("@yourcompany.com"),envVar:l.env.NEXT_PUBLIC_ADMIN_EMAILS}),{id:o.localAccountId,name:o.name||"",email:o.username||"",isAdmin:m,isBasic:!0}}catch(t){console.error("Get auth user error:",t);let e=d.getActiveAccount();return console.log("Auth Fallback Debug:",{accountEmail:null==e?void 0:e.username,accountName:null==e?void 0:e.name,isAdmin:!1}),{id:(null==e?void 0:e.localAccountId)||"",name:(null==e?void 0:e.name)||"",email:(null==e?void 0:e.username)||"",isAdmin:!1,isBasic:!0}}}let g=(0,a.createContext)(void 0);function f(e){let{children:t}=e,[r,o]=(0,a.useState)(null),[l,n]=(0,a.useState)(!0);(0,a.useEffect)(()=>{(async()=>{try{await d.initialize();let e=await d.handleRedirectPromise();e&&(console.log("Redirect response received:",e),d.setActiveAccount(e.account));let t=await x();o(t)}catch(e){console.error("Auth initialization error:",e)}finally{n(!1)}})()},[]);let i=async()=>{try{n(!0),await m()}catch(e){console.error("Sign in error:",e),n(!1)}},c=async()=>{try{n(!0),await h(),o(null)}catch(e){console.error("Sign out error:",e)}finally{n(!1)}};return(0,s.jsx)(g.Provider,{value:{user:r,loading:l,signIn:i,signOut:c},children:t})}function p(){let e=(0,a.useContext)(g);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},58091:function(e,t,r){"use strict";r.d(t,{MigrationProvider:function(){return n},c:function(){return i}});var s=r(57437),a=r(2265),o=r(69064);let l=(0,a.createContext)(void 0);function n(e){let{children:t}=e,[r,n]=(0,a.useState)(!1),[i,c]=(0,a.useState)(!1),[d,u]=(0,a.useState)(!1);(0,a.useEffect)(()=>{(()=>{try{if("true"===localStorage.getItem("dataMigrated")||"true"===localStorage.getItem("db_migrated")){c(!0),u(!1);return}let e=localStorage.getItem("monthlyProjections")||localStorage.getItem("signedFees")||localStorage.getItem("asrFees")||localStorage.getItem("monthlyStatuses")||localStorage.getItem("monthlyComments")||localStorage.getItem("closedProjects")||localStorage.getItem("projectAssignments")||localStorage.getItem("projectManagers");u(!!e)}catch(e){console.error("Error checking migration status:",e)}})()},[]);let m=async()=>{if(!r&&!i){n(!0);try{console.log("Starting client-side migration...");let e=JSON.parse(localStorage.getItem("monthlyProjections")||"{}"),t=JSON.parse(localStorage.getItem("monthlyStatuses")||"{}"),r=JSON.parse(localStorage.getItem("monthlyComments")||"{}"),s=JSON.parse(localStorage.getItem("signedFees")||"{}"),a=JSON.parse(localStorage.getItem("asrFees")||"{}"),l=JSON.parse(localStorage.getItem("closedProjects")||"[]"),n=JSON.parse(localStorage.getItem("projectAssignments")||"{}"),i=JSON.parse(localStorage.getItem("projectManagers")||"[]"),d=[];if(Object.keys(e).length>0)for(let[t,r]of Object.entries(e))for(let[e,s]of Object.entries(r))d.push(fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:e,value:s})}));if(Object.keys(t).length>0)for(let[e,r]of Object.entries(t))for(let[t,s]of Object.entries(r))d.push(fetch("/api/statuses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,status:s})}));if(Object.keys(r).length>0)for(let[e,t]of Object.entries(r))for(let[r,s]of Object.entries(t))d.push(fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:r,comment:s})}));if(Object.keys(s).length>0)for(let[e,t]of Object.entries(s))d.push(fetch("/api/signed-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,value:t})}));if(Object.keys(a).length>0)for(let[e,t]of Object.entries(a))d.push(fetch("/api/asr-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,value:t})}));if(l.length>0)for(let e of l)d.push(fetch("/api/closed-projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})}));if(Object.keys(n).length>0)for(let[e,t]of Object.entries(n))d.push(fetch("/api/project-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,managerId:t})}));if(i.length>0)for(let e of i)d.push(fetch("/api/project-managers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}));if(d.length>0){let e=(await Promise.allSettled(d)).filter(e=>"rejected"===e.status);if(e.length>0)throw console.error("Some migrations failed:",e),e.some(e=>{var t,r,s,a,o,l;return"rejected"===e.status&&((null===(r=e.reason)||void 0===r?void 0:null===(t=r.message)||void 0===t?void 0:t.includes("Failed to fetch"))||(null===(a=e.reason)||void 0===a?void 0:null===(s=a.message)||void 0===s?void 0:s.includes("connection"))||(null===(l=e.reason)||void 0===l?void 0:null===(o=l.message)||void 0===o?void 0:o.includes("timeout")))})?o.ZP.error("Migration failed: Check database connections. Retrying in 5 seconds...",{duration:5e3}):o.ZP.error("Migration failed: Some data could not be migrated. Retrying in 5 seconds...",{duration:5e3}),Error("Migration failed");console.log("Migration completed successfully"),o.ZP.success("Migration complete")}localStorage.removeItem("monthlyProjections"),localStorage.removeItem("monthlyStatuses"),localStorage.removeItem("monthlyComments"),localStorage.removeItem("signedFees"),localStorage.removeItem("asrFees"),localStorage.removeItem("closedProjects"),localStorage.removeItem("projectAssignments"),localStorage.removeItem("projectManagers"),localStorage.setItem("dataMigrated","true"),localStorage.setItem("db_migrated","true"),c(!0),u(!1)}catch(e){console.error("Migration failed:",e),localStorage.setItem("db_migrated","true"),c(!0),setTimeout(()=>{i||h()},5e3)}finally{n(!1)}}},h=async()=>{c(!1),localStorage.removeItem("db_migrated"),localStorage.removeItem("dataMigrated"),await m()};return(0,s.jsx)(l.Provider,{value:{isMigrating:r,isMigrated:i,hasLocalData:d,migrateData:m,retryMigration:h},children:t})}function i(){let e=(0,a.useContext)(l);if(void 0===e)throw Error("useMigration must be used within a MigrationProvider");return e}}},function(e){e.O(0,[649,648,64,82,354,339,844,837,971,117,744],function(){return e(e.s=78929)}),_N_E=e.O()}]);