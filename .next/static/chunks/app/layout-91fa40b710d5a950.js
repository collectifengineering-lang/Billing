(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{75545:function(e,t,o){Promise.resolve().then(o.bind(o,90483)),Promise.resolve().then(o.bind(o,58091)),Promise.resolve().then(o.t.bind(o,23824,23)),Promise.resolve().then(o.t.bind(o,47960,23)),Promise.resolve().then(o.bind(o,69064))},90483:function(e,t,o){"use strict";o.d(t,{AuthProvider:function(){return S},a:function(){return y}});var a=o(57437),r=o(2265),n=o(96244);let i="72ed6933-6bc6-430e-a75a-cb5d2e1c20e1",c="e4748cdc-321b-4db0-bc36-141b121a9117";i&&c||(console.warn("Azure AD environment variables are not set. Authentication will not work."),console.warn("Please set NEXT_PUBLIC_AZURE_AD_CLIENT_ID and NEXT_PUBLIC_AZURE_AD_TENANT_ID in your .env.local file"));let l={auth:{clientId:i||"dummy-client-id",authority:"https://login.microsoftonline.com/".concat(c||"dummy-tenant-id"),redirectUri:window.location.origin},cache:{cacheLocation:"sessionStorage",storeAuthStateInCookie:!1}},s=new n.Lx(l),d={scopes:["User.Read","Directory.Read.All"]};function u(e){if(!e)return console.warn("checkAdminStatus: No user email provided"),!1;console.log("checkAdminStatus: Checking admin status for:",e);try{var t;let o=((t="jonathan@collectif.nyc,Rafael@collectif.nyc",void 0===t)?void 0:t.split(",").map(e=>e.trim()))||[];if(console.log("checkAdminStatus: Admin emails from env:",o),console.log("checkAdminStatus: Raw NEXT_PUBLIC_ADMIN_EMAILS value:","jonathan@collectif.nyc,Rafael@collectif.nyc"),o.includes(e))return console.log("checkAdminStatus: User is admin via NEXT_PUBLIC_ADMIN_EMAILS"),!0}catch(e){console.warn("checkAdminStatus: Error checking NEXT_PUBLIC_ADMIN_EMAILS:",e)}if(e.endsWith("@collectif.nyc"))return console.log("checkAdminStatus: User is admin via @collectif.nyc domain"),!0;try{if(localStorage.getItem("adminOverride")===e)return console.log("checkAdminStatus: User is admin via localStorage override"),!0}catch(e){console.warn("checkAdminStatus: Error checking localStorage override:",e)}for(let t of[/^admin@/i,/^administrator@/i,/^superuser@/i,/^root@/i])if(t.test(e))return console.log("checkAdminStatus: User is admin via pattern match:",t),!0;return"jonathan@collectif.nyc"===e?(console.log("checkAdminStatus: User is admin via hardcoded fallback"),!0):(console.log("checkAdminStatus: User is not admin:",e),!1)}async function m(){try{if(!i||!c)throw Error("Azure AD environment variables are not configured. Please set NEXT_PUBLIC_AZURE_AD_CLIENT_ID and NEXT_PUBLIC_AZURE_AD_TENANT_ID in your .env.local file");return await s.loginRedirect(d),null}catch(e){throw console.error("Sign in error:",e),e}}async function g(){try{await s.logoutPopup()}catch(e){console.error("Sign out error:",e)}}async function f(){try{let e=s.getActiveAccount();if(!e)return console.log("getAuthUser: No active account found"),null;let t=null;try{let e=await s.acquireTokenSilent({scopes:["User.Read","Directory.Read.All"]}),o=await fetch("https://graph.microsoft.com/v1.0/me",{headers:{Authorization:"Bearer ".concat(e.accessToken)}});if(!o.ok)throw Error("Failed to fetch user details from Graph API");t=await o.json(),console.log("getAuthUser: Successfully fetched user data from Graph API")}catch(o){console.warn("getAuthUser: Graph API failed, using fallback data:",o),t={mail:e.username,userPrincipalName:e.username,displayName:e.name}}let o=t.mail||t.userPrincipalName||e.username,a=u(o);return console.log("getAuthUser Debug:",{userEmail:o,accountName:e.name,accountId:e.localAccountId,isAdmin:a,adminEmails:"jonathan@collectif.nyc,Rafael@collectif.nyc",envVarAccessible:!0}),{id:e.localAccountId,name:t.displayName||e.name||"",email:o||"",isAdmin:a,isBasic:!0}}catch(e){console.error("getAuthUser error:",e);try{let e=s.getActiveAccount();if(!e)return console.log("getAuthUser: No account available for fallback"),null;let t=e.username,o=u(t);return console.log("getAuthUser Fallback Debug:",{accountEmail:t,accountName:e.name,isAdmin:o}),{id:e.localAccountId||"fallback-user",name:e.name||"Unknown User",email:t||"",isAdmin:o,isBasic:!0}}catch(e){return console.error("getAuthUser: Fallback also failed:",e),null}}}let h=(0,r.createContext)(void 0);function S(e){let{children:t}=e,[o,n]=(0,r.useState)(null),[i,c]=(0,r.useState)(!0);(0,r.useEffect)(()=>{(async()=>{try{await s.initialize();let e=await s.handleRedirectPromise();e&&(console.log("Redirect response received:",e),s.setActiveAccount(e.account));let t=await f();n(t)}catch(e){console.error("Auth initialization error:",e)}finally{c(!1)}})()},[]);let l=async()=>{try{c(!0),await m()}catch(e){console.error("Sign in error:",e),c(!1)}},d=async()=>{try{c(!0),await g(),n(null)}catch(e){console.error("Sign out error:",e)}finally{c(!1)}};return(0,a.jsx)(h.Provider,{value:{user:o,loading:i,signIn:l,signOut:d},children:t})}function y(){let e=(0,r.useContext)(h);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},58091:function(e,t,o){"use strict";o.d(t,{MigrationProvider:function(){return c}});var a=o(57437),r=o(2265),n=o(69064);let i=(0,r.createContext)(void 0);function c(e){let{children:t}=e,[o,c]=(0,r.useState)(!1),[l,s]=(0,r.useState)(!1),[d,u]=(0,r.useState)(!1);(0,r.useEffect)(()=>{(()=>{try{if("true"===localStorage.getItem("dataMigrated")||"true"===localStorage.getItem("db_migrated")){s(!0),u(!1);return}let e=localStorage.getItem("monthlyProjections")||localStorage.getItem("signedFees")||localStorage.getItem("asrFees")||localStorage.getItem("monthlyStatuses")||localStorage.getItem("monthlyComments")||localStorage.getItem("closedProjects")||localStorage.getItem("projectAssignments")||localStorage.getItem("projectManagers");u(!!e)}catch(e){console.error("Error checking migration status:",e)}})()},[]);let m=async()=>{if(!o&&!l){c(!0);try{console.log("Starting client-side migration...");let e=JSON.parse(localStorage.getItem("monthlyProjections")||"{}"),t=JSON.parse(localStorage.getItem("monthlyStatuses")||"{}"),o=JSON.parse(localStorage.getItem("monthlyComments")||"{}"),a=JSON.parse(localStorage.getItem("signedFees")||"{}"),r=JSON.parse(localStorage.getItem("asrFees")||"{}"),i=JSON.parse(localStorage.getItem("closedProjects")||"[]"),c=JSON.parse(localStorage.getItem("projectAssignments")||"{}"),l=JSON.parse(localStorage.getItem("projectManagers")||"[]"),d=[];if(Object.keys(e).length>0)for(let[t,o]of Object.entries(e))for(let[e,a]of Object.entries(o))d.push(fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:e,value:a})}));if(Object.keys(t).length>0)for(let[e,o]of Object.entries(t))for(let[t,a]of Object.entries(o))d.push(fetch("/api/statuses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,status:a})}));if(Object.keys(o).length>0)for(let[e,t]of Object.entries(o))for(let[o,a]of Object.entries(t))d.push(fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:o,comment:a})}));if(Object.keys(a).length>0)for(let[e,t]of Object.entries(a))d.push(fetch("/api/signed-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,value:t})}));if(Object.keys(r).length>0)for(let[e,t]of Object.entries(r))d.push(fetch("/api/asr-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,value:t})}));if(i.length>0)for(let e of i)d.push(fetch("/api/closed-projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})}));if(Object.keys(c).length>0)for(let[e,t]of Object.entries(c))d.push(fetch("/api/project-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,managerId:t})}));if(l.length>0)for(let e of l)d.push(fetch("/api/project-managers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}));if(d.length>0){let e=(await Promise.allSettled(d)).filter(e=>"rejected"===e.status);if(e.length>0)throw console.error("Some migrations failed:",e),e.some(e=>{var t,o,a,r,n,i;return"rejected"===e.status&&((null===(o=e.reason)||void 0===o?void 0:null===(t=o.message)||void 0===t?void 0:t.includes("Failed to fetch"))||(null===(r=e.reason)||void 0===r?void 0:null===(a=r.message)||void 0===a?void 0:a.includes("connection"))||(null===(i=e.reason)||void 0===i?void 0:null===(n=i.message)||void 0===n?void 0:n.includes("timeout")))})?n.ZP.error("Migration failed: Check database connections. Retrying in 5 seconds...",{duration:5e3}):n.ZP.error("Migration failed: Some data could not be migrated. Retrying in 5 seconds...",{duration:5e3}),Error("Migration failed");console.log("Migration completed successfully"),n.ZP.success("Migration complete")}localStorage.removeItem("monthlyProjections"),localStorage.removeItem("monthlyStatuses"),localStorage.removeItem("monthlyComments"),localStorage.removeItem("signedFees"),localStorage.removeItem("asrFees"),localStorage.removeItem("closedProjects"),localStorage.removeItem("projectAssignments"),localStorage.removeItem("projectManagers"),localStorage.setItem("dataMigrated","true"),localStorage.setItem("db_migrated","true"),s(!0),u(!1)}catch(e){console.error("Migration failed:",e),localStorage.setItem("db_migrated","true"),s(!0),setTimeout(()=>{l||g()},5e3)}finally{c(!1)}}},g=async()=>{s(!1),localStorage.removeItem("db_migrated"),localStorage.removeItem("dataMigrated"),await m()};return(0,a.jsx)(i.Provider,{value:{isMigrating:o,isMigrated:l,hasLocalData:d,migrateData:m,retryMigration:g},children:t})}},47960:function(){},23824:function(e){e.exports={style:{fontFamily:"'__Inter_f367f3', '__Inter_Fallback_f367f3'",fontStyle:"normal"},className:"__className_f367f3",variable:"__variable_f367f3"}}},function(e){e.O(0,[159,64,244,971,117,744],function(){return e(e.s=75545)}),_N_E=e.O()}]);