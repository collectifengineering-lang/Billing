(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{78929:function(e,t,r){Promise.resolve().then(r.bind(r,37306))},37306:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return er}});var s=r(57437),a=r(2265),l=r(99376),o=r(90483),n=r(58091),i=r(94508),c=r(10398),d=r(7586),m=r(46221),u=r(98728),x=r(91723),h=r(27648),g=r(33145);function f(e){var t;let{cacheInfo:r,autoRefreshStatus:a}=e,{user:l}=(0,o.a)();return(0,s.jsx)("div",{className:"bg-white shadow-sm border-b border-gray-200",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex items-center justify-between h-16",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-8",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("div",{className:"relative w-12 h-12",children:(0,s.jsx)(g.default,{src:"/collectif-logo.png",alt:"Collectif Logo",fill:!0,className:"object-contain"})}),(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Collectif MEP's Billings"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsxs)(h.default,{href:"/projects",className:"flex items-center text-gray-600 hover:text-gray-900 transition-colors",children:[(0,s.jsx)(d.Z,{className:"h-5 w-5 mr-2"}),"Project Summary"]}),(null==l?void 0:l.isAdmin)&&(0,s.jsxs)(h.default,{href:"/dashboard",className:"flex items-center text-gray-600 hover:text-gray-900 transition-colors",children:[(0,s.jsx)(m.Z,{className:"h-5 w-5 mr-2"}),"Financial Dashboard"]}),(null==l?void 0:l.isAdmin)&&(0,s.jsxs)(h.default,{href:"/settings",className:"flex items-center text-gray-600 hover:text-gray-900 transition-colors",children:[(0,s.jsx)(u.Z,{className:"h-5 w-5 mr-2"}),"Settings"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[a&&(0,s.jsxs)("div",{className:"flex items-center space-x-2 text-xs text-gray-500",children:[(0,s.jsx)(x.Z,{className:"h-3 w-3"}),(0,s.jsx)("span",{className:a.isActive?"text-green-600":"text-gray-400",children:a.isActive?"Auto-refresh":"Auto-refresh off"}),a.isActive&&(0,s.jsxs)("span",{className:"text-gray-400",children:["(",(t=a.nextRefreshIn,"".concat(Math.floor(t/6e4),":").concat(Math.floor(t%6e4/1e3).toString().padStart(2,"0"))),")"]})]}),r&&(0,s.jsxs)("div",{className:"text-xs text-gray-500",children:[r.fromCache?"From cache":"Fresh data",r.changes&&(0,s.jsxs)("span",{className:"ml-2 text-green-600",children:["+",Object.values(r.changes).flat().length," changes"]})]})]})]})})})}var p=r(48736),j=r(95252),b=r(70525),y=r(95805);function v(e){let{billingData:t,closedProjects:r,stats:a}=e,l=a||(0,i.fc)(t,r),o=[{name:"Total Projects",value:l.totalProjects,icon:p.Z,color:"bg-blue-500"},{name:"Total Billed YTD",value:(0,i.xG)(l.totalBilled),icon:j.Z,color:"bg-green-500"},{name:"Backlog",value:(0,i.xG)(l.totalUnbilled),icon:b.Z,color:"bg-yellow-500"},{name:"Active Projects",value:l.activeProjects,icon:y.Z,color:"bg-purple-500"}];return(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:o.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value})]})]})},e.name))})}var N=r(58896),w=r(11239),S=r(42488),C=r(33327);function k(e){let{stats:t}=e,r=[{name:"Total Projects",value:t.totalProjects,icon:p.Z,color:"bg-blue-500",description:"Active and closed projects"},{name:"Total Billed YTD",value:(0,i.xG)(t.totalBilled),icon:j.Z,color:"bg-green-500",description:"Year-to-date billed amount"},{name:"Backlog",value:(0,i.xG)(t.totalUnbilled),icon:b.Z,color:"bg-yellow-500",description:"Unbilled work in progress"},{name:"Active Projects",value:t.activeProjects,icon:y.Z,color:"bg-purple-500",description:"Currently active projects"}],a=[{name:"Total Hours",value:(0,i.bx)(t.totalHours),icon:x.Z,color:"bg-indigo-500",description:"Total tracked hours"},{name:"Billable Hours",value:(0,i.bx)(t.billableHours),icon:N.Z,color:"bg-emerald-500",description:"Billable time tracked"},{name:"Efficiency",value:(0,i.sP)(t.efficiency),icon:m.Z,color:"bg-orange-500",description:"Billable hours ratio"},{name:"Avg Hourly Rate",value:(0,i.xG)(t.averageHourlyRate),icon:w.Z,color:"bg-pink-500",description:"Average billable rate"}],l=[{name:"Total Time Value",value:(0,i.xG)(t.totalTimeValue),icon:S.Z,color:"bg-cyan-500",description:"Total value of tracked time"},{name:"Avg Hours/Project",value:(0,i.bx)(t.averageHoursPerProject),icon:C.Z,color:"bg-violet-500",description:"Average hours per project"}];return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Billing Overview"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:r.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Time Tracking KPIs"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:a.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Performance Metrics"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:l.map(e=>(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 rounded-lg ".concat(e.color),children:(0,s.jsx)(e.icon,{className:"h-6 w-6 text-white"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-600",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.name))})]}),t.topPerformingProjects.length>0&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Top Performing Projects"}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:t.topPerformingProjects.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:(0,s.jsx)("div",{className:"w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white text-sm font-bold",children:t+1})})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("p",{className:"text-sm font-medium text-gray-900 truncate",children:["Project ",e]}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"High efficiency & hours"})]})]},e))})})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,s.jsx)("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-medium opacity-90",children:"Total Revenue"}),(0,s.jsx)("p",{className:"text-2xl font-bold",children:(0,i.xG)(t.totalBilled+t.totalUnbilled)})]}),(0,s.jsx)(j.Z,{className:"h-8 w-8 opacity-80"})]})}),(0,s.jsx)("div",{className:"bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow p-6 text-white",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-medium opacity-90",children:"Time Value"}),(0,s.jsx)("p",{className:"text-2xl font-bold",children:(0,i.xG)(t.totalTimeValue)})]}),(0,s.jsx)(x.Z,{className:"h-8 w-8 opacity-80"})]})}),(0,s.jsx)("div",{className:"bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow p-6 text-white",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-medium opacity-90",children:"Efficiency"}),(0,s.jsx)("p",{className:"text-2xl font-bold",children:(0,i.sP)(t.efficiency)})]}),(0,s.jsx)(m.Z,{className:"h-8 w-8 opacity-80"})]})})]})]})}var P=r(47625),I=r(7476),E=r(56940),A=r(97059),T=r(62994),O=r(8147),F=r(22190),D=r(23263),Z=r(77086);function R(e){let{billingData:t,closedProjects:r}=e,l=t||[],o=r||new Set,[n,c]=(0,a.useState)(0),d=e=>fetch(e).then(e=>e.json()),{data:m}=(0,Z.ZP)("/api/projections",d),{data:u}=(0,Z.ZP)("/api/statuses",d);(0,a.useEffect)(()=>{let e=()=>{c(e=>e+1)};return window.addEventListener("projectionsUpdated",e),window.addEventListener("statusUpdated",e),()=>{window.removeEventListener("projectionsUpdated",e),window.removeEventListener("statusUpdated",e)}},[]);let x=m||{},h=u||{},g=(0,i.UF)().map(e=>{let t=0,r=0,s=new Set([...l.map(e=>e.projectId),...Array.from(o)]);s.forEach(s=>{let a=x[s],l=h[s];if(a&&a[e]){let s=a[e];l&&"Billed"===l[e]?r+=s:t+=s}});let a=t;return e===new Date().toISOString().slice(0,7)&&console.log("BillingChart: Current month data:",{month:e,monthProjected:t,monthBilled:r,monthUnbilled:a,allProjectIdsCount:s.size,activeProjectsCount:l.length,closedProjectsCount:o.size}),{month:e,name:(0,i.bh)(e),billed:r,unbilled:a,projected:t,total:t}});return(0,s.jsx)("div",{className:"h-80",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsx)("div",{className:"chart-container",children:(0,s.jsx)(P.h,{width:"100%",height:320,children:(0,s.jsxs)(I.T,{data:g,margin:{top:20,right:30,left:20,bottom:5},children:[(0,s.jsx)(E.q,{strokeDasharray:"3 3"}),(0,s.jsx)(A.K,{dataKey:"name",angle:-45,textAnchor:"end",height:80,fontSize:12,interval:0}),(0,s.jsx)(T.B,{tickFormatter:e=>"$".concat((e/1e3).toFixed(0),"k"),fontSize:12,label:{value:"Amount (USD)",angle:-90,position:"insideLeft"}}),(0,s.jsx)(O.u,{content:(0,s.jsx)(e=>{let{active:t,payload:r,label:a}=e;return t&&r&&r.length?(0,s.jsxs)("div",{className:"bg-white p-4 border rounded-lg shadow-lg",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900",children:a}),r.map((e,t)=>(0,s.jsxs)("p",{className:"text-sm",style:{color:e.color},children:[e.name,": ",(0,i.xG)(e.value)]},t))]}):null},{})}),(0,s.jsx)(F.D,{}),(0,s.jsx)(D.u,{type:"monotone",dataKey:"projected",stackId:"1",stroke:"#f97316",fill:"#f97316",fillOpacity:.6,name:"Projected"}),(0,s.jsx)(D.u,{type:"monotone",dataKey:"billed",stackId:"1",stroke:"#10b981",fill:"#10b981",fillOpacity:.6,name:"Billed"})]})})})})})}var M=r(29),B=r.n(M),L=r(60413),z=r(22135),_=r(40875),U=r(73247),J=r(32489),H=r(92369),V=r(30401),G=r(69064),Y=r(92735),W=r(17689),X=r(65302),K=r(22252);function q(e){let t=[],r="",s=!1;for(let a=0;a<e.length;a++){let l=e[a];'"'===l?s&&'"'===e[a+1]?(r+='"',a++):s=!s:","!==l||s?r+=l:(t.push(r.trim()),r="")}return t.push(r.trim()),t}function $(e){let[t,r]=e.split("-");return new Date(parseInt(t),parseInt(r)-1).toLocaleDateString("en-US",{month:"short",year:"numeric"})}function Q(e,t){let r=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");if(void 0!==s.download){let e=URL.createObjectURL(r);s.setAttribute("href",e),s.setAttribute("download",t),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}}function ee(e){let{billingData:t,monthlyProjections:r,asrFees:l,signedFees:o,monthRange:n,onImportData:i}=e,[c,d]=(0,a.useState)(!1),[m,u]=(0,a.useState)(null),[x,h]=(0,a.useState)(!1),g=(0,a.useRef)(null),f=async e=>{var r;let s=null===(r=e.target.files)||void 0===r?void 0:r[0];if(s){if(!s.name.toLowerCase().endsWith(".csv")){G.Am.error("Please select a CSV file");return}d(!0),u(null);try{let e=await new Promise((e,t)=>{let r=new FileReader;r.onload=t=>{var r;e(null===(r=t.target)||void 0===r?void 0:r.result)},r.onerror=()=>{t(Error("Failed to read CSV file"))},r.readAsText(s)}),r=function(e,t){try{let r=e.trim().split("\n");if(r.length<2)return{success:!1,errors:["CSV file must have at least a header row and one data row"]};let s=q(r[0]),a=r.slice(1),l=["Project ID","Project Name","Customer Name","Signed Fee","ASR Fee"].filter(e=>!s.includes(e));if(l.length>0)return{success:!1,errors:["Missing required headers: ".concat(l.join(", "))]};let o=s.slice(5),n=o.filter(e=>!/^\d{4}-\d{2}$/.test(e));if(n.length>0)return{success:!1,errors:["Invalid month format found: ".concat(n.join(", "),". Expected format: YYYY-MM")]};let i={},c=[];if(a.forEach((e,r)=>{let a=q(e);if(a.length!==s.length){c.push("Row ".concat(r+2,": Column count mismatch. Expected ").concat(s.length,", got ").concat(a.length));return}let l=a[0].trim();if(a[1],a[2],parseFloat(a[3]),parseFloat(a[4]),!t.some(e=>e.projectId===l)){c.push("Row ".concat(r+2,': Project ID "').concat(l,'" not found in current data'));return}let n={};o.forEach((e,t)=>{let r=parseFloat(a[5+t])||0;n[e]=r}),i[l]=n}),c.length>0)return{success:!1,errors:c,data:i};return{success:!0,data:i,message:"Successfully imported ".concat(Object.keys(i).length," projects with ").concat(o.length," months of data")}}catch(e){return{success:!1,errors:["Error parsing CSV: ".concat(e instanceof Error?e.message:"Unknown error")]}}}(e,t);u(r),r.success&&r.data?G.Am.success(r.message||"Import completed successfully!"):G.Am.error("Import failed. Please check the errors below.")}catch(e){console.error("Import error:",e),G.Am.error("Failed to read CSV file"),u({success:!1,errors:["Failed to read CSV file"]})}finally{d(!1)}}},j=()=>{h(!1),u(null),g.current&&(g.current.value="")};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,s.jsxs)("button",{onClick:()=>{try{let e=function(e,t,r,s,a){let l=["Project ID","Project Name","Customer Name","Signed Fee","ASR Fee",...a.map(e=>$(e))],o=e.map(e=>{let l={projectId:e.projectId,projectName:e.projectName,customerName:e.customerName,signedFee:s[e.projectId]||e.signedFee||0,asrFee:r[e.projectId]||0};return a.forEach(r=>{var s;let a=(null===(s=t[e.projectId])||void 0===s?void 0:s[r])||0;l[r]=a}),l});return[l.join(","),...o.map(e=>l.map(t=>{let r;if("Project ID"===t){let t=e.projectId;console.log("CSV Export - Project ID type:",typeof t,"value:",t),console.log("CSV Export - Final Project ID value:",r="number"==typeof t||"string"==typeof t?String(t):"")}else if("Project Name"===t)r=e.projectName;else if("Customer Name"===t)r=e.customerName;else if("Signed Fee"===t)r=e.signedFee;else if("ASR Fee"===t)r=e.asrFee;else{let s=a.find(e=>$(e)===t);r=s?e[s]:0}let s=String(r).replace(/"/g,'""');return'"'.concat(s,'"')}).join(","))].join("\n")}(t,r,l,o,n),s=function(){let e=new Date,t=e.toISOString().slice(0,10),r=e.toTimeString().slice(0,8).replace(/:/g,"-");return"projections-export-".concat(t,"-").concat(r,".csv")}();Q(e,s),G.Am.success("Projections exported successfully!")}catch(e){console.error("Export error:",e),G.Am.error("Failed to export projections")}},className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[(0,s.jsx)(Y.Z,{className:"w-4 h-4"}),"Export to CSV"]}),(0,s.jsxs)("button",{onClick:()=>{h(!0),u(null)},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[(0,s.jsx)(W.Z,{className:"w-4 h-4"}),"Import from CSV"]}),(0,s.jsxs)("button",{onClick:()=>{Q("Project ID,Project Name,Customer Name,Signed Fee,ASR Fee,2024-01,2024-02,2024-03,2024-04,2024-05,2024-06\n910829000008470049,Sample Project,Sample Customer,50000,10000,5000,7500,6000,8000,9000,7000","projections-template.csv"),G.Am.success("Template downloaded successfully!")},className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:[(0,s.jsx)(p.Z,{className:"w-4 h-4"}),"Download Template"]})]}),x&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsxs)("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[(0,s.jsx)(p.Z,{className:"w-5 h-5"}),"Import Projections from CSV"]}),(0,s.jsx)("button",{onClick:j,className:"text-gray-500 hover:text-gray-700",children:(0,s.jsx)(J.Z,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"Select a CSV file to import projections data. The file should include:"}),(0,s.jsxs)("ul",{className:"text-sm text-gray-600 list-disc list-inside mb-4",children:[(0,s.jsx)("li",{children:"Project ID, Project Name, Customer Name"}),(0,s.jsx)("li",{children:"Signed Fee and ASR Fee columns"}),(0,s.jsx)("li",{children:"Monthly projection columns (format: YYYY-MM)"})]}),(0,s.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:(0,s.jsxs)("p",{className:"text-sm text-blue-800",children:[(0,s.jsx)("strong",{children:"Tip:"}),' Use the "Download Template" button to get a sample CSV file with the correct format.']})}),(0,s.jsx)("input",{ref:g,type:"file",accept:".csv",onChange:f,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",disabled:c})]}),m&&(0,s.jsxs)("div",{className:"mb-4",children:[m.success?(0,s.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg",children:[(0,s.jsx)(X.Z,{className:"w-5 h-5 text-green-600"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-green-800 font-medium",children:"Import Successful"}),(0,s.jsx)("p",{className:"text-green-700 text-sm",children:m.message})]})]}):(0,s.jsxs)("div",{className:"flex items-start gap-2 p-3 bg-red-50 border border-red-200 rounded-lg",children:[(0,s.jsx)(K.Z,{className:"w-5 h-5 text-red-600 mt-0.5"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-red-800 font-medium",children:"Import Failed"}),m.errors&&(0,s.jsx)("ul",{className:"text-red-700 text-sm mt-1",children:m.errors.map((e,t)=>(0,s.jsx)("li",{className:"list-disc list-inside",children:e},t))})]})]}),!m.success&&m.data&&Object.keys(m.data).length>0&&(0,s.jsx)("div",{className:"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:(0,s.jsx)("p",{className:"text-yellow-800 text-sm",children:'Some data was successfully parsed. You can still import the valid data by clicking "Import Valid Data".'})})]}),(0,s.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,s.jsx)("button",{onClick:j,className:"px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"}),(null==m?void 0:m.data)&&Object.keys(m.data).length>0&&(0,s.jsxs)("button",{onClick:()=>{(null==m?void 0:m.success)&&m.data&&(i(m.data),h(!1),u(null),G.Am.success("Data imported successfully!"))},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:["Import ",m.success?"All":"Valid"," Data"]})]})]})})]})}function et(e){let{billingData:t,projections:r,onUpdateProjections:l,closedProjects:o,onClosedProjectsChange:n,useDB:c=!0}=e,d=t||[],[m,u]=(0,a.useState)(null),[x,h]=(0,a.useState)(null),[g,f]=(0,a.useState)(null),[p,j]=(0,a.useState)(""),[b,y]=(0,a.useState)(null),[v,N]=(0,a.useState)(null),w=(0,a.useRef)(null),[S,C]=(0,a.useState)(null),[k,P]=(0,a.useState)(null),I=(0,a.useRef)(null),[E,A]=(0,a.useState)(null),[T,O]=(0,a.useState)(""),[F,D]=(0,a.useState)(null),[R,M]=(0,a.useState)(o||new Set),[Y,W]=(0,a.useState)([]),[X,K]=(0,a.useState)({}),[q,$]=(0,a.useState)(!1),[Q,et]=(0,a.useState)({field:"projectName",direction:"asc"}),[er,es]=(0,a.useState)(""),ea=e=>fetch(e).then(e=>e.json()),el={revalidateOnFocus:!0,revalidateOnReconnect:!0,refreshInterval:0},{data:eo,mutate:en}=(0,Z.ZP)("/api/signed-fees",ea,el),{data:ei,mutate:ec}=(0,Z.ZP)("/api/asr-fees",ea,el),{data:ed,mutate:em}=(0,Z.ZP)("/api/projections",ea,el),{data:eu,mutate:ex}=(0,Z.ZP)("/api/statuses",ea,el),{data:eh,mutate:eg}=(0,Z.ZP)("/api/comments",ea,el),{data:ef,mutate:ep}=(0,Z.ZP)("/api/closed-projects",ea,el),{data:ej,mutate:eb}=(0,Z.ZP)("/api/project-assignments",ea,el),{data:ey,mutate:ev}=(0,Z.ZP)("/api/project-managers",ea,el),[eN,ew]=(0,a.useState)({}),[eS,eC]=(0,a.useState)({}),[ek,eP]=(0,a.useState)({}),[eI,eE]=(0,a.useState)({}),[eA,eT]=(0,a.useState)({}),eO=(0,a.useRef)(null),eF=(0,a.useRef)(null),eD=(0,a.useRef)(null),eZ=(0,a.useRef)(null),eR=(0,a.useRef)(null),eM=(0,a.useRef)(null),eB=(0,a.useRef)(null),eL=(0,a.useRef)(null),[ez,e_]=(0,a.useState)(0),[eU,eJ]=(0,a.useState)(0),[eH,eV]=(0,a.useState)(!1),[eG,eY]=(0,a.useState)(0),[eW,eX]=(0,a.useState)(0),eK=(0,a.useMemo)(()=>(0,i.ji)(),[]),eq=(0,a.useMemo)(()=>new Date().toISOString().slice(0,7),[]);(0,a.useEffect)(()=>{eo&&Object.keys(eo).length>0&&ew(eo)},[eo]),(0,a.useEffect)(()=>{ei&&Object.keys(ei).length>0&&eC(ei)},[ei]),(0,a.useEffect)(()=>{ed&&Object.keys(ed).length>0&&eP(ed)},[ed]),(0,a.useEffect)(()=>{eu&&Object.keys(eu).length>0&&eE(eu)},[eu]),(0,a.useEffect)(()=>{eh&&Object.keys(eh).length>0&&eT(eh)},[eh]),(0,a.useEffect)(()=>{if(ef&&Array.isArray(ef)){let e=new Set(ef);M(e),null==n||n(e)}},[ef,n]),(0,a.useEffect)(()=>{ej&&"object"==typeof ej&&K(ej)},[ej]),(0,a.useEffect)(()=>{ey&&Array.isArray(ey)&&W(ey)},[ey]),(0,a.useEffect)(()=>()=>{},[]),(0,a.useEffect)(()=>{console.log("HighPerformanceTable: projectManagers state changed:",Y)},[Y]),(0,a.useEffect)(()=>{let e=setInterval(()=>{let e=localStorage.getItem("projectManagers");e&&Array.isArray(JSON.parse(e))&&0===Y.length&&(console.log("HighPerformanceTable: Periodic check found project managers but state is empty, reloading"),W(JSON.parse(e)))},5e3);return()=>clearInterval(e)},[Y.length]),(0,a.useEffect)(()=>{let e=e=>{if(b&&v){let t=e.target,r=document.querySelector('[data-dropdown="true"]');r&&!r.contains(t)&&(y(null),N(null))}if(S&&k){let t=e.target,r=document.querySelector('[data-dropdown="true"]');r&&!r.contains(t)&&(C(null),P(null))}if(E&&eL.current){let t=e.target;eL.current.contains(t)||(A(null),O(""),D(null))}};return(b||S||E)&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[b,v,S,k,E]),(0,a.useEffect)(()=>{var e,t;let r=()=>{eO.current&&eF.current&&(eF.current.scrollTop=eO.current.scrollTop)},s=()=>{eO.current&&eF.current&&(eO.current.scrollTop=eF.current.scrollTop)};return null===(e=eO.current)||void 0===e||e.addEventListener("scroll",r),null===(t=eF.current)||void 0===t||t.addEventListener("scroll",s),()=>{var e,t;null===(e=eO.current)||void 0===e||e.removeEventListener("scroll",r),null===(t=eF.current)||void 0===t||t.removeEventListener("scroll",s)}},[]),(0,a.useEffect)(()=>{if(!b||!v)return;let e=window.requestAnimationFrame(()=>{let e=w.current;if(!e)return;let{offsetWidth:t,offsetHeight:r}=e,s=window.innerWidth,a=window.innerHeight,l=v.x,o=v.y;l+t+8>s&&(l=Math.max(8,s-t-8)),o+r+8>a&&(o=Math.max(8,o-r)),(Math.abs(l-v.x)>1||Math.abs(o-v.y)>1)&&N({x:l,y:o})});return()=>window.cancelAnimationFrame(e)},[b,v]),(0,a.useEffect)(()=>{if(!S||!k)return;let e=window.requestAnimationFrame(()=>{let e=I.current;if(!e)return;let{offsetWidth:t,offsetHeight:r}=e,s=window.innerWidth,a=window.innerHeight,l=k.x,o=k.y;l+t+8>s&&(l=Math.max(8,s-t-8)),o+r+8>a&&(o=Math.max(8,o-r)),(Math.abs(l-k.x)>1||Math.abs(o-k.y)>1)&&P({x:l,y:o})});return()=>window.cancelAnimationFrame(e)},[S,k]),(0,a.useEffect)(()=>{eO.current&&eO.current.classList.add("hide-scrollbar"),eF.current&&(eF.current.style.overflowX="hidden")},[]),(0,a.useEffect)(()=>{if(eR.current){let e=eK.indexOf(eq);-1!==e&&(eR.current.scrollLeft=128*e)}},[eK,eq]),(0,a.useEffect)(()=>{var e;let t=()=>{eR.current&&$(eR.current.scrollLeft>0)};return null===(e=eR.current)||void 0===e||e.addEventListener("scroll",t),()=>{var e;null===(e=eR.current)||void 0===e||e.removeEventListener("scroll",t)}},[]),(0,a.useEffect)(()=>{eM.current&&e_(eM.current.clientHeight);let e=new ResizeObserver(()=>{eM.current&&e_(eM.current.clientHeight)});return eM.current&&e.observe(eM.current),()=>e.disconnect()},[]),(0,a.useEffect)(()=>{eB.current&&eJ(eB.current.clientHeight);let e=new ResizeObserver(()=>{eB.current&&eJ(eB.current.clientHeight)});return eB.current&&e.observe(eB.current),()=>e.disconnect()},[]),(0,a.useEffect)(()=>{eY((()=>{let e=document.createElement("div");e.style.overflowY="scroll",e.style.width="50px",e.style.height="50px",e.style.visibility="hidden",document.body.appendChild(e);let t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t})())},[]),(0,a.useEffect)(()=>{eX((()=>{let e=document.createElement("div");e.style.overflowX="scroll",e.style.height="50px",e.style.width="50px",e.style.visibility="hidden",document.body.appendChild(e);let t=e.offsetHeight-e.clientHeight;return document.body.removeChild(e),t})())},[]);let e$=(0,a.useCallback)((e,t)=>{var r;return(null==ed?void 0:null===(r=ed[e])||void 0===r?void 0:r[t])||0},[ed]),eQ=(0,a.useCallback)(e=>(null==ei?void 0:ei[e])||0,[ei]),e0=(0,a.useCallback)(e=>((null==eo?void 0:eo[e.projectId])||0)+eQ(e.projectId),[eo,eQ]),e5=(0,a.useCallback)(e=>eK.reduce((t,r)=>t+e$(e,r),0),[eK,e$]);(0,a.useCallback)(e=>{let t=null==ej?void 0:ej[e];if(!t)return;if(ey&&!Array.isArray(ey)){var r;return null===(r=ey[t])||void 0===r?void 0:r.color}let s=null==ey?void 0:ey.find(e=>e.id===t);return null==s?void 0:s.color},[ej,ey]);let e6=(0,a.useCallback)((e,t)=>{var r;return(null==eu?void 0:null===(r=eu[e])||void 0===r?void 0:r[t])||""},[eu]),e2=(0,a.useCallback)((e,t)=>{var r;return(null==eh?void 0:null===(r=eh[e])||void 0===r?void 0:r[t])||""},[eh]),e1=e=>{switch(e){case"Confirmed":return"bg-blue-50";case"Estimate":return"bg-yellow-50";case"Billed":return"bg-green-50";case"Other":return"bg-purple-50";default:return""}},e8=(0,a.useCallback)((e,t,r)=>{u({projectId:e,month:t}),j(r.toString())},[]),e9=(0,a.useCallback)(async()=>{if(!m)return;let{projectId:e,month:t}=m,r=parseFloat(p)||0;try{await fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,value:r})}),em(),window.dispatchEvent(new CustomEvent("projectionsUpdated")),u(null),j("")}catch(e){console.error("Error saving projection:",e),G.ZP.error("Failed to save projection")}},[m,p,em]),e7=(0,a.useCallback)(async()=>{if(!x)return;let e=parseFloat(p)||0;try{await fetch("/api/asr-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:x,value:e})}),eC(t=>({...t,[x]:e})),ec(),h(null),j("")}catch(e){console.error("Error saving ASR fee:",e),G.ZP.error("Failed to save ASR fee")}},[x,p,ec]),e4=(0,a.useCallback)(async()=>{if(!g)return;let e=parseFloat(p)||0;try{await fetch("/api/signed-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:g,value:e})}),ew(t=>({...t,[g]:e})),en(),f(null),j("")}catch(e){console.error("Error saving signed fee:",e),G.ZP.error("Failed to save signed fee")}},[g,p,en]),e3=(0,a.useCallback)(async e=>{try{await fetch("/api/closed-projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})});let t=new Set(R);t.add(e),M(t),null==n||n(t),ep(),y(null),G.ZP.success("Project closed")}catch(e){console.error("Error closing project:",e),G.ZP.error("Failed to close project")}},[R,n,ep]);(0,a.useCallback)(async e=>{try{await fetch("/api/closed-projects",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})});let t=new Set(R);t.delete(e),M(t),null==n||n(t),ep(),G.ZP.success("Project reopened")}catch(e){console.error("Error reopening project:",e),G.ZP.error("Failed to reopen project")}},[R,n,ep]);let te=async e=>{if(!S)return;let{projectId:t,month:r}=S;try{"Clear"===e?await fetch("/api/statuses",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:r})}):await fetch("/api/statuses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:r,status:e})}),ex(),window.dispatchEvent(new CustomEvent("projectionsUpdated")),C(null),P(null)}catch(e){console.error("Error updating status:",e),G.ZP.error("Failed to update status")}},tt=async e=>{if(!S)return;let{projectId:t,month:r}=S;if("AddComment"===e||"EditComment"===e){A(S),O(e2(t,r)),D(k),C(null),P(null);return}if("RemoveComment"===e){try{await fetch("/api/comments",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:r})}),eg(),C(null),P(null)}catch(e){console.error("Error removing comment:",e),G.ZP.error("Failed to remove comment")}return}await te(e)},tr=(0,a.useCallback)(e=>[...e].sort((e,t)=>{let r,s;switch(Q.field){case"projectName":r=e.projectName.toLowerCase(),s=t.projectName.toLowerCase();break;case"signedFee":r=eN[e.projectId]||e.signedFee||0,s=eN[t.projectId]||t.signedFee||0;break;case"asrFee":r=eQ(e.projectId),s=eQ(t.projectId);break;case"totalFee":r=e0(e),s=e0(t);break;case"projected":r=e5(e.projectId),s=e5(t.projectId);break;default:if(!eK.includes(Q.field))return 0;r=e$(e.projectId,Q.field),s=e$(t.projectId,Q.field)}return r<s?"asc"===Q.direction?-1:1:r>s?"asc"===Q.direction?1:-1:0}),[Q,eN,eQ,e0,e5,eK,e$]),ts=(0,a.useCallback)(e=>{et(t=>({field:e,direction:t.field===e&&"asc"===t.direction?"desc":"asc"}))},[]),ta=e=>Q.field!==e?null:"asc"===Q.direction?(0,s.jsx)(z.Z,{className:"h-4 w-4"}):(0,s.jsx)(_.Z,{className:"h-4 w-4"}),tl=e=>Q.field!==e?null:"asc"===Q.direction?(0,s.jsx)(z.Z,{className:"h-3 w-3"}):(0,s.jsx)(_.Z,{className:"h-3 w-3"}),to=(0,a.useMemo)(()=>ef&&Array.isArray(ef)?new Set(ef):new Set,[ef]),tn=tr(d.filter(e=>!to.has(e.projectId))),ti=(0,a.useMemo)(()=>er.trim()?tn.filter(e=>e.projectName.toLowerCase().includes(er.toLowerCase())):tn,[tn,er]);console.log("HighPerformanceTable: safeBillingData length:",d.length),console.log("HighPerformanceTable: activeProjects length:",tn.length),console.log("HighPerformanceTable: filteredProjects length:",ti.length),console.log("HighPerformanceTable: closedProjects size:",R.size),d.length>0&&console.log("HighPerformanceTable: First billing data item:",d[0]),(0,a.useEffect)(()=>{let e=()=>{if(eM.current){let e=eM.current.scrollHeight>eM.current.clientHeight;eV(e);let t=eG||15,r=e?"".concat(t,"px"):"0";eD.current&&eD.current.firstChild&&(eD.current.firstChild.style.paddingRight=r),eZ.current&&eZ.current.firstChild&&(eZ.current.firstChild.style.paddingRight=r)}};e();let t=new ResizeObserver(e);eM.current&&t.observe(eM.current);let r=setInterval(e,500);return()=>{t.disconnect(),clearInterval(r)}},[tn.length,eG]);let tc=async e=>{try{let t=[];Object.keys(e).forEach(r=>{Object.keys(e[r]).forEach(s=>{let a=e[r][s];0!==a&&t.push(fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:r,month:s,value:a})}))})}),t.length>0&&(await Promise.all(t),em(),G.ZP.success("Data imported successfully")),l&&l(e)}catch(e){console.error("Error importing data:",e),G.ZP.error("Failed to import data")}};return(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 bg-white rounded-lg shadow overflow-hidden",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 px-6 py-4 border-b border-gray-200",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex items-center justify-between mb-4",children:(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750",children:[(0,s.jsx)("h3",{className:"jsx-19280ab6560fe750 text-lg font-medium text-gray-900",children:"Projections Table"}),(0,s.jsxs)("p",{className:"jsx-19280ab6560fe750 text-sm text-gray-600",children:["Virtualized table with ",ti.length," active projects - click any cell to edit"]})]})}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 mb-4",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 relative",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,s.jsx)(U.Z,{className:"h-4 w-4 text-gray-400"})}),(0,s.jsx)("input",{type:"text",placeholder:"Filter projects by name...",value:er,onChange:e=>es(e.target.value),className:"jsx-19280ab6560fe750 block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),er&&(0,s.jsx)("button",{onClick:()=>es(""),className:"jsx-19280ab6560fe750 absolute inset-y-0 right-0 pr-3 flex items-center",children:(0,s.jsx)(J.Z,{className:"h-4 w-4 text-gray-400 hover:text-gray-600"})})]}),er&&(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 mt-2 text-sm text-gray-600",children:["Showing ",ti.length," of ",tn.length," projects"]})]}),(0,s.jsx)(ee,{billingData:d,monthlyProjections:ek,asrFees:eS,signedFees:eN,monthRange:eK,onImportData:tc})]}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 relative table-container",children:[(0,s.jsxs)("div",{style:{width:"776px",height:"600px"},className:"jsx-19280ab6560fe750 absolute left-0 top-0 z-30 bg-white flex flex-col",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-b border-gray-200 sticky-header",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-[264px] bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("projectName"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-start cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Project"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("projectName")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("signedFee"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Signed Fee"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("signedFee")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("asrFee"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Total ASR Fee"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("asrFee")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("totalFee"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Total Fee"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("totalFee")})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{onClick:()=>ts("projected"),className:"jsx-19280ab6560fe750 h-18 px-4 py-3 flex items-center justify-end cursor-pointer hover:bg-gray-100 transition-colors group",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:"Projected"}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 ml-1 text-gray-400 group-hover:text-gray-600",children:ta("projected")})]})})]}),(0,s.jsx)("div",{ref:eB,style:{overflowY:"auto",overflowX:"hidden"},className:"jsx-19280ab6560fe750 flex-1 hide-scrollbar",children:(0,s.jsx)(L.t7,{height:eU,itemCount:ti.length,itemSize:72,width:776,outerRef:eO,overscanCount:5,children:e=>{let{index:t,style:r}=e,a=ti[t];if(!a)return null;let l=e5(a.projectId),o=e0(a),n=eQ(a.projectId),c=x===a.projectId,d=(null==ej?void 0:ej[a.projectId])||X[a.projectId],m=(null==ey?void 0:ey[d])||Y.find(e=>e.id===d);return(0,s.jsxs)("div",{style:r,className:"jsx-19280ab6560fe750 flex border-b border-gray-200 sticky-column",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-[264px] bg-gray-50 border-r border-gray-200",children:(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex items-center h-18 px-4",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex-1 min-w-0 flex flex-col justify-center overflow-hidden",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex items-center",children:[m&&(0,s.jsx)("div",{style:{backgroundColor:m.color},className:"jsx-19280ab6560fe750 w-3 h-3 rounded-full mr-2"}),(0,s.jsx)("span",{title:a.projectName,className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-900 truncate",children:a.projectName})]}),m&&(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs text-gray-500 italic truncate",children:m.name})]}),(0,s.jsx)("button",{onClick:e=>{y(a.projectId),N({x:e.clientX,y:e.clientY})},className:"jsx-19280ab6560fe750 ml-2 p-1 text-gray-400 hover:text-gray-600",children:(0,s.jsx)(H.Z,{className:"h-4 w-4"})})]})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center",children:g===a.projectId?(0,s.jsx)("input",{type:"number",value:p,onChange:e=>j(e.target.value),onBlur:e4,onKeyDown:e=>"Enter"===e.key&&e4(),autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-blue-300 rounded text-sm"}):(()=>{let e=eN[a.projectId],t=null==eo?void 0:eo[a.projectId],r=void 0!==e?e:void 0!==t?t:0;return(0,s.jsx)("div",{onClick:()=>{f(a.projectId),j(r.toString())},className:"jsx-19280ab6560fe750 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded",children:(0,i.xG)(r)})})()})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center",children:c?(0,s.jsx)("input",{type:"number",value:p,onChange:e=>j(e.target.value),onBlur:e7,onKeyDown:e=>"Enter"===e.key&&e7(),autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-blue-300 rounded text-sm"}):(0,s.jsx)("div",{onClick:()=>{h(a.projectId),j(n.toString())},className:"jsx-19280ab6560fe750 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded",children:(0,i.xG)(n)})})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium",children:(0,i.xG)(o)})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium",children:(0,i.xG)(l)})})]})}})}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-t border-gray-200",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-[264px] bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-left text-sm font-medium text-gray-900",children:"Totals"})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>{let r=eN[t.projectId],s=null==eo?void 0:eo[t.projectId];return e+(void 0!==r?r:void 0!==s?s:0)},0))})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>e+eQ(t.projectId),0))})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>e+e0(t),0))})}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 bg-gray-50 border-r border-gray-200",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900",children:(0,i.xG)(d.reduce((e,t)=>e+e5(t.projectId),0))})})]}),(0,s.jsx)("div",{style:{height:"".concat(eW,"px")},className:"jsx-19280ab6560fe750"})]}),(0,s.jsx)("div",{ref:eR,style:{height:"600px",marginLeft:"776px"},className:"jsx-19280ab6560fe750 "+"overflow-x-auto overflow-y-hidden scrollable-outer ".concat(q?"scrolled-horizontal":""),children:(0,s.jsxs)("div",{style:{width:"".concat(128*eK.length,"px"),height:"100%",display:"flex",flexDirection:"column"},className:"jsx-19280ab6560fe750",children:[(0,s.jsx)("div",{ref:eD,className:"jsx-19280ab6560fe750 scrollable-header",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-b border-gray-200 sticky-header header-flex",children:eK.map(e=>(0,s.jsx)("div",{onClick:()=>ts(e),title:"Click to sort by ".concat((0,i.bh)(e)," projections"),className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 flex items-center justify-center px-4 py-3 border-r border-gray-200 h-18 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors group",children:(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 flex flex-col items-center group-hover:text-gray-700",children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750 text-xs font-medium text-gray-500 uppercase tracking-wider leading-none whitespace-nowrap group-hover:text-gray-700",children:(0,i.bh)(e)}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 text-gray-400 mt-0.5 group-hover:text-gray-600",children:tl(e)})]})},e))})}),(0,s.jsx)("div",{ref:eM,style:{overflowY:"auto",overflowX:"hidden"},className:"jsx-19280ab6560fe750 flex-1 body-wrapper",children:(0,s.jsx)(L.t7,{height:ez,itemCount:ti.length,itemSize:72,width:128*eK.length,outerRef:eF,overscanCount:5,children:e=>{let{index:t,style:r}=e,a=ti[t];return a?(0,s.jsx)("div",{style:r,className:"jsx-19280ab6560fe750 flex border-b border-gray-200",children:eK.map(e=>{let t=e$(a.projectId,e),r=(null==m?void 0:m.projectId)===a.projectId&&(null==m?void 0:m.month)===e;return(0,s.jsxs)("div",{onClick:()=>e8(a.projectId,e,t),title:e2(a.projectId,e),className:"jsx-19280ab6560fe750 "+"flex-shrink-0 w-32 h-18 px-4 py-2 text-center text-sm border-r border-gray-200 cursor-pointer relative ".concat(e1(e6(a.projectId,e))||"bg-white"),children:[r?(0,s.jsx)("input",{type:"number",value:p,onChange:e=>j(e.target.value),onBlur:e9,onKeyDown:e=>"Enter"===e.key&&e9(),autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-blue-300 rounded text-sm"}):(0,i.xG)(t),(0,s.jsx)("button",{onClick:t=>{t.stopPropagation(),C({projectId:a.projectId,month:e}),P({x:t.clientX,y:t.clientY})},className:"jsx-19280ab6560fe750 absolute top-1 right-1 text-gray-400 hover:text-gray-600 text-xs",children:"⋯"})]},e)})}):null}})}),(0,s.jsx)("div",{ref:eZ,className:"jsx-19280ab6560fe750 scrollable-footer",children:(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex bg-gray-50 border-t border-gray-200 footer-flex",children:eK.map((e,t)=>{let r=eK.map(e=>d.reduce((t,r)=>t+e$(r.projectId,e),0));return(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 flex-shrink-0 w-32 h-18 px-4 py-2 text-center text-sm font-medium text-gray-900 border-r border-gray-200 bg-gray-50",children:(0,i.xG)(r[t])},e)})})})]})})]}),b&&v&&(0,s.jsxs)("div",{ref:w,"data-dropdown":"true",style:{left:"".concat(v.x,"px"),top:"".concat(v.y,"px"),pointerEvents:"auto"},className:"jsx-19280ab6560fe750 fixed bg-white border border-gray-200 rounded-lg shadow-xl z-[9999] min-w-[220px] py-2",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 py-1",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 pb-1 text-[11px] font-medium text-gray-500 uppercase tracking-wider",children:"Assign Project Manager"}),ey&&0!==Object.keys(ey).length||0!==Y.length?(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 space-y-0.5",children:(()=>{let e=(null==ej?void 0:ej[b])||X[b];return ey&&Object.keys(ey).length>0?Object.entries(ey).map(t=>{let[r,a]=t;return(0,s.jsxs)("button",{onClick:async()=>{try{await fetch("/api/project-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:b,managerId:r})}),eb(),y(null)}catch(e){console.error("Error assigning project manager:",e),G.ZP.error("Failed to assign project manager")}},className:"jsx-19280ab6560fe750 "+"w-full px-3 py-2 text-left text-sm flex items-center justify-between hover:bg-gray-50 ".concat(e===r?"bg-gray-50":""),children:[(0,s.jsxs)("span",{className:"jsx-19280ab6560fe750 flex items-center space-x-2",children:[(0,s.jsx)("span",{style:{backgroundColor:a.color},className:"jsx-19280ab6560fe750 w-3 h-3 rounded-full inline-block"}),(0,s.jsx)("span",{className:"jsx-19280ab6560fe750",children:a.name})]}),e===r&&(0,s.jsx)(V.Z,{className:"h-4 w-4 text-green-600"})]},r)}):Y.map(t=>(0,s.jsxs)("button",{onClick:()=>{let e={...X,[b]:t.id};K(e),localStorage.setItem("projectAssignments",JSON.stringify(e)),y(null)},className:"jsx-19280ab6560fe750 "+"w-full px-3 py-2 text-left text-sm flex items-center justify-between hover:bg-gray-50 ".concat(e===t.id?"bg-gray-50":""),children:[(0,s.jsxs)("span",{className:"jsx-19280ab6560fe750 flex items-center space-x-2",children:[(0,s.jsx)("span",{style:{backgroundColor:t.color},className:"jsx-19280ab6560fe750 w-3 h-3 rounded-full inline-block"}),(0,s.jsx)("span",{className:"jsx-19280ab6560fe750",children:t.name})]}),e===t.id&&(0,s.jsx)(V.Z,{className:"h-4 w-4 text-green-600"})]},t.id))})()}):(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 py-2 text-xs text-gray-400 italic",children:"No project managers available"})]}),((null==ej?void 0:ej[b])||X[b])&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 my-1 border-t border-gray-200"}),(0,s.jsxs)("button",{onClick:async()=>{try{await fetch("/api/project-assignments",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:b})}),eb(),y(null)}catch(e){console.error("Error removing project manager:",e),G.ZP.error("Failed to remove project manager")}},className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm text-orange-600 hover:bg-orange-50 flex items-center",children:[(0,s.jsx)(H.Z,{className:"h-4 w-4 mr-2"}),"Remove Manager"]})]}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 my-1 border-t border-gray-200"}),(0,s.jsxs)("button",{onClick:()=>e3(b),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center",children:[(0,s.jsx)(J.Z,{className:"h-4 w-4 mr-2"}),"Close Project"]})]}),S&&k&&(0,s.jsxs)("div",{ref:I,"data-dropdown":"true",style:{left:"".concat(k.x,"px"),top:"".concat(k.y,"px"),pointerEvents:"auto"},className:"jsx-19280ab6560fe750 fixed bg-white border border-gray-200 rounded-lg shadow-xl z-[9999] min-w-[200px] py-2 backdrop-blur-sm",children:[(()=>{let e=e6(S.projectId,S.month);return(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 py-1",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 pb-1 text-[11px] font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),["Confirmed","Estimate","Billed","Other"].map(t=>(0,s.jsxs)("button",{onClick:()=>tt(t),className:"jsx-19280ab6560fe750 "+"w-full px-3 py-2 text-left text-sm flex items-center justify-between hover:bg-gray-50 ".concat(e===t?"bg-gray-50":""),children:[(0,s.jsx)("span",{className:"jsx-19280ab6560fe750",children:t}),e===t&&(0,s.jsx)(V.Z,{className:"h-4 w-4 text-green-600"})]},t)),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 my-1 border-t border-gray-200"}),(0,s.jsx)("button",{onClick:()=>tt("Clear"),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50",children:"Clear"})]})})(),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 py-1",children:[(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 px-3 pb-1 text-[11px] font-medium text-gray-500 uppercase tracking-wider",children:"Comment"}),(0,s.jsx)("button",{onClick:()=>tt(e2(S.projectId,S.month)?"EditComment":"AddComment"),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm hover:bg-gray-50",children:e2(S.projectId,S.month)?"Edit Comment":"Add Comment"}),e2(S.projectId,S.month)&&(0,s.jsx)("button",{onClick:()=>tt("RemoveComment"),className:"jsx-19280ab6560fe750 w-full px-3 py-2 text-left text-sm hover:bg-gray-50",children:"Remove Comment"})]})]}),E&&F&&(0,s.jsxs)("div",{ref:eL,style:{left:"".concat(F.x,"px"),top:"".concat(F.y,"px"),pointerEvents:"auto"},className:"jsx-19280ab6560fe750 fixed bg-white border border-gray-200 rounded-md shadow-lg z-[9999] min-w-[300px] max-w-md comment-modal",children:[(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 px-4 py-3 border-b border-gray-200 flex justify-between items-center",children:[(0,s.jsx)("h3",{className:"jsx-19280ab6560fe750 text-lg font-medium text-gray-900",children:"Edit Comment"}),(0,s.jsx)("button",{onClick:()=>{A(null),O(""),D(null)},className:"jsx-19280ab6560fe750 text-gray-400 hover:text-gray-600",children:(0,s.jsx)(J.Z,{className:"h-5 w-5"})})]}),(0,s.jsx)("div",{className:"jsx-19280ab6560fe750 p-4",children:(0,s.jsx)("textarea",{value:T,onChange:e=>O(e.target.value),rows:4,autoFocus:!0,className:"jsx-19280ab6560fe750 w-full px-2 py-1 border border-gray-300 rounded text-sm"})}),(0,s.jsxs)("div",{className:"jsx-19280ab6560fe750 px-4 py-3 border-t border-gray-200 flex justify-end",children:[(0,s.jsx)("button",{onClick:async()=>{let{projectId:e,month:t}=E,r=T.trim();try{r?await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,comment:r})}):await fetch("/api/comments",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t})}),eg(),A(null),O(""),D(null)}catch(e){console.error("Error saving comment:",e),G.ZP.error("Failed to save comment")}},className:"jsx-19280ab6560fe750 px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-md",children:"Save Comment"}),(0,s.jsx)("button",{onClick:()=>{A(null),O(""),D(null)},className:"jsx-19280ab6560fe750 ml-2 px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md",children:"Cancel"})]})]}),(0,s.jsx)(B(),{id:"19280ab6560fe750",children:".table-container.jsx-19280ab6560fe750{position:relative;overflow:hidden}.sticky-header.jsx-19280ab6560fe750{position:-webkit-sticky;position:sticky;top:0;z-index:40;background:inherit;overflow:hidden}.sticky-column.jsx-19280ab6560fe750{position:-webkit-sticky;position:sticky;left:0;z-index:30;background:white;overflow:hidden}.scrolled-horizontal.jsx-19280ab6560fe750{-webkit-box-shadow:inset -10px 0 8px -8px rgba(0,0,0,.1);-moz-box-shadow:inset -10px 0 8px -8px rgba(0,0,0,.1);box-shadow:inset -10px 0 8px -8px rgba(0,0,0,.1)}.hide-scrollbar.jsx-19280ab6560fe750::-webkit-scrollbar{display:none}.hide-scrollbar.jsx-19280ab6560fe750{-ms-overflow-style:none;scrollbar-width:none}.hide-horizontal-scrollbar.jsx-19280ab6560fe750{overflow-x:hidden!important}.body-wrapper.jsx-19280ab6560fe750{scrollbar-gutter:stable}.scrollable-header.jsx-19280ab6560fe750,.scrollable-footer.jsx-19280ab6560fe750{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}.header-flex.jsx-19280ab6560fe750,.footer-flex.jsx-19280ab6560fe750{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}.scrollable-outer.jsx-19280ab6560fe750{scrollbar-gutter:stable}"})]})}function er(){let{user:e,loading:t}=(0,o.a)(),{isMigrating:r,isMigrated:d,hasLocalData:m,migrateData:u}=(0,n.c)(),x=(0,l.useRouter)(),[h,g]=(0,a.useState)([]),[p,j]=(0,a.useState)([]),[b,y]=(0,a.useState)([]),[N,w]=(0,a.useState)(!1),[S,C]=(0,a.useState)(null),[P,I]=(0,a.useState)({}),[E,A]=(0,a.useState)(null),[T,O]=(0,a.useState)(new Set),[F,D]=(0,a.useState)([]),[Z,M]=(0,a.useState)(!1),[B,L]=(0,a.useState)({}),[z,_]=(0,a.useState)({}),[U,J]=(0,a.useState)(null);(0,a.useEffect)(()=>{if(!t&&!e){x.push("/login");return}if(!t&&e&&!e.isBasic){x.push("/unauthorized");return}},[e,t,x]),(0,a.useEffect)(()=>{!m||d||r||(console.log("Dashboard: Found localStorage data, starting migration"),u())},[m,d,r,u]),(0,a.useEffect)(()=>{console.log("Dashboard: useEffect triggered - user:",!!e,"isBasic:",null==e?void 0:e.isBasic,"loading:",t),e&&e.isBasic?(console.log("Dashboard: User authenticated and authorized, fetching data"),V()):console.log("Dashboard: User not authenticated or not authorized:",{user:!!e,isBasic:null==e?void 0:e.isBasic,loading:t})},[e]),(0,a.useEffect)(()=>{let e=()=>{A(c.VC.getAutoRefreshStatus())};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[]),(0,a.useEffect)(()=>{let t=async()=>{try{let[e,t]=await Promise.all([fetch("/api/projections"),fetch("/api/statuses")]);if(e.ok){let t=await e.json();L(t)}if(t.ok){let e=await t.json();_(e)}}catch(e){console.error("Error fetching database data:",e)}};e&&e.isBasic&&t()},[e]),(0,a.useEffect)(()=>{if(h.length>0||p.length>0){console.log("Dashboard: Processing data - projects:",h.length,"invoices:",p.length),console.log("Dashboard: User state:",{user:!!e,isBasic:null==e?void 0:e.isBasic,loading:t});let r=(0,i.K0)(h);I(r);let s=(0,i.ab)(h,p,r);console.log("Dashboard: Processed billing data:",s.length),console.log("Dashboard: First processed item:",s[0]),console.log("Dashboard: Projections initialized:",Object.keys(r).length),y(s)}else console.log("Dashboard: No projects or invoices to process"),console.log("Dashboard: Projects length:",h.length),console.log("Dashboard: Invoices length:",p.length)},[h,p,e,t]),(0,a.useEffect)(()=>{b.length>0&&J((0,i.fc)(b,T,B,z))},[b,T,B,z]),(0,a.useEffect)(()=>{e&&e.isBasic&&H()},[e]),(0,a.useEffect)(()=>{b.length>0&&F.length>0&&(console.log("Dashboard: Enhancing billing data with Clockify data"),y((0,i.sJ)(b,F)),M(!0))},[b,F]);let H=async()=>{try{console.log("Dashboard: Fetching Clockify data...");let e=new Date;e.setMonth(e.getMonth()-12);let t=new Date,r=await fetch("/api/clockify?action=time-summaries&startDate=".concat(e.toISOString().split("T")[0],"&endDate=").concat(t.toISOString().split("T")[0])),s=await r.json();s.timeSummaries?(D(s.timeSummaries),console.log("Dashboard: Clockify data fetched:",s.timeSummaries.length)):(console.error("Dashboard: Invalid Clockify response structure:",s),D([]))}catch(e){console.error("Dashboard: Error fetching Clockify data:",e),D([])}},V=async()=>{console.log("Dashboard: Starting fetchData"),console.log("Dashboard: User state during fetch:",{user:!!e,isBasic:null==e?void 0:e.isBasic,loading:t}),w(!0);try{let[e,t]=await Promise.all([(0,c.bl)(),(0,c.WM)()]);console.log("Dashboard: API responses - projects:",null==e?void 0:e.length,"invoices:",null==t?void 0:t.length),g(e||[]),j(t||[]),C({fromCache:!1,changes:null})}catch(e){console.error("Error fetching data:",e),g([]),j([])}finally{w(!1)}};return r?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Migrating data to database..."}),(0,s.jsx)("p",{className:"mt-2 text-sm text-gray-500",children:"This may take a few moments"})]})}):t?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Checking authentication..."})]})}):e&&e.isBasic?N?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading data..."})]})}):(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,s.jsx)(f,{cacheInfo:S,autoRefreshStatus:E}),(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[Z&&U?(0,s.jsx)(k,{stats:U}):(0,s.jsx)(v,{billingData:b,closedProjects:T,stats:U}),(0,s.jsx)("div",{className:"mt-8",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Billing Overview"}),(0,s.jsx)(R,{billingData:b,closedProjects:T})]})}),(0,s.jsx)("div",{className:"mt-8",children:(0,s.jsx)(et,{billingData:b,projections:P,onUpdateProjections:e=>{I(e)},closedProjects:T,onClosedProjectsChange:O,useDB:!0})})]})]}):null}},90483:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return f},a:function(){return p}});var s=r(57437),a=r(2265),l=r(96244),o=r(40257);let n="72ed6933-6bc6-430e-a75a-cb5d2e1c20e1",i="e4748cdc-321b-4db0-bc36-141b121a9117";n&&i||(console.warn("Azure AD environment variables are not set. Authentication will not work."),console.warn("Please set NEXT_PUBLIC_AZURE_AD_CLIENT_ID and NEXT_PUBLIC_AZURE_AD_TENANT_ID in your .env.local file"));let c={auth:{clientId:n||"dummy-client-id",authority:"https://login.microsoftonline.com/".concat(i||"dummy-tenant-id"),redirectUri:window.location.origin},cache:{cacheLocation:"sessionStorage",storeAuthStateInCookie:!1}},d=new l.Lx(c),m={scopes:["User.Read","Directory.Read.All"]};async function u(){try{if(!n||!i)throw Error("Azure AD environment variables are not configured. Please set NEXT_PUBLIC_AZURE_AD_CLIENT_ID and NEXT_PUBLIC_AZURE_AD_TENANT_ID in your .env.local file");return await d.loginRedirect(m),null}catch(e){throw console.error("Sign in error:",e),e}}async function x(){try{await d.logoutPopup()}catch(e){console.error("Sign out error:",e)}}async function h(){try{var e,t,r,s,a;let l=d.getActiveAccount();if(!l)return null;let n=await d.acquireTokenSilent({scopes:["User.Read","Directory.Read.All"]}),i=await fetch("https://graph.microsoft.com/v1.0/me",{headers:{Authorization:"Bearer ".concat(n.accessToken)}});if(!i.ok)throw Error("Failed to fetch user details");let c=await i.json(),m=(null===(e=o.env.NEXT_PUBLIC_ADMIN_EMAILS)||void 0===e?void 0:e.split(","))||[],u=m.includes(c.mail)||m.includes(c.userPrincipalName)||(null===(t=c.mail)||void 0===t?void 0:t.endsWith("@collectif.nyc"))||(null===(r=c.mail)||void 0===r?void 0:r.endsWith("@yourcompany.com"));return console.log("Auth Debug:",{userEmail:c.mail,userPrincipalName:c.userPrincipalName,adminEmails:m,isAdmin:u,adminEmailsIncludes:m.includes(c.mail),adminEmailsIncludesPrincipal:m.includes(c.userPrincipalName),endsWithCollectif:null===(s=c.mail)||void 0===s?void 0:s.endsWith("@collectif.nyc"),endsWithLegacy:null===(a=c.mail)||void 0===a?void 0:a.endsWith("@yourcompany.com"),envVar:o.env.NEXT_PUBLIC_ADMIN_EMAILS}),{id:l.localAccountId,name:l.name||"",email:l.username||"",isAdmin:u,isBasic:!0}}catch(t){console.error("Get auth user error:",t);let e=d.getActiveAccount();return console.log("Auth Fallback Debug:",{accountEmail:null==e?void 0:e.username,accountName:null==e?void 0:e.name,isAdmin:!1}),{id:(null==e?void 0:e.localAccountId)||"",name:(null==e?void 0:e.name)||"",email:(null==e?void 0:e.username)||"",isAdmin:!1,isBasic:!0}}}let g=(0,a.createContext)(void 0);function f(e){let{children:t}=e,[r,l]=(0,a.useState)(null),[o,n]=(0,a.useState)(!0);(0,a.useEffect)(()=>{(async()=>{try{await d.initialize();let e=await d.handleRedirectPromise();e&&(console.log("Redirect response received:",e),d.setActiveAccount(e.account));let t=await h();l(t)}catch(e){console.error("Auth initialization error:",e)}finally{n(!1)}})()},[]);let i=async()=>{try{n(!0),await u()}catch(e){console.error("Sign in error:",e),n(!1)}},c=async()=>{try{n(!0),await x(),l(null)}catch(e){console.error("Sign out error:",e)}finally{n(!1)}};return(0,s.jsx)(g.Provider,{value:{user:r,loading:o,signIn:i,signOut:c},children:t})}function p(){let e=(0,a.useContext)(g);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},58091:function(e,t,r){"use strict";r.d(t,{MigrationProvider:function(){return n},c:function(){return i}});var s=r(57437),a=r(2265),l=r(69064);let o=(0,a.createContext)(void 0);function n(e){let{children:t}=e,[r,n]=(0,a.useState)(!1),[i,c]=(0,a.useState)(!1),[d,m]=(0,a.useState)(!1);(0,a.useEffect)(()=>{(()=>{try{if("true"===localStorage.getItem("dataMigrated")||"true"===localStorage.getItem("db_migrated")){c(!0),m(!1);return}let e=localStorage.getItem("monthlyProjections")||localStorage.getItem("signedFees")||localStorage.getItem("asrFees")||localStorage.getItem("monthlyStatuses")||localStorage.getItem("monthlyComments")||localStorage.getItem("closedProjects")||localStorage.getItem("projectAssignments")||localStorage.getItem("projectManagers");m(!!e)}catch(e){console.error("Error checking migration status:",e)}})()},[]);let u=async()=>{if(!r&&!i){n(!0);try{console.log("Starting client-side migration...");let e=JSON.parse(localStorage.getItem("monthlyProjections")||"{}"),t=JSON.parse(localStorage.getItem("monthlyStatuses")||"{}"),r=JSON.parse(localStorage.getItem("monthlyComments")||"{}"),s=JSON.parse(localStorage.getItem("signedFees")||"{}"),a=JSON.parse(localStorage.getItem("asrFees")||"{}"),o=JSON.parse(localStorage.getItem("closedProjects")||"[]"),n=JSON.parse(localStorage.getItem("projectAssignments")||"{}"),i=JSON.parse(localStorage.getItem("projectManagers")||"[]"),d=[];if(Object.keys(e).length>0)for(let[t,r]of Object.entries(e))for(let[e,s]of Object.entries(r))d.push(fetch("/api/projections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,month:e,value:s})}));if(Object.keys(t).length>0)for(let[e,r]of Object.entries(t))for(let[t,s]of Object.entries(r))d.push(fetch("/api/statuses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:t,status:s})}));if(Object.keys(r).length>0)for(let[e,t]of Object.entries(r))for(let[r,s]of Object.entries(t))d.push(fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,month:r,comment:s})}));if(Object.keys(s).length>0)for(let[e,t]of Object.entries(s))d.push(fetch("/api/signed-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,value:t})}));if(Object.keys(a).length>0)for(let[e,t]of Object.entries(a))d.push(fetch("/api/asr-fees",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,value:t})}));if(o.length>0)for(let e of o)d.push(fetch("/api/closed-projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e})}));if(Object.keys(n).length>0)for(let[e,t]of Object.entries(n))d.push(fetch("/api/project-assignments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:e,managerId:t})}));if(i.length>0)for(let e of i)d.push(fetch("/api/project-managers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}));if(d.length>0){let e=(await Promise.allSettled(d)).filter(e=>"rejected"===e.status);if(e.length>0)throw console.error("Some migrations failed:",e),e.some(e=>{var t,r,s,a,l,o;return"rejected"===e.status&&((null===(r=e.reason)||void 0===r?void 0:null===(t=r.message)||void 0===t?void 0:t.includes("Failed to fetch"))||(null===(a=e.reason)||void 0===a?void 0:null===(s=a.message)||void 0===s?void 0:s.includes("connection"))||(null===(o=e.reason)||void 0===o?void 0:null===(l=o.message)||void 0===l?void 0:l.includes("timeout")))})?l.ZP.error("Migration failed: Check database connections. Retrying in 5 seconds...",{duration:5e3}):l.ZP.error("Migration failed: Some data could not be migrated. Retrying in 5 seconds...",{duration:5e3}),Error("Migration failed");console.log("Migration completed successfully"),l.ZP.success("Migration complete")}localStorage.removeItem("monthlyProjections"),localStorage.removeItem("monthlyStatuses"),localStorage.removeItem("monthlyComments"),localStorage.removeItem("signedFees"),localStorage.removeItem("asrFees"),localStorage.removeItem("closedProjects"),localStorage.removeItem("projectAssignments"),localStorage.removeItem("projectManagers"),localStorage.setItem("dataMigrated","true"),localStorage.setItem("db_migrated","true"),c(!0),m(!1)}catch(e){console.error("Migration failed:",e),localStorage.setItem("db_migrated","true"),c(!0),setTimeout(()=>{i||x()},5e3)}finally{n(!1)}}},x=async()=>{c(!1),localStorage.removeItem("db_migrated"),localStorage.removeItem("dataMigrated"),await u()};return(0,s.jsx)(o.Provider,{value:{isMigrating:r,isMigrated:i,hasLocalData:d,migrateData:u,retryMigration:x},children:t})}function i(){let e=(0,a.useContext)(o);if(void 0===e)throw Error("useMigration must be used within a MigrationProvider");return e}}},function(e){e.O(0,[649,648,64,82,354,339,844,837,971,117,744],function(){return e(e.s=78929)}),_N_E=e.O()}]);