"use strict";(()=>{var e={};e.id=321,e.ids=[321],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},87632:(e,o,t)=>{t.r(o),t.d(o,{originalPathname:()=>D,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var r={};t.r(r),t.d(r,{GET:()=>d,dynamic:()=>u});var a=t(49303),n=t(88716),s=t(60670),l=t(87070),i=t(87707),c=t(88403);let u="force-dynamic";async function d(e){try{console.log("\uD83D\uDE80 Homepage Dashboard API called - starting data collection...");let e=new Date,o=e.getFullYear(),t=new Date(o,0,1),r=new Date(o-1,0,1),a=new Date(2024,0,1);console.log("\uD83D\uDCC5 Date ranges calculated:",{currentYear:o,currentYearStart:t.toISOString(),lastYearStart:r.toISOString(),extendedStartDate:a.toISOString()});let n=[],s=[],u=null,d=null,p=!1,f=0;try{if(console.log("\uD83D\uDD04 Starting Zoho data fetch..."),f++,n=await i.VC.getProjects(),f++,s=await i.VC.getInvoices(),console.log("‚úÖ Zoho data fetched:",{projectsCount:n.length,invoicesCount:s.length}),s.length>0){console.log("\uD83D\uDCCA Raw invoice data analysis:"),console.log(`  - Total invoices: ${s.length}`);let e=s.reduce((e,o)=>(e[o.status]=(e[o.status]||0)+1,e),{});console.log("  - Status breakdown:",e);let o=s.reduce((e,o)=>(e[o.project_id]=(e[o.project_id]||0)+1,e),{});console.log(`  - Projects with invoices: ${Object.keys(o).length}`);let t=s.reduce((e,o)=>e+(o.amount||0),0),r=t/s.length;console.log(`  - Total amount: $${t.toFixed(2)}`),console.log(`  - Average amount: $${r.toFixed(2)}`);let a=s[0];console.log("  - Sample invoice:",{id:a.invoice_id,number:a.invoice_number,project:a.project_id,amount:a.amount,status:a.status,date:a.date})}else console.log("‚ö†Ô∏è No invoices found in Zoho data");try{console.log("\uD83D\uDCB0 Fetching financial metrics..."),console.log("\uD83D\uDCC5 Date range:",{start:t.toISOString().split("T")[0],end:e.toISOString().split("T")[0]}),f++,d=await i.VC.getFinancialMetrics(t.toISOString().split("T")[0],e.toISOString().split("T")[0]),console.log("‚úÖ Financial metrics loaded:",d),console.log("\uD83D\uDCCA Full financialMetrics object:",JSON.stringify(d,null,2)),d?.operatingIncome===0&&d?.revenue===0&&(console.warn("‚ö†Ô∏è Financial metrics returned all zeros - this might indicate an issue"),console.warn("   - Check if Zoho Books has financial data for the date range"),console.warn("   - Verify OAuth scopes include ZohoBooks.reports.READ"),console.warn("   - Check if Reports module is enabled in your Zoho Books account")),d?.cashFlow===0&&console.warn("‚ö†Ô∏è Cash Flow is 0 - verify data in Zoho for date range")}catch(e){(console.error("‚ùå Failed to fetch financial metrics:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",status:"object"==typeof e&&null!==e&&"response"in e?e.response?.status:void 0,statusText:"object"==typeof e&&null!==e&&"response"in e?e.response?.statusText:void 0,data:"object"==typeof e&&null!==e&&"response"in e?e.response?.data:void 0,stack:e instanceof Error?e.stack:void 0}),"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===404)?console.error("\uD83D\uDD0D 404 Error: Reports endpoints not found. Check if your Zoho Books plan includes financial reporting."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===401?console.error("\uD83D\uDD10 401 Error: Authentication failed. Check OAuth scopes and token validity."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===403?console.error("\uD83D\uDEAB 403 Error: Access forbidden. Check if Reports module is enabled in your Zoho Books account."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===429&&console.error("‚è∞ 429 Error: Rate limited. Zoho API rate limits exceeded."),d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}}catch(e){if(console.error("‚ùå Failed to fetch Zoho data:",e),e instanceof Error){let o=e.message.toLowerCase();(o.includes("rate limit")||o.includes("authentication")||o.includes("token"))&&(p=!0,console.warn("‚ö†Ô∏è Zoho authentication failed due to rate limits or token issues. Showing partial data."))}n=[],s=[],d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log(`üìä Zoho API calls made in this request: ${f}`);try{console.log("\uD83D\uDD04 Starting Clockify data fetch..."),console.log("\uD83D\uDD11 Environment check - CLOCKIFY_API_KEY:",process.env.CLOCKIFY_API_KEY?"‚úÖ Set":"‚ùå Missing"),console.log("\uD83D\uDD11 Environment check - CLOCKIFY_WORKSPACE_ID:",process.env.CLOCKIFY_WORKSPACE_ID?"‚úÖ Set":"‚ùå Missing");let o=c.ZP.getConfigurationStatus();if(console.log("\uD83D\uDCCB Clockify config status:",o),o.configured){console.log("‚è∞ Clockify configured, fetching real data...");let[o,t,r]=await Promise.all([c.ZP.getUser(),c.ZP.getProjects(),c.ZP.getAllTimeEntries(a.toISOString(),e.toISOString())]);console.log("\uD83D\uDCCA Clockify raw data received:",{user:o?.name||"Unknown",projectsCount:t?.length||0,timeEntriesCount:r?.length||0});let s=r.reduce((e,o)=>{let t=o.timeInterval?.duration||"PT0H",r=g(t);return e+r},0),l=r.filter(e=>e.billable).reduce((e,o)=>{let t=o.timeInterval?.duration||"PT0H",r=g(t);return e+r},0),i=r.filter(e=>e.billable),d=125;i.length>0&&(d=i.reduce((e,o)=>{let t="object"==typeof o.hourlyRate?o.hourlyRate.amount:o.hourlyRate||150;return e+t},0)/i.length),u={totalHours:s,billableHours:l,nonBillableHours:s-l,efficiency:s>0?l/s:.85,averageHourlyRate:d,totalTimeValue:l*d,averageHoursPerProject:n.length>0?s/n.length:0},console.log("‚úÖ Clockify data calculated:",u),console.log("\uD83D\uDCCA Clockify billing calculations:",{billableHours:u.billableHours,averageHourlyRate:u.averageHourlyRate,totalTimeValue:u.totalTimeValue,calculatedBilled:u.billableHours*u.averageHourlyRate*.7,calculatedUnbilled:u.billableHours*u.averageHourlyRate*.3})}else console.log("\uD83C\uDFAD Clockify not configured, using mock data"),u={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}catch(e){console.warn("‚ö†Ô∏è Failed to fetch Clockify data, using defaults:",e),console.error("Clockify error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),u={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}let h=n.filter(e=>"active"===e.status)||[],m=n.length||0,D=s.filter(e=>"paid"===e.status)||[],y=s.filter(e=>"sent"===e.status||"viewed"===e.status)||[],v=D.reduce((e,o)=>e+(o.total||0),0),b=y.reduce((e,o)=>e+(o.total||0),0),C=0,P=0;if(u&&u.totalHours>0){let e=u.billableHours*u.averageHourlyRate;u.totalHours>0&&(C=.7*e,P=.3*e)}let k=Math.max(v,C)||v,j=Math.max(b,P)||b;console.log("\uD83D\uDCB0 Final billing calculations:",{zohoTotalBilled:v,zohoTotalUnbilled:b,clockifyTotalBilled:C,clockifyTotalUnbilled:P,finalTotalBilled:k,finalTotalUnbilled:j}),console.log("\uD83D\uDCCA Zoho Books financial data:",{revenue:d?.revenue,expenses:d?.expenses,operatingIncome:d?.operatingIncome,grossProfit:d?.grossProfit,netProfit:d?.netProfit,cashFlow:d?.cashFlow});let w=d?.revenue||k,S=d?.expenses||0,H=d?.operatingIncome||0,x=d?.grossProfit||0,I=d?.netProfit||0,A=d?.cashFlow||0;!d?.revenue&&u&&u.totalTimeValue>0&&(w=u.totalTimeValue);let E=[];try{Array.isArray(n)&&n.length>0&&(E=n.filter(e=>"active"===e.status).sort((e,o)=>{let t=s.filter(o=>o.project_id===e.project_id).reduce((e,o)=>e+(o.total||0),0);return s.filter(e=>e.project_id===o.project_id).reduce((e,o)=>e+(o.total||0),0)-t}).slice(0,5).map(e=>e.project_code||e.project_name||"Unknown Project").filter(Boolean))}catch(e){console.warn("‚ö†Ô∏è Error calculating top performing projects, using defaults:",e),E=["Project A","Project B","Project C"]}let F={totalProjects:m||0,totalBilled:k||0,totalUnbilled:j||0,activeProjects:h.length||0,totalHours:u?.totalHours||0,billableHours:u?.billableHours||0,efficiency:u?.efficiency||.85,averageHourlyRate:u?.averageHourlyRate||125,totalTimeValue:u?.totalTimeValue||0,averageHoursPerProject:u?.averageHoursPerProject||0,topPerformingProjects:Array.isArray(E)?E:[],ytdRevenue:w||0,ytdExpenses:S||0,ytdProfit:(w||0)-(S||0),ytdOperatingIncome:H||0,ytdGrossProfit:x||0,ytdNetProfit:I||0,ytdCashFlow:A||0,warnings:p?["Zoho authentication failed due to rate limits. Showing partial data."]:[],zohoApiCallCount:f};return console.log("‚úÖ Homepage dashboard data generated:",F),console.log("\uD83D\uDE80 Returning dashboard data to client..."),l.NextResponse.json(F)}catch(e){return console.error("‚ùå Homepage Dashboard API error:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,timestamp:new Date().toISOString()}),l.NextResponse.json({error:"Failed to generate homepage dashboard data",details:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}function g(e){if(!e)return 0;let o=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return o?parseInt(o[1]||"0")+parseInt(o[2]||"0")/60+parseInt(o[3]||"0")/3600:0}let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/homepage-dashboard/route",pathname:"/api/homepage-dashboard",filename:"route",bundlePath:"app/api/homepage-dashboard/route"},resolvedPagePath:"C:\\Users\\Jonathan\\Desktop\\Billing\\app\\api\\homepage-dashboard\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:m}=p,D="/api/homepage-dashboard/route";function y(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}}};var o=require("../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),r=o.X(0,[9276,5972,8918,7707,8403],()=>t(87632));module.exports=r})();