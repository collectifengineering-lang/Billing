"use strict";(()=>{var e={};e.id=321,e.ids=[321],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},87632:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>v,patchFetch:()=>b,requestAsyncStorage:()=>D,routeModule:()=>m,serverHooks:()=>C,staticGenerationAsyncStorage:()=>y});var a={};o.r(a),o.d(a,{GET:()=>p,dynamic:()=>d,maxDuration:()=>g});var r=o(49303),n=o(88716),l=o(60670),s=o(87070),i=o(87707),c=o(88403),u=o(60137);let d="force-dynamic",g=30;async function p(e){try{console.log("\uD83D\uDE80 Homepage Dashboard API called - starting data collection...");let e="homepage-dashboard-data",t=u.$.get(e);if(t)return console.log("✅ Returning cached dashboard data"),s.NextResponse.json(t);console.log("❌ No cache found, fetching fresh data...");let o=new Date,a=o.getFullYear(),r=new Date(a,0,1),n=new Date(a-1,0,1),l=new Date(2024,0,1);console.log("\uD83D\uDCC5 Date ranges calculated:",{currentYear:a,currentYearStart:r.toISOString(),lastYearStart:n.toISOString(),extendedStartDate:l.toISOString()});let d=[],g=[],p=null,m=null,D=!1,y=0;try{console.log("\uD83D\uDD04 Starting Zoho data fetch...");let e=Promise.all([f(i.VC.getProjects(),15e3,"Zoho getProjects() timed out after 15 seconds"),f(i.VC.getInvoices(),15e3,"Zoho getInvoices() timed out after 15 seconds")]);if([d,g]=await e,y+=2,console.log("✅ Zoho data fetched:",{projectsCount:d.length,invoicesCount:g.length}),g.length>0){console.log("\uD83D\uDCCA Raw invoice data analysis:"),console.log(`  - Total invoices: ${g.length}`);let e=g.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});console.log("  - Status breakdown:",e);let t=g.reduce((e,t)=>(e[t.project_id]=(e[t.project_id]||0)+1,e),{});console.log(`  - Projects with invoices: ${Object.keys(t).length}`);let o=g.reduce((e,t)=>e+(t.amount||0),0),a=o/g.length;console.log(`  - Total amount: $${o.toFixed(2)}`),console.log(`  - Average amount: $${a.toFixed(2)}`);let r=g[0];console.log("  - Sample invoice:",{id:r.invoice_id,number:r.invoice_number,project:r.project_id,amount:r.amount,status:r.status,date:r.date})}else console.log("⚠️ No invoices found in Zoho data");try{console.log("\uD83D\uDCB0 Fetching financial metrics..."),console.log("\uD83D\uDCC5 Date range:",{start:r.toISOString().split("T")[0],end:o.toISOString().split("T")[0]}),y++,m=await f(i.VC.getFinancialMetrics(r.toISOString().split("T")[0],o.toISOString().split("T")[0]),1e4,"Zoho getFinancialMetrics() timed out after 10 seconds"),console.log("✅ Financial metrics loaded:",m),console.log("\uD83D\uDCCA Full financialMetrics object:",JSON.stringify(m,null,2)),m?.operatingIncome===0&&m?.revenue===0&&(console.warn("⚠️ Financial metrics returned all zeros - this might indicate an issue"),console.warn("   - Check if Zoho Books has financial data for the date range"),console.warn("   - Verify OAuth scopes include ZohoBooks.reports.READ"),console.warn("   - Check if Reports module is enabled in your Zoho Books account")),m?.cashFlow===0&&console.warn("⚠️ Cash Flow is 0 - verify data in Zoho for date range")}catch(e){(console.error("❌ Failed to fetch financial metrics:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",status:"object"==typeof e&&null!==e&&"response"in e?e.response?.status:void 0,statusText:"object"==typeof e&&null!==e&&"response"in e?e.response?.statusText:void 0,data:"object"==typeof e&&null!==e&&"response"in e?e.response?.data:void 0,stack:e instanceof Error?e.stack:void 0}),"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===404)?console.error("\uD83D\uDD0D 404 Error: Reports endpoints not found. Check if your Zoho Books plan includes financial reporting."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===401?console.error("\uD83D\uDD10 401 Error: Authentication failed. Check OAuth scopes and token validity."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===403?console.error("\uD83D\uDEAB 403 Error: Access forbidden. Check if Reports module is enabled in your Zoho Books account."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===429&&console.error("⏰ 429 Error: Rate limited. Zoho API rate limits exceeded."),m={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}}catch(e){if(console.error("❌ Failed to fetch Zoho data:",e),e instanceof Error){let t=e.message.toLowerCase();(t.includes("rate limit")||t.includes("authentication")||t.includes("token"))&&(D=!0,console.warn("⚠️ Zoho authentication failed due to rate limits or token issues. Showing partial data."))}d=[],g=[],m={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log(`📊 Zoho API calls made in this request: ${y}`);try{console.log("\uD83D\uDD04 Starting Clockify data fetch..."),console.log("\uD83D\uDD11 Environment check - CLOCKIFY_API_KEY:",process.env.CLOCKIFY_API_KEY?"✅ Set":"❌ Missing"),console.log("\uD83D\uDD11 Environment check - CLOCKIFY_WORKSPACE_ID:",process.env.CLOCKIFY_WORKSPACE_ID?"✅ Set":"❌ Missing");let e=c.ZP.getConfigurationStatus();if(console.log("\uD83D\uDCCB Clockify config status:",e),e.configured){console.log("⏰ Clockify configured, fetching real data...");let[e,t,a]=await Promise.all([f(c.ZP.getUser(),1e4,"Clockify getUser() timed out after 10 seconds"),f(c.ZP.getProjects(),1e4,"Clockify getProjects() timed out after 10 seconds"),f(c.ZP.getAllTimeEntries(l.toISOString(),o.toISOString()),1e4,"Clockify getAllTimeEntries() timed out after 10 seconds")]);console.log("\uD83D\uDCCA Clockify raw data received:",{user:e?.name||"Unknown",projectsCount:t?.length||0,timeEntriesCount:a?.length||0});let r=new Set(a.map(e=>e.userId||e.userName).filter(Boolean));console.log("\uD83D\uDC65 Unique users in time entries:",{count:r.size,users:Array.from(r)});let n=a.reduce((e,t)=>{let o=t.timeInterval?.duration||"PT0H",a=h(o);return e+a},0),s=a.filter(e=>e.billable).reduce((e,t)=>{let o=t.timeInterval?.duration||"PT0H",a=h(o);return e+a},0),i=a.filter(e=>e.billable),u=125;i.length>0&&(u=i.reduce((e,t)=>{let o="object"==typeof t.hourlyRate?t.hourlyRate.amount:t.hourlyRate||150;return e+o},0)/i.length),p={totalHours:n,billableHours:s,nonBillableHours:n-s,efficiency:n>0?s/n:.85,averageHourlyRate:u,totalTimeValue:s*u,averageHoursPerProject:d.length>0?n/d.length:0},console.log("✅ Clockify data calculated:",p),console.log("\uD83D\uDCCA Clockify billing calculations:",{billableHours:p.billableHours,averageHourlyRate:p.averageHourlyRate,totalTimeValue:p.totalTimeValue,calculatedBilled:p.billableHours*p.averageHourlyRate*.7,calculatedUnbilled:p.billableHours*p.averageHourlyRate*.3})}else console.log("\uD83C\uDFAD Clockify not configured, using mock data"),p={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}catch(e){console.warn("⚠️ Failed to fetch Clockify data, using defaults:",e),console.error("Clockify error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),p={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}let C=d.filter(e=>"active"===e.status)||[],v=d.length||0,b=g.filter(e=>{let t=new Date(e.date);return t>=r&&t<=o}),P=b.filter(e=>"paid"===e.status)||[],I=b.filter(e=>"sent"===e.status||"viewed"===e.status||"draft"===e.status||"overdue"===e.status)||[],w=P.reduce((e,t)=>e+(parseFloat(t.total)||0),0),k=b.filter(e=>"void"!==e.status&&"draft"!==e.status).reduce((e,t)=>e+(parseFloat(t.total)||0),0),S=I.reduce((e,t)=>e+(parseFloat(t.balance)||0),0);console.log("\uD83D\uDCB0 YTD Billing calculations:",{ytdInvoicesCount:b.length,paidInvoicesCount:P.length,outstandingInvoicesCount:I.length,cashBasis:w,accrualBasis:k,unbilled:S,totalInvoices:g.length}),console.log("\uD83D\uDD0D Sample invoice totals for debugging:",b.slice(0,5).map(e=>({number:e.invoice_number,total:e.total,parsed:parseFloat(e.total),type:typeof e.total})));let j=0,x=0;if(p&&p.totalHours>0){let e=p.billableHours*p.averageHourlyRate;p.totalHours>0&&(j=.7*e,x=.3*e)}let A=k>0?k:j,T=S>0?S:x,E=A>0?A:5e4*v,H=T>0?T:15e3*v;console.log("\uD83D\uDCB0 Final billing calculations:",{zohoTotalBilled:k,zohoTotalUnbilled:S,clockifyTotalBilled:j,clockifyTotalUnbilled:x,finalTotalBilled:E,finalTotalUnbilled:H}),console.log("\uD83D\uDCCA Zoho Books financial data:",{revenue:m?.revenue,expenses:m?.expenses,operatingIncome:m?.operatingIncome,grossProfit:m?.grossProfit,netProfit:m?.netProfit,cashFlow:m?.cashFlow,hasFinancialMetrics:!!m,financialMetricsKeys:m?Object.keys(m):[]}),m?console.log("\uD83D\uDD0D Raw financial metrics response:",JSON.stringify(m,null,2)):console.log("⚠️ No financial metrics data received from Zoho API");let F=E,B=m?.expenses||0;0===B&&F>0&&(B=.35*F,console.log("\uD83D\uDCB0 Estimated expenses from revenue:",{revenue:F,estimatedExpenses:B,estimatedMargin:"65%"}));let R=F;console.log("\uD83D\uDCB0 Operating income calculation:",{method:"Invoice-based (Accrual)",revenue:F,operatingIncome:R,dataSource:"Zoho Invoices API",finalTotalBilled:E,zohoTotalBilled:k,breakdown:{ytdRevenue_equals_finalTotalBilled:F===E,ytdOperatingIncome_equals_ytdRevenue:R===F}});let O=m?.grossProfit||0,_=m?.netProfit||0,Z=m?.cashFlow||0;if(0===O&&F>0&&(O=F-B,console.log("\uD83D\uDCB0 Calculated gross profit from revenue and expenses:",{revenue:F,expenses:B,calculatedGrossProfit:O})),0===_&&O>0){let e=.3*B;_=O-e,console.log("\uD83D\uDCB0 Calculated net profit from gross profit:",{grossProfit:O,estimatedOperatingExpenses:e,calculatedNetProfit:_})}0===Z&&(Z=E-H,console.log("\uD83D\uDCB0 Calculated cash flow from billing data:",{totalBilled:E,totalUnbilled:H,calculatedCashFlow:Z})),0===O&&v>0&&(O=35e3*v),0===_&&v>0&&(_=25e3*v),0===Z&&v>0&&(Z=2e4*v),!m?.revenue&&p&&p.totalTimeValue>0&&(F=p.totalTimeValue);let q=[];try{Array.isArray(d)&&d.length>0&&(q=d.filter(e=>"active"===e.status).sort((e,t)=>{let o=g.filter(t=>t.project_id===e.project_id).reduce((e,t)=>e+(t.total||0),0);return g.filter(e=>e.project_id===t.project_id).reduce((e,t)=>e+(t.total||0),0)-o}).slice(0,5).map(e=>e.project_code||e.project_name||"Unknown Project").filter(Boolean))}catch(e){console.warn("⚠️ Error calculating top performing projects, using defaults:",e),q=["Project A","Project B","Project C"]}let U={totalProjects:v||0,totalBilled:E||0,totalUnbilled:H||0,activeProjects:C.length||0,totalHours:p?.totalHours||0,billableHours:p?.billableHours||0,efficiency:p?.efficiency||.85,averageHourlyRate:p?.averageHourlyRate||125,totalTimeValue:p?.totalTimeValue||0,averageHoursPerProject:p?.averageHoursPerProject||0,topPerformingProjects:Array.isArray(q)?q:[],ytdRevenue:F||0,ytdExpenses:B||0,ytdProfit:(F||0)-(B||0),ytdOperatingIncome:R||0,ytdGrossProfit:O||0,ytdNetProfit:_||0,ytdCashFlow:Z||0,warnings:D?["Zoho authentication failed due to rate limits. Showing partial data."]:[],zohoApiCallCount:y};return console.log("\uD83D\uDCB0 Final Financial Metrics Summary:",{ytdRevenue:F,ytdExpenses:B,ytdOperatingIncome:R,ytdGrossProfit:O,ytdNetProfit:_,ytdCashFlow:Z,totalBilled:E,totalUnbilled:H,totalProjects:v,dataSource:m?"Zoho API":"Calculated/Estimated"}),console.log("✅ Homepage dashboard data generated:",U),console.log("\uD83D\uDE80 Returning dashboard data to client..."),console.log("\uD83D\uDD0D CRITICAL - ytdOperatingIncome being returned:",U.ytdOperatingIncome,"(type:",typeof U.ytdOperatingIncome,")"),u.$.set(e,U,3e5),s.NextResponse.json(U)}catch(t){console.error("❌ Homepage Dashboard API error:",t),console.error("Error details:",{message:t instanceof Error?t.message:"Unknown error",stack:t instanceof Error?t.stack:void 0,timestamp:new Date().toISOString()});let e=u.$.get("homepage-dashboard-data");if(e)return console.warn("⚠️ Returning stale cached data due to error"),s.NextResponse.json({...e,warnings:[...e.warnings||[],"Using cached data due to API error"]});return s.NextResponse.json({error:"Failed to generate homepage dashboard data",details:t instanceof Error?t.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}function h(e){if(!e)return 0;let t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return t?parseInt(t[1]||"0")+parseInt(t[2]||"0")/60+parseInt(t[3]||"0")/3600:0}function f(e,t,o){return Promise.race([e,new Promise((e,a)=>setTimeout(()=>a(Error(o)),t))])}let m=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/homepage-dashboard/route",pathname:"/api/homepage-dashboard",filename:"route",bundlePath:"app/api/homepage-dashboard/route"},resolvedPagePath:"C:\\Users\\Jonathan\\Desktop\\Billing\\app\\api\\homepage-dashboard\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:D,staticGenerationAsyncStorage:y,serverHooks:C}=m,v="/api/homepage-dashboard/route";function b(){return(0,l.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:y})}},60137:(e,t,o)=>{o.d(t,{$:()=>r});class a{constructor(){this.DEFAULT_TTL=3e5,this.cache=new Map,setInterval(()=>this.cleanup(),6e4)}static getInstance(){return a.instance||(a.instance=new a),a.instance}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):(console.log(`✅ Cache HIT for key: ${e}`),t.data):null}set(e,t,o){let a={data:t,timestamp:Date.now(),ttl:o||this.DEFAULT_TTL};this.cache.set(e,a),console.log(`💾 Cache SET for key: ${e} (TTL: ${a.ttl}ms)`)}delete(e){let t=this.cache.delete(e);return t&&console.log(`🗑️ Cache DELETED for key: ${e}`),t}clear(){this.cache.clear(),console.log("\uD83D\uDDD1️ All cache entries CLEARED")}getStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}cleanup(){let e=Date.now(),t=0;for(let[o,a]of this.cache.entries())e-a.timestamp>a.ttl&&(this.cache.delete(o),t++);t>0&&console.log(`🧹 Cleaned up ${t} expired cache entries`)}async getOrSet(e,t,o){let a=this.get(e);if(null!==a)return{data:a,fromCache:!0};console.log(`❌ Cache MISS for key: ${e} - fetching fresh data...`);let r=await t();return this.set(e,r,o),{data:r,fromCache:!1}}}let r=a.getInstance()}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),a=t.X(0,[9276,5972,8918,8403,7707],()=>o(87632));module.exports=a})();