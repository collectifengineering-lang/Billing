"use strict";(()=>{var e={};e.id=321,e.ids=[321],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},87632:(e,o,t)=>{t.r(o),t.d(o,{originalPathname:()=>m,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>D});var r={};t.r(r),t.d(r,{GET:()=>d,dynamic:()=>u});var a=t(49303),l=t(88716),n=t(60670),s=t(87070),i=t(87707),c=t(88403);let u="force-dynamic";async function d(e){try{console.log("\uD83D\uDE80 Homepage Dashboard API called - starting data collection...");let e=new Date,o=e.getFullYear(),t=new Date(o,0,1),r=new Date(o-1,0,1),a=new Date(2024,0,1);console.log("\uD83D\uDCC5 Date ranges calculated:",{currentYear:o,currentYearStart:t.toISOString(),lastYearStart:r.toISOString(),extendedStartDate:a.toISOString()});let l=[],n=[],u=null,d=null,p=!1,f=0;try{if(console.log("\uD83D\uDD04 Starting Zoho data fetch..."),f++,l=await i.VC.getProjects(),f++,n=await i.VC.getInvoices(),console.log("✅ Zoho data fetched:",{projectsCount:l.length,invoicesCount:n.length}),n.length>0){console.log("\uD83D\uDCCA Raw invoice data analysis:"),console.log(`  - Total invoices: ${n.length}`);let e=n.reduce((e,o)=>(e[o.status]=(e[o.status]||0)+1,e),{});console.log("  - Status breakdown:",e);let o=n.reduce((e,o)=>(e[o.project_id]=(e[o.project_id]||0)+1,e),{});console.log(`  - Projects with invoices: ${Object.keys(o).length}`);let t=n.reduce((e,o)=>e+(o.amount||0),0),r=t/n.length;console.log(`  - Total amount: $${t.toFixed(2)}`),console.log(`  - Average amount: $${r.toFixed(2)}`);let a=n[0];console.log("  - Sample invoice:",{id:a.invoice_id,number:a.invoice_number,project:a.project_id,amount:a.amount,status:a.status,date:a.date})}else console.log("⚠️ No invoices found in Zoho data");try{console.log("\uD83D\uDCB0 Fetching financial metrics..."),console.log("\uD83D\uDCC5 Date range:",{start:t.toISOString().split("T")[0],end:e.toISOString().split("T")[0]}),f++,d=await i.VC.getFinancialMetrics(t.toISOString().split("T")[0],e.toISOString().split("T")[0]),console.log("✅ Financial metrics loaded:",d),console.log("\uD83D\uDCCA Full financialMetrics object:",JSON.stringify(d,null,2)),d?.operatingIncome===0&&d?.revenue===0&&(console.warn("⚠️ Financial metrics returned all zeros - this might indicate an issue"),console.warn("   - Check if Zoho Books has financial data for the date range"),console.warn("   - Verify OAuth scopes include ZohoBooks.reports.READ"),console.warn("   - Check if Reports module is enabled in your Zoho Books account")),d?.cashFlow===0&&console.warn("⚠️ Cash Flow is 0 - verify data in Zoho for date range")}catch(e){(console.error("❌ Failed to fetch financial metrics:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",status:"object"==typeof e&&null!==e&&"response"in e?e.response?.status:void 0,statusText:"object"==typeof e&&null!==e&&"response"in e?e.response?.statusText:void 0,data:"object"==typeof e&&null!==e&&"response"in e?e.response?.data:void 0,stack:e instanceof Error?e.stack:void 0}),"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===404)?console.error("\uD83D\uDD0D 404 Error: Reports endpoints not found. Check if your Zoho Books plan includes financial reporting."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===401?console.error("\uD83D\uDD10 401 Error: Authentication failed. Check OAuth scopes and token validity."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===403?console.error("\uD83D\uDEAB 403 Error: Access forbidden. Check if Reports module is enabled in your Zoho Books account."):"object"==typeof e&&null!==e&&"response"in e&&e.response?.status===429&&console.error("⏰ 429 Error: Rate limited. Zoho API rate limits exceeded."),d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}}catch(e){if(console.error("❌ Failed to fetch Zoho data:",e),e instanceof Error){let o=e.message.toLowerCase();(o.includes("rate limit")||o.includes("authentication")||o.includes("token"))&&(p=!0,console.warn("⚠️ Zoho authentication failed due to rate limits or token issues. Showing partial data."))}l=[],n=[],d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log(`📊 Zoho API calls made in this request: ${f}`);try{console.log("\uD83D\uDD04 Starting Clockify data fetch..."),console.log("\uD83D\uDD11 Environment check - CLOCKIFY_API_KEY:",process.env.CLOCKIFY_API_KEY?"✅ Set":"❌ Missing"),console.log("\uD83D\uDD11 Environment check - CLOCKIFY_WORKSPACE_ID:",process.env.CLOCKIFY_WORKSPACE_ID?"✅ Set":"❌ Missing");let o=c.ZP.getConfigurationStatus();if(console.log("\uD83D\uDCCB Clockify config status:",o),o.configured){console.log("⏰ Clockify configured, fetching real data...");let[o,t,r]=await Promise.all([c.ZP.getUser(),c.ZP.getProjects(),c.ZP.getAllTimeEntries(a.toISOString(),e.toISOString())]);console.log("\uD83D\uDCCA Clockify raw data received:",{user:o?.name||"Unknown",projectsCount:t?.length||0,timeEntriesCount:r?.length||0});let n=new Set(r.map(e=>e.userId||e.userName).filter(Boolean));console.log("\uD83D\uDC65 Unique users in time entries:",{count:n.size,users:Array.from(n)});let s=r.reduce((e,o)=>{let t=o.timeInterval?.duration||"PT0H",r=g(t);return e+r},0),i=r.filter(e=>e.billable).reduce((e,o)=>{let t=o.timeInterval?.duration||"PT0H",r=g(t);return e+r},0),d=r.filter(e=>e.billable),p=125;d.length>0&&(p=d.reduce((e,o)=>{let t="object"==typeof o.hourlyRate?o.hourlyRate.amount:o.hourlyRate||150;return e+t},0)/d.length),u={totalHours:s,billableHours:i,nonBillableHours:s-i,efficiency:s>0?i/s:.85,averageHourlyRate:p,totalTimeValue:i*p,averageHoursPerProject:l.length>0?s/l.length:0},console.log("✅ Clockify data calculated:",u),console.log("\uD83D\uDCCA Clockify billing calculations:",{billableHours:u.billableHours,averageHourlyRate:u.averageHourlyRate,totalTimeValue:u.totalTimeValue,calculatedBilled:u.billableHours*u.averageHourlyRate*.7,calculatedUnbilled:u.billableHours*u.averageHourlyRate*.3})}else console.log("\uD83C\uDFAD Clockify not configured, using mock data"),u={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}catch(e){console.warn("⚠️ Failed to fetch Clockify data, using defaults:",e),console.error("Clockify error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),u={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}let D=l.filter(e=>"active"===e.status)||[],h=l.length||0,m=n.filter(o=>{let r=new Date(o.date);return r>=t&&r<=e}),y=m.filter(e=>"paid"===e.status)||[],v=m.filter(e=>"sent"===e.status||"viewed"===e.status||"draft"===e.status||"overdue"===e.status)||[],C=y.reduce((e,o)=>e+(parseFloat(o.total)||0),0),b=m.filter(e=>"void"!==e.status&&"draft"!==e.status).reduce((e,o)=>e+(parseFloat(o.total)||0),0),P=v.reduce((e,o)=>e+(parseFloat(o.balance)||0),0);console.log("\uD83D\uDCB0 YTD Billing calculations:",{ytdInvoicesCount:m.length,paidInvoicesCount:y.length,outstandingInvoicesCount:v.length,cashBasis:C,accrualBasis:b,unbilled:P,totalInvoices:n.length}),console.log("\uD83D\uDD0D Sample invoice totals for debugging:",m.slice(0,5).map(e=>({number:e.invoice_number,total:e.total,parsed:parseFloat(e.total),type:typeof e.total})));let I=0,w=0;if(u&&u.totalHours>0){let e=u.billableHours*u.averageHourlyRate;u.totalHours>0&&(I=.7*e,w=.3*e)}let k=b>0?b:I,S=P>0?P:w,j=k>0?k:5e4*h,x=S>0?S:15e3*h;console.log("\uD83D\uDCB0 Final billing calculations:",{zohoTotalBilled:b,zohoTotalUnbilled:P,clockifyTotalBilled:I,clockifyTotalUnbilled:w,finalTotalBilled:j,finalTotalUnbilled:x}),console.log("\uD83D\uDCCA Zoho Books financial data:",{revenue:d?.revenue,expenses:d?.expenses,operatingIncome:d?.operatingIncome,grossProfit:d?.grossProfit,netProfit:d?.netProfit,cashFlow:d?.cashFlow,hasFinancialMetrics:!!d,financialMetricsKeys:d?Object.keys(d):[]}),d?console.log("\uD83D\uDD0D Raw financial metrics response:",JSON.stringify(d,null,2)):console.log("⚠️ No financial metrics data received from Zoho API");let H=j,A=d?.expenses||0;0===A&&H>0&&(A=.35*H,console.log("\uD83D\uDCB0 Estimated expenses from revenue:",{revenue:H,estimatedExpenses:A,estimatedMargin:"65%"}));let B=H;console.log("\uD83D\uDCB0 Operating income calculation:",{method:"Invoice-based (Accrual)",revenue:H,operatingIncome:B,dataSource:"Zoho Invoices API",finalTotalBilled:j,zohoTotalBilled:b,breakdown:{ytdRevenue_equals_finalTotalBilled:H===j,ytdOperatingIncome_equals_ytdRevenue:B===H}});let F=d?.grossProfit||0,E=d?.netProfit||0,O=d?.cashFlow||0;if(0===F&&H>0&&(F=H-A,console.log("\uD83D\uDCB0 Calculated gross profit from revenue and expenses:",{revenue:H,expenses:A,calculatedGrossProfit:F})),0===E&&F>0){let e=.3*A;E=F-e,console.log("\uD83D\uDCB0 Calculated net profit from gross profit:",{grossProfit:F,estimatedOperatingExpenses:e,calculatedNetProfit:E})}0===O&&(O=j-x,console.log("\uD83D\uDCB0 Calculated cash flow from billing data:",{totalBilled:j,totalUnbilled:x,calculatedCashFlow:O})),0===F&&h>0&&(F=35e3*h),0===E&&h>0&&(E=25e3*h),0===O&&h>0&&(O=2e4*h),!d?.revenue&&u&&u.totalTimeValue>0&&(H=u.totalTimeValue);let R=[];try{Array.isArray(l)&&l.length>0&&(R=l.filter(e=>"active"===e.status).sort((e,o)=>{let t=n.filter(o=>o.project_id===e.project_id).reduce((e,o)=>e+(o.total||0),0);return n.filter(e=>e.project_id===o.project_id).reduce((e,o)=>e+(o.total||0),0)-t}).slice(0,5).map(e=>e.project_code||e.project_name||"Unknown Project").filter(Boolean))}catch(e){console.warn("⚠️ Error calculating top performing projects, using defaults:",e),R=["Project A","Project B","Project C"]}let T={totalProjects:h||0,totalBilled:j||0,totalUnbilled:x||0,activeProjects:D.length||0,totalHours:u?.totalHours||0,billableHours:u?.billableHours||0,efficiency:u?.efficiency||.85,averageHourlyRate:u?.averageHourlyRate||125,totalTimeValue:u?.totalTimeValue||0,averageHoursPerProject:u?.averageHoursPerProject||0,topPerformingProjects:Array.isArray(R)?R:[],ytdRevenue:H||0,ytdExpenses:A||0,ytdProfit:(H||0)-(A||0),ytdOperatingIncome:B||0,ytdGrossProfit:F||0,ytdNetProfit:E||0,ytdCashFlow:O||0,warnings:p?["Zoho authentication failed due to rate limits. Showing partial data."]:[],zohoApiCallCount:f};return console.log("\uD83D\uDCB0 Final Financial Metrics Summary:",{ytdRevenue:H,ytdExpenses:A,ytdOperatingIncome:B,ytdGrossProfit:F,ytdNetProfit:E,ytdCashFlow:O,totalBilled:j,totalUnbilled:x,totalProjects:h,dataSource:d?"Zoho API":"Calculated/Estimated"}),console.log("✅ Homepage dashboard data generated:",T),console.log("\uD83D\uDE80 Returning dashboard data to client..."),console.log("\uD83D\uDD0D CRITICAL - ytdOperatingIncome being returned:",T.ytdOperatingIncome,"(type:",typeof T.ytdOperatingIncome,")"),s.NextResponse.json(T)}catch(e){return console.error("❌ Homepage Dashboard API error:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,timestamp:new Date().toISOString()}),s.NextResponse.json({error:"Failed to generate homepage dashboard data",details:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}function g(e){if(!e)return 0;let o=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return o?parseInt(o[1]||"0")+parseInt(o[2]||"0")/60+parseInt(o[3]||"0")/3600:0}let p=new a.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/homepage-dashboard/route",pathname:"/api/homepage-dashboard",filename:"route",bundlePath:"app/api/homepage-dashboard/route"},resolvedPagePath:"C:\\Users\\Jonathan\\Desktop\\Billing\\app\\api\\homepage-dashboard\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:D,serverHooks:h}=p,m="/api/homepage-dashboard/route";function y(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:D})}}};var o=require("../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),r=o.X(0,[9276,5972,8918,8403,7707],()=>t(87632));module.exports=r})();