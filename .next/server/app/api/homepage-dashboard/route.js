"use strict";(()=>{var e={};e.id=321,e.ids=[321],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},87632:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>v,patchFetch:()=>D,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var r={};o.r(r),o.d(r,{GET:()=>d,dynamic:()=>u});var a=o(49303),n=o(88716),i=o(60670),l=o(87070),s=o(87707),c=o(88403);let u="force-dynamic";async function d(e){try{console.log("\uD83D\uDE80 Homepage Dashboard API called - starting data collection...");let e=new Date,t=e.getFullYear(),o=new Date(t,0,1),r=new Date(t-1,0,1),a=new Date(2024,0,1);console.log("\uD83D\uDCC5 Date ranges calculated:",{currentYear:t,currentYearStart:o.toISOString(),lastYearStart:r.toISOString(),extendedStartDate:a.toISOString()});let n=[],i=[],u=null,d=null,p=!1,h=0;try{if(console.log("\uD83D\uDD04 Starting Zoho data fetch..."),h++,n=await s.VC.getProjects(),h++,i=await s.VC.getInvoices(),console.log("✅ Zoho data fetched:",{projectsCount:n.length,invoicesCount:i.length}),i.length>0){console.log("\uD83D\uDCCA Raw invoice data analysis:"),console.log(`  - Total invoices: ${i.length}`);let e=i.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});console.log("  - Status breakdown:",e);let t=i.reduce((e,t)=>(e[t.project_id]=(e[t.project_id]||0)+1,e),{});console.log(`  - Projects with invoices: ${Object.keys(t).length}`);let o=i.reduce((e,t)=>e+(t.amount||0),0),r=o/i.length;console.log(`  - Total amount: $${o.toFixed(2)}`),console.log(`  - Average amount: $${r.toFixed(2)}`);let a=i[0];console.log("  - Sample invoice:",{id:a.invoice_id,number:a.invoice_number,project:a.project_id,amount:a.amount,status:a.status,date:a.date})}else console.log("⚠️ No invoices found in Zoho data");try{console.log("\uD83D\uDCB0 Fetching financial metrics..."),h++,d=await s.VC.getFinancialMetrics(o.toISOString().split("T")[0],e.toISOString().split("T")[0]),console.log("✅ Financial metrics loaded:",d),console.log("\uD83D\uDCCA Full financialMetrics object:",JSON.stringify(d,null,2)),d?.cashFlow===0&&console.warn("⚠️ Cash Flow is 0 - verify data in Zoho for date range")}catch(e){console.warn("⚠️ Failed to fetch financial metrics, using defaults:",e),d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}}catch(e){if(console.error("❌ Failed to fetch Zoho data:",e),e instanceof Error){let t=e.message.toLowerCase();(t.includes("rate limit")||t.includes("authentication")||t.includes("token"))&&(p=!0,console.warn("⚠️ Zoho authentication failed due to rate limits or token issues. Showing partial data."))}n=[],i=[],d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log(`📊 Zoho API calls made in this request: ${h}`);try{if(console.log("\uD83D\uDD04 Starting Clockify data fetch..."),c.ZP.getConfigurationStatus().configured){console.log("⏰ Clockify configured, fetching real data...");let[t,o,r]=await Promise.all([c.ZP.getUser(),c.ZP.getProjects(),c.ZP.getAllTimeEntries(a.toISOString(),e.toISOString())]);console.log("\uD83D\uDCCA Clockify raw data received:",{user:t?.name||"Unknown",projectsCount:o?.length||0,timeEntriesCount:r?.length||0});let i=r.reduce((e,t)=>{let o=t.timeInterval?.duration||"PT0H",r=g(o);return e+r},0),l=r.filter(e=>e.billable).reduce((e,t)=>{let o=t.timeInterval?.duration||"PT0H",r=g(o);return e+r},0),s=r.filter(e=>e.billable),d=125;s.length>0&&(d=s.reduce((e,t)=>{let o=t.hourlyRate?.amount||150;return e+o},0)/s.length),u={totalHours:i,billableHours:l,nonBillableHours:i-l,efficiency:i>0?l/i:.85,averageHourlyRate:d,totalTimeValue:l*d,averageHoursPerProject:n.length>0?i/n.length:0},console.log("✅ Clockify data calculated:",u)}else console.log("\uD83C\uDFAD Clockify not configured, using mock data"),u={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}catch(e){console.warn("⚠️ Failed to fetch Clockify data, using defaults:",e),console.error("Clockify error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),u={totalHours:28400,billableHours:25200,nonBillableHours:3200,efficiency:.89,averageHourlyRate:125,totalTimeValue:315e4,averageHoursPerProject:70}}let f=n.filter(e=>"active"===e.status)||[],m=n.length||0,v=i.filter(e=>"paid"===e.status)||[],D=i.filter(e=>"sent"===e.status||"viewed"===e.status)||[],P=v.reduce((e,t)=>e+(t.total||0),0),y=D.reduce((e,t)=>e+(t.total||0),0),j=d?.revenue||P,w=d?.expenses||0,b=[];try{Array.isArray(n)&&n.length>0&&(b=n.filter(e=>"active"===e.status).sort((e,t)=>{let o=i.filter(t=>t.project_id===e.project_id).reduce((e,t)=>e+(t.total||0),0);return i.filter(e=>e.project_id===t.project_id).reduce((e,t)=>e+(t.total||0),0)-o}).slice(0,5).map(e=>e.project_code||e.project_name||"Unknown Project").filter(Boolean))}catch(e){console.warn("⚠️ Error calculating top performing projects, using defaults:",e),b=["Project A","Project B","Project C"]}let S={totalProjects:m||0,totalBilled:P||0,totalUnbilled:y||0,activeProjects:f.length||0,totalHours:u?.totalHours||0,billableHours:u?.billableHours||0,efficiency:u?.efficiency||.85,averageHourlyRate:u?.averageHourlyRate||125,totalTimeValue:u?.totalTimeValue||0,averageHoursPerProject:u?.averageHoursPerProject||0,topPerformingProjects:Array.isArray(b)?b:[],ytdRevenue:j||0,ytdExpenses:w||0,ytdProfit:(j||0)-(w||0),warnings:p?["Zoho authentication failed due to rate limits. Showing partial data."]:[],zohoApiCallCount:h};return console.log("✅ Homepage dashboard data generated:",S),console.log("\uD83D\uDE80 Returning dashboard data to client..."),l.NextResponse.json(S)}catch(e){return console.error("❌ Homepage Dashboard API error:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,timestamp:new Date().toISOString()}),l.NextResponse.json({error:"Failed to generate homepage dashboard data",details:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}function g(e){if(!e)return 0;let t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return t?parseInt(t[1]||"0")+parseInt(t[2]||"0")/60+parseInt(t[3]||"0")/3600:0}let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/homepage-dashboard/route",pathname:"/api/homepage-dashboard",filename:"route",bundlePath:"app/api/homepage-dashboard/route"},resolvedPagePath:"C:\\Users\\Jonathan\\Desktop\\Billing\\app\\api\\homepage-dashboard\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:m}=p,v="/api/homepage-dashboard/route";function D(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[9276,5972,9712,7707,8403],()=>o(87632));module.exports=r})();