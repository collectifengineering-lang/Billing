"use strict";(()=>{var e={};e.id=3707,e.ids=[3707],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},5758:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>m,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>D,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{GET:()=>d,dynamic:()=>c});var a=r(49303),n=r(88716),i=r(60670),s=r(87070),l=r(44261),u=r(88403);let c="force-dynamic";async function d(e){try{console.log("\uD83D\uDE80 Dashboard API called - starting optimized data collection...");let e=new Date,t=e.getFullYear(),r=new Date(t,0,1),o=new Date(t-1,0,1),a=new Date(t-2,0,1);console.log("\uD83D\uDCC5 Date ranges calculated:",{currentYear:t,currentYearStart:r.toISOString(),lastYearStart:o.toISOString(),twoYearsAgoStart:a.toISOString()});let n=u.ZP.getConfigurationStatus();console.log("Clockify service configuration:",n),n.configured||console.warn("Clockify service not configured - using mock data for time tracking metrics");let i=[],c=[],d=null,p=null,h=null;console.log("\uD83D\uDD04 Starting optimized Zoho data fetch with caching...");try{console.log("\uD83D\uDCCA Fetching projects and invoices (cached if available)..."),[i,c]=await Promise.all([l.zv.getProjects(),l.zv.getInvoices()]),console.log("✅ Projects and invoices fetched:",{projectsCount:i.length,invoicesCount:c.length}),console.log("\uD83D\uDCB0 Fetching real financial data from Zoho Books (cached if available)...");let n=[{startDate:r.toISOString().split("T")[0],endDate:e.toISOString().split("T")[0]},{startDate:o.toISOString().split("T")[0],endDate:new Date(t-1,11,31).toISOString().split("T")[0]},{startDate:a.toISOString().split("T")[0],endDate:new Date(t-2,11,31).toISOString().split("T")[0]}],[s,u,g]=await l.zv.getComprehensiveFinancialData(n);d=s,p=u,h=g,console.log("\uD83D\uDCCA Financial data summary (from cache or fresh):"),console.log("- Current year:",d),console.log("- Last year:",p),console.log("- Two years ago:",h)}catch(e){console.error("❌ Failed to fetch basic Zoho data (projects/invoices):",e),i=[],c=[],d={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0},p={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0},h={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log("\uD83D\uDD04 Starting Clockify data fetch...");let f=.85,D=185;try{if(n.configured){console.log("⏰ Clockify configured, fetching real data..."),await u.ZP.getUser(),await u.ZP.getProjects();try{console.log("⏰ Fetching Clockify time entries...");let r=await u.ZP.getAllTimeEntries(new Date(t,0,1).toISOString(),e.toISOString()),o=r.reduce((e,t)=>{let r=t.timeInterval?.duration||"PT0H",o=g(r);return e+o},0),a=r.filter(e=>e.billable).reduce((e,t)=>{let r=t.timeInterval?.duration||"PT0H",o=g(r);return e+o},0);f=o>0?a/o:.85;let n=r.filter(e=>e.billable);n.length>0&&(D=n.reduce((e,t)=>{let r="object"==typeof t.hourlyRate?t.hourlyRate.amount:t.hourlyRate||150;return e+r},0)/n.length),console.log("✅ Clockify utilization data calculated:",{utilizationRate:f,averageBillingRate:D,totalHours:o,billableHours:a})}catch(e){console.warn("⚠️ Failed to calculate utilization rate from Clockify, using defaults:",e)}}else console.log("\uD83C\uDFAD Using mock utilization data due to Clockify not being configured")}catch(e){console.warn("⚠️ Failed to fetch Clockify data, using defaults:",e)}console.log("\uD83E\uDDEE Starting financial calculations...");let v=i.filter(e=>"active"===e.status),m=v.reduce((e,t)=>e+(t.budget_amount||0),0),x=c.filter(e=>"paid"===e.status),P=c.filter(e=>"sent"===e.status||"viewed"===e.status),S=x.reduce((e,t)=>e+(t.total||0),0),y=P.reduce((e,t)=>e+(t.total||0),0),w=d?.revenue||0,I=d?.expenses||0,C=d?.netProfit||d?.grossProfit||0,b=d?.operatingIncome||0,q=d?.cashFlow||S-y,F=.8*q,j=p?.revenue>0&&p?.expenses>0?p.revenue/p.expenses:2.6,k=h?.revenue>0&&h?.expenses>0?h.revenue/h.expenses:2.4,A=I>0?I/w:.35,O=p?.expenses>0&&p?.revenue>0?p.expenses/p.revenue:.37,R=h?.expenses>0&&h?.revenue>0?h.expenses/h.revenue:.39,T=p?.revenue>0?(p.revenue-p.expenses)/p.revenue:.33,E=Array.from({length:12},(e,r)=>{let o=new Date(t,r,1).toLocaleDateString("en-US",{month:"short"}),a=w/12,n=I/12,i=a-n;return{month:o,revenue:Math.round(a),expenses:Math.round(n),profit:Math.round(i),profitMargin:a>0?i/a:0}}),M=Array.from({length:6},(e,r)=>{let o=new Date(t,11+r,1).toLocaleDateString("en-US",{month:"short"}),a=w/12*1.1,n=a*A;return{month:o,projectedRevenue:Math.round(a),projectedExpenses:Math.round(n),projectedProfit:Math.round(a-n)}});console.log("\uD83C\uDFD7️ Building final dashboard data...");let Y={currentYearMultiplier:w>0&&I>0?w/I:2.8,lastYearMultiplier:j,twoYearsAgoMultiplier:k,currentYearOverhead:A,lastYearOverhead:O,twoYearsAgoOverhead:R,currentYearRevenuePerEmployee:w/12,lastYearRevenuePerEmployee:(p?.revenue||0)/12,twoYearsAgoRevenuePerEmployee:(h?.revenue||0)/12,currentCashflow:q,previousMonthCashflow:F,cashflowTrend:q>F?"up":q<F?"down":"stable",overdueInvoiceValue:.3*y,totalOutstandingInvoices:y,averageDaysToPayment:45,ytdProfit:C,lastYearYtdProfit:p?.netProfit||p?.grossProfit||0,currentYearGrossMargin:w>0?(w-I)/w:.35,lastYearGrossMargin:T,ytdOperatingIncome:b,lastYearYtdOperatingIncome:p?.operatingIncome||0,trailing12Months:E,forecast:M,utilizationRate:f,averageProjectSize:m/Math.max(v.length,1),clientRetentionRate:.85,averageBillingRate:D,totalActiveProjects:v.length,totalEmployees:12};return console.log("✅ Dashboard data generated with real financial metrics:",Y),console.log("\uD83D\uDE80 Returning dashboard data to client..."),s.NextResponse.json(Y)}catch(e){return console.error("❌ Dashboard API error:",e),s.NextResponse.json({error:"Failed to generate dashboard data"},{status:500})}}function g(e){if(!e)return 0;let t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return t?parseInt(t[1]||"0")+parseInt(t[2]||"0")/60+parseInt(t[3]||"0")/3600:0}let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/dashboard/route",pathname:"/api/dashboard",filename:"route",bundlePath:"app/api/dashboard/route"},resolvedPagePath:"C:\\Users\\Jonathan\\Desktop\\Billing\\app\\api\\dashboard\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:D}=p,v="/api/dashboard/route";function m(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:f})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,8918,8403,4261],()=>r(5758));module.exports=o})();