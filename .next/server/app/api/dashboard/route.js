"use strict";(()=>{var e={};e.id=3707,e.ids=[3707],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},5758:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>D,staticGenerationAsyncStorage:()=>h});var r={};o.r(r),o.d(r,{GET:()=>g,dynamic:()=>u});var n=o(49303),a=o(88716),s=o(60670),i=o(87070),l=o(87707),c=o(88403);let u="force-dynamic";async function g(e){try{console.log("\uD83D\uDE80 Dashboard API called - starting data collection...");let e=new Date,t=e.getFullYear(),o=new Date(t,0,1),r=new Date(t-1,0,1),n=new Date(t-2,0,1);console.log("\uD83D\uDCC5 Date ranges calculated:",{currentYear:t,currentYearStart:o.toISOString(),lastYearStart:r.toISOString(),twoYearsAgoStart:n.toISOString()});let a=c.ZP.getConfigurationStatus();console.log("Clockify service configuration:",a),a.configured||console.warn("Clockify service not configured - using mock data for time tracking metrics");let s=[],u=[],g=null,p=null,f=null;console.log("\uD83D\uDD04 Starting Zoho data fetch...");try{console.log("\uD83D\uDCCA Fetching projects and invoices..."),[s,u]=await Promise.all([l.VC.getProjects(),l.VC.getInvoices()]),console.log("✅ Projects and invoices fetched:",{projectsCount:s.length,invoicesCount:u.length}),console.log("\uD83D\uDCB0 Fetching real financial data from Zoho Books...");try{console.log("\uD83D\uDCC8 Fetching current year financials..."),g=await l.VC.getFinancialMetrics(o.toISOString().split("T")[0],e.toISOString().split("T")[0]),console.log("✅ Current year financials loaded successfully:",g)}catch(e){console.warn("⚠️ Failed to fetch current year financials, using defaults:",e),g={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}try{console.log("\uD83D\uDCC8 Fetching last year financials..."),p=await l.VC.getFinancialMetrics(r.toISOString().split("T")[0],new Date(t-1,11,31).toISOString().split("T")[0]),console.log("✅ Last year financials loaded successfully:",p)}catch(e){console.warn("⚠️ Failed to fetch last year financials, using defaults:",e),p={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}try{console.log("\uD83D\uDCC8 Fetching two years ago financials..."),f=await l.VC.getFinancialMetrics(n.toISOString().split("T")[0],new Date(t-2,11,31).toISOString().split("T")[0]),console.log("✅ Two years ago financials loaded successfully:",f)}catch(e){console.warn("⚠️ Failed to fetch two years ago financials, using defaults:",e),f={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log("\uD83D\uDCCA Financial data summary:"),console.log("- Current year:",g),console.log("- Last year:",p),console.log("- Two years ago:",f)}catch(e){console.error("❌ Failed to fetch basic Zoho data (projects/invoices):",e),s=[],u=[],g={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0},p={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0},f={revenue:0,expenses:0,netProfit:0,grossProfit:0,operatingIncome:0,cashFlow:0}}console.log("\uD83D\uDD04 Starting Clockify data fetch...");let h=.85,D=185;try{if(a.configured){console.log("⏰ Clockify configured, fetching real data..."),await c.ZP.getUser(),await c.ZP.getProjects();try{console.log("⏰ Fetching Clockify time entries...");let o=await c.ZP.getAllTimeEntries(new Date(t,0,1).toISOString(),e.toISOString()),r=o.reduce((e,t)=>{let o=t.timeInterval?.duration||"PT0H",r=d(o);return e+r},0),n=o.filter(e=>e.billable).reduce((e,t)=>{let o=t.timeInterval?.duration||"PT0H",r=d(o);return e+r},0);h=r>0?n/r:.85;let a=o.filter(e=>e.billable);a.length>0&&(D=a.reduce((e,t)=>{let o="object"==typeof t.hourlyRate?t.hourlyRate.amount:t.hourlyRate||150;return e+o},0)/a.length),console.log("✅ Clockify utilization data calculated:",{utilizationRate:h,averageBillingRate:D,totalHours:r,billableHours:n})}catch(e){console.warn("⚠️ Failed to calculate utilization rate from Clockify, using defaults:",e)}}else console.log("\uD83C\uDFAD Using mock utilization data due to Clockify not being configured")}catch(e){console.warn("⚠️ Failed to fetch Clockify data, using defaults:",e)}console.log("\uD83E\uDDEE Starting financial calculations...");let v=s.filter(e=>"active"===e.status),y=v.reduce((e,t)=>e+(t.budget_amount||0),0),m=u.filter(e=>"paid"===e.status),x=u.filter(e=>"sent"===e.status||"viewed"===e.status),P=m.reduce((e,t)=>e+(t.total||0),0),w=x.reduce((e,t)=>e+(t.total||0),0),C=g?.revenue||0,S=g?.expenses||0,I=g?.netProfit||g?.grossProfit||0,F=g?.operatingIncome||0,b=g?.cashFlow||P-w,j=.8*b,k=p?.revenue>0&&p?.expenses>0?p.revenue/p.expenses:2.6,q=f?.revenue>0&&f?.expenses>0?f.revenue/f.expenses:2.4,M=S>0?S/C:.35,T=p?.expenses>0&&p?.revenue>0?p.expenses/p.revenue:.37,A=f?.expenses>0&&f?.revenue>0?f.expenses/f.revenue:.39,O=p?.revenue>0?(p.revenue-p.expenses)/p.revenue:.33,R=Array.from({length:12},(e,o)=>{let r=new Date(t,o,1).toLocaleDateString("en-US",{month:"short"}),n=C/12,a=S/12,s=n-a;return{month:r,revenue:Math.round(n),expenses:Math.round(a),profit:Math.round(s),profitMargin:n>0?s/n:0}}),E=Array.from({length:6},(e,o)=>{let r=new Date(t,11+o,1).toLocaleDateString("en-US",{month:"short"}),n=C/12*1.1,a=n*M;return{month:r,projectedRevenue:Math.round(n),projectedExpenses:Math.round(a),projectedProfit:Math.round(n-a)}});console.log("\uD83C\uDFD7️ Building final dashboard data...");let Y={currentYearMultiplier:C>0&&S>0?C/S:2.8,lastYearMultiplier:k,twoYearsAgoMultiplier:q,currentYearOverhead:M,lastYearOverhead:T,twoYearsAgoOverhead:A,currentYearRevenuePerEmployee:C/12,lastYearRevenuePerEmployee:(p?.revenue||0)/12,twoYearsAgoRevenuePerEmployee:(f?.revenue||0)/12,currentCashflow:b,previousMonthCashflow:j,cashflowTrend:b>j?"up":b<j?"down":"stable",overdueInvoiceValue:.3*w,totalOutstandingInvoices:w,averageDaysToPayment:45,ytdProfit:I,lastYearYtdProfit:p?.netProfit||p?.grossProfit||0,currentYearGrossMargin:C>0?(C-S)/C:.35,lastYearGrossMargin:O,ytdOperatingIncome:F,lastYearYtdOperatingIncome:p?.operatingIncome||0,trailing12Months:R,forecast:E,utilizationRate:h,averageProjectSize:y/Math.max(v.length,1),clientRetentionRate:.85,averageBillingRate:D,totalActiveProjects:v.length,totalEmployees:12};return console.log("✅ Dashboard data generated with real financial metrics:",Y),console.log("\uD83D\uDE80 Returning dashboard data to client..."),i.NextResponse.json(Y)}catch(e){return console.error("❌ Dashboard API error:",e),i.NextResponse.json({error:"Failed to generate dashboard data"},{status:500})}}function d(e){if(!e)return 0;let t=e.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);return t?parseInt(t[1]||"0")+parseInt(t[2]||"0")/60+parseInt(t[3]||"0")/3600:0}let p=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/dashboard/route",pathname:"/api/dashboard",filename:"route",bundlePath:"app/api/dashboard/route"},resolvedPagePath:"C:\\Users\\Jonathan\\Desktop\\Billing\\app\\api\\dashboard\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:D}=p,v="/api/dashboard/route";function y(){return(0,s.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:h})}}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[9276,5972,8918,7707,8403],()=>o(5758));module.exports=r})();