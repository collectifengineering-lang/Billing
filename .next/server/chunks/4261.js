"use strict";exports.id=4261,exports.ids=[4261],exports.modules={57033:(e,t,a)=>{a.d(t,{M:()=>o,j:()=>s});var i=a(53524);let r=global.prisma||new i.PrismaClient;class o{constructor(e){this.startTime=0,this.endpoint="",this.rateLimitHit=!1,this.retryCount=0,this.totalWaitTime=0,this.endpoint=e,this.startTime=Date.now()}recordRateLimitHit(e){this.rateLimitHit=!0,this.totalWaitTime+=e,this.retryCount++}async recordSuccess(e){let t=Date.now()-this.startTime;try{await r.performanceTelemetry.create({data:{endpoint:this.endpoint,duration:t,success:!0,rateLimitHit:this.rateLimitHit,retryCount:this.retryCount,totalWaitTime:this.totalWaitTime,metadata:e?JSON.stringify(e):null}});let a={endpoint:this.endpoint,duration:`${t}ms`,rateLimitHit:this.rateLimitHit,retryCount:this.retryCount,totalWaitTime:this.totalWaitTime>0?`${this.totalWaitTime}ms`:"0ms"};this.totalWaitTime>5e3?console.warn("‚ö†Ô∏è High rate limit wait time:",a):t>3e3?console.warn("‚ö†Ô∏è Slow API call:",a):console.info("‚úÖ API call completed:",a)}catch(e){console.error("Failed to record telemetry:",e)}}async recordFailure(e,t){let a=Date.now()-this.startTime;try{await r.performanceTelemetry.create({data:{endpoint:this.endpoint,duration:a,success:!1,errorMessage:e.message,rateLimitHit:this.rateLimitHit,retryCount:this.retryCount,totalWaitTime:this.totalWaitTime,metadata:t?JSON.stringify(t):null}}),console.error("‚ùå API call failed:",{endpoint:this.endpoint,duration:`${a}ms`,error:e.message,rateLimitHit:this.rateLimitHit,retryCount:this.retryCount,totalWaitTime:this.totalWaitTime>0?`${this.totalWaitTime}ms`:"0ms"})}catch(e){console.error("Failed to record telemetry:",e)}}static async getAnalytics(e,t=24){let a=new Date(Date.now()-36e5*t),i=await r.performanceTelemetry.findMany({where:{endpoint:e,timestamp:{gte:a}}}),o=i.length,s=i.filter(e=>e.success).length,n=i.filter(e=>e.rateLimitHit).length,c=i.reduce((e,t)=>e+t.duration,0),l=i.reduce((e,t)=>e+t.totalWaitTime,0);return{totalCalls:o,successRate:o>0?s/o:0,averageDuration:o>0?c/o:0,rateLimitHitRate:o>0?n/o:0,averageWaitTime:o>0?l/o:0,slowCallCount:i.filter(e=>e.duration>3e3).length}}static async getSystemMetrics(e=24){let t=new Date(Date.now()-36e5*e),a=await r.performanceTelemetry.findMany({where:{timestamp:{gte:t}}}),i=a.length,o=a.filter(e=>e.success).length;return{totalApiCalls:i,overallSuccessRate:i>0?o/i:0,totalRateLimitHits:a.filter(e=>e.rateLimitHit).length,totalWaitTime:a.reduce((e,t)=>e+t.totalWaitTime,0),endpointsWithHighWaitTime:Object.entries(a.reduce((e,t)=>(e[t.endpoint]||(e[t.endpoint]={total:0,count:0}),e[t.endpoint].total+=t.totalWaitTime,e[t.endpoint].count+=1,e),{})).map(([e,t])=>({endpoint:e,avgWaitTime:t.total/t.count})).filter(e=>e.avgWaitTime>5e3).sort((e,t)=>t.avgWaitTime-e.avgWaitTime)}}static async cleanup(e=30){let t=new Date(Date.now()-864e5*e),a=await r.performanceTelemetry.deleteMany({where:{timestamp:{lt:t}}});return console.log(`üßπ Cleaned up ${a.count} old telemetry records`),a.count}}async function s(e,t,a){let i=new o(e);try{let e=await t(i);return await i.recordSuccess(a),e}catch(e){throw await i.recordFailure(e,a),e}}},44261:(e,t,a)=>{a.d(t,{zv:()=>d});var i=a(24263),r=a(57870),o=a.n(r),s=a(53524),n=a(57033);let c=global.prisma||new s.PrismaClient,l=e=>"object"==typeof e&&null!==e&&"response"in e;class h{constructor(){this.ACCOUNTS_BASE=process.env.ZOHO_ACCOUNTS_BASE||"https://accounts.zoho.com",this.API_BASE=process.env.ZOHO_API_BASE||"https://www.zohoapis.com",this.organizationValidated=!1,this.requestCount=0,this.windowStartTime=Date.now(),this.MAX_REQUESTS_PER_MINUTE=80,this.MIN_REQUEST_INTERVAL=750,this.MAX_RETRIES=5,this.BASE_RETRY_DELAY=2e3,this.rateLimiter=o()(10),this.TOKEN_CACHE_BUFFER=3e5,this.FINANCIAL_DATA_CACHE_TTL=36e5,this.PROJECTS_CACHE_TTL=9e5,this.INVOICES_CACHE_TTL=9e5,console.log(`‚ú® Optimized Zoho Service initialized | API: ${this.API_BASE} | Accounts: ${this.ACCOUNTS_BASE}`)}async getAccessToken(){let e=new n.M("zoho.getAccessToken");try{let t=new Date,a=await c.zohoTokenCache.findFirst({where:{expiresAt:{gt:new Date(t.getTime()+this.TOKEN_CACHE_BUFFER)}},orderBy:{createdAt:"desc"}});if(a&&!process.env.ZOHO_FORCE_REFRESH){let i=Math.round((a.expiresAt.getTime()-t.getTime())/6e4);return console.log(`üîê Using cached Zoho token from Supabase (expires in ${i} minutes)`),await e.recordSuccess({source:"cache",minutesLeft:i}),a.accessToken}console.log("\uD83D\uDD04 Refreshing Zoho token...");let i=await this.refreshAccessToken(e);return await e.recordSuccess({source:"refresh"}),i}catch(t){throw await e.recordFailure(t),t}}async refreshAccessToken(e){for(let t=1;t<=this.MAX_RETRIES;t++)try{let e=new URLSearchParams;e.append("refresh_token","1000.4bf26c4881dfba83aae32546453d662d.a9353e91362a18c457b5cbec86b10ed2"),e.append("client_id","1000.8RL8WMTDXS0WIP2EJF2XUS6NDSLQEP"),e.append("client_secret","8a7ee3c04f0a0d860dd215c4449deab9bf15d1d00b"),e.append("grant_type","refresh_token");let t=await i.default.post(`${this.ACCOUNTS_BASE}/oauth/v2/token`,e,{headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3});if(!t.data.access_token)throw Error("No access token received from Zoho");let a=new Date(Date.now()+1e3*t.data.expires_in);await c.zohoTokenCache.create({data:{accessToken:t.data.access_token,expiresAt:a,refreshToken:t.data.refresh_token,apiDomain:t.data.api_domain}});let r=await c.zohoTokenCache.findMany({orderBy:{createdAt:"desc"},skip:5});r.length>0&&await c.zohoTokenCache.deleteMany({where:{id:{in:r.map(e=>e.id)}}});let o=Math.round(t.data.expires_in/60);return console.log(`‚úÖ Token refreshed and cached in Supabase (valid for ${o} minutes)`),t.data.access_token}catch(a){if(this.isRateLimitError(a)&&t<this.MAX_RETRIES){let i=this.getRetryAfter(a)||this.calculateExponentialBackoff(t);console.warn(`‚è≥ Zoho token refresh rate-limited (attempt ${t}/${this.MAX_RETRIES}). Waiting ${i}ms...`),e.recordRateLimitHit(i),await this.delay(i);continue}if(t===this.MAX_RETRIES)throw Error(`Zoho token refresh failed after ${this.MAX_RETRIES} attempts`);throw a}throw Error("Zoho token refresh failed after maximum retries")}async makeRequest(e,t){return this.rateLimiter(async()=>{let a=t||new n.M(`zoho.${e.split("?")[0]}`);try{await this.applyRateLimit();let r=await this.getAccessToken();if(!r||"undefined"===r)throw Error("Invalid or missing access token");!this.organizationValidated&&e.startsWith("reports/")&&await this.validateOrganization(r),console.info(`üì° Zoho API: ${e}`);let o=await i.default.get(`${this.API_BASE}/books/v3/${e}`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},params:{organization_id:"652094923"},timeout:15e3});return this.requestCount++,t||await a.recordSuccess({endpoint:e}),o.data}catch(i){if(t||await a.recordFailure(i,{endpoint:e}),this.isRateLimitError(i))return await this.handleRateLimitAndRetry(e,i,a,1);if(l(i)&&i.response?.status===401)return await this.handleTokenExpiryAndRetry(e,a);throw console.error(`‚ùå Zoho API error for ${e}:`,{status:l(i)?i.response?.status:void 0,message:i.message}),i}})}async handleRateLimitAndRetry(e,t,a,r){if(r>=this.MAX_RETRIES)throw Error(`Zoho API rate limit exceeded after ${this.MAX_RETRIES} retries`);let o=this.getRetryAfter(t)||this.calculateExponentialBackoff(r);console.warn(`‚è≥ Rate limit hit for ${e} (attempt ${r}/${this.MAX_RETRIES}). Waiting ${o}ms...`),a.recordRateLimitHit(o),await this.delay(o),this.requestCount=0,this.windowStartTime=Date.now();try{await this.applyRateLimit();let t=await this.getAccessToken(),a=await i.default.get(`${this.API_BASE}/books/v3/${e}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{organization_id:"652094923"},timeout:15e3});return console.info(`‚úÖ Retry successful for ${e} after rate limit`),a.data}catch(t){if(this.isRateLimitError(t))return await this.handleRateLimitAndRetry(e,t,a,r+1);throw t}}async handleTokenExpiryAndRetry(e,t){console.info("\uD83D\uDD04 Token expired, refreshing and retrying...");let a=await this.refreshAccessToken(t),r=await i.default.get(`${this.API_BASE}/books/v3/${e}`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{organization_id:"652094923"},timeout:15e3});return console.info("‚úÖ Retry successful after token refresh"),r.data}isRateLimitError(e){if(!l(e))return!1;let t=e.response?.status,a=e.response?.data?.error_description?.toLowerCase()||"";return 429===t||400===t&&a.includes("too many requests")}getRetryAfter(e){if(!l(e))return null;let t=e.response?.headers?.[" retry-after"]||e.response?.headers?.["retry-after"];if(t){let e=parseInt(t,10);if(!isNaN(e))return 1e3*e}return null}calculateExponentialBackoff(e){return Math.min(this.BASE_RETRY_DELAY*Math.pow(2,e-1)+1e3*Math.random(),6e4)}async applyRateLimit(){let e=Date.now(),t=e-this.windowStartTime;if(t>=6e4){this.requestCount=0,this.windowStartTime=e;return}if(this.requestCount>=this.MAX_REQUESTS_PER_MINUTE){let e=6e4-t;console.warn(`‚è≥ Rate limit reached (${this.requestCount}/${this.MAX_REQUESTS_PER_MINUTE} requests). Waiting ${e}ms...`),await this.delay(e),this.requestCount=0,this.windowStartTime=Date.now();return}await this.delay(this.MIN_REQUEST_INTERVAL)}async validateOrganization(e){let t="652094923";if(!t){console.warn("‚ö†Ô∏è ZOHO_ORGANIZATION_ID not set");return}try{let a=await i.default.get(`${this.API_BASE}/books/v3/organizations`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},timeout:15e3});(a.data?.organizations||[]).some(e=>String(e.organization_id)===String(t))?(this.organizationValidated=!0,console.log(`‚úÖ Validated organization ID: ${t}`)):console.error(`‚ùå Organization ID ${t} not found in Zoho account`)}catch(e){console.error("‚ùå Failed to validate organization:",e)}}delay(e){return new Promise(t=>setTimeout(t,e))}async getCachedData(e,t,a){try{let i=await c.financialDataCache.findUnique({where:{cacheKey:e}});if(i&&i.expiresAt>new Date){let t=Math.round((i.expiresAt.getTime()-Date.now())/6e4);return console.log(`üíæ Using cached data for ${e} (expires in ${t} minutes)`),JSON.parse(i.data)}console.log(`üîÑ Cache miss for ${e}, fetching fresh data...`);let r=await a(),o=new Date(Date.now()+t);return await c.financialDataCache.upsert({where:{cacheKey:e},create:{cacheKey:e,data:JSON.stringify(r),expiresAt:o},update:{data:JSON.stringify(r),expiresAt:o}}),console.log(`‚úÖ Data cached for ${e} (TTL: ${t/1e3}s)`),r}catch(t){return console.error(`‚ùå Cache error for ${e}, falling back to fresh data:`,t),await a()}}async batchFetch(e,t){console.log(`üì¶ Batch fetching ${e.length} endpoints in parallel...`);let a=await Promise.all(e.map(e=>this.makeRequest(e,t)));return console.log(`‚úÖ Batch fetch completed: ${e.length} endpoints`),a}async getProjects(){return(0,n.j)("zoho.getProjects",async e=>this.getCachedData("projects_all",this.PROJECTS_CACHE_TTL,async()=>{let t=[],a=1;for(;;){let i=await this.makeRequest(`projects?page=${a}&per_page=200`,e),r=i.projects?.map(e=>({project_id:e.project_id,project_name:e.project_name||e.name||"",description:e.description||"",status:e.status||"active",start_date:e.start_date||"",end_date:e.end_date||"",budget_amount:e.budget_amount||0,rate_per_hour:e.rate_per_hour||0,customer_id:e.customer_id||"",customer_name:e.customer_name||"",signed_fee:void 0}))||[];if(t=t.concat(r),r.length<200)break;a++}return console.log(`‚úÖ Fetched ${t.length} projects from Zoho`),t}))}async getInvoices(){return(0,n.j)("zoho.getInvoices",async e=>this.getCachedData("invoices_all",this.INVOICES_CACHE_TTL,async()=>{let t=[],a=1;for(;;){let i=await this.makeRequest(`invoices?page=${a}&per_page=200`,e),r=i.invoices||[];if(t=t.concat(r),!i.page_context?.has_more_page||0===r.length)break;a++}let i=t.map(e=>{let t=e.total||0,a=e.status||"unknown",i=0,r=0;return"paid"===a?i=t:(["sent","viewed","draft"].includes(a),r=t),{invoice_id:e.invoice_id,project_id:e.project_id,invoice_number:e.invoice_number,date:e.date,amount:t,status:a,billed_amount:i,unbilled_amount:r}});return console.log(`‚úÖ Fetched ${i.length} invoices from Zoho`),i}))}async getFinancialMetrics(e,t){return(0,n.j)("zoho.getFinancialMetrics",async a=>{let i=`financial_metrics_${e}_${t}`;return this.getCachedData(i,this.FINANCIAL_DATA_CACHE_TTL,async()=>{console.info(`üí∞ Fetching Zoho financial metrics for ${e} to ${t}`);let[i,r,o]=await Promise.allSettled([this.makeRequest(`reports/profitandloss?from_date=${e}&to_date=${t}`,a),this.makeRequest(`reports/cashflow?from_date=${e}&to_date=${t}`,a),this.makeRequest(`reports/balancesheet?date=${t}`,a)]),s=0,n=0,c=0;if("fulfilled"===i.status&&i.value){let e=i.value;s=e.revenue?.total||e.revenue||e.income?.total||e.income||0,n=e.expenses?.total||e.expenses||e.cost_of_goods_sold?.total||0,c=e.operating_expenses?.total||e.operating_expenses||0}let l=s-n,h=l-c,d=l-c,u="fulfilled"===r.status&&r.value?.net_cash_flow||0,m={revenue:s,expenses:n,grossProfit:l,netProfit:h,operatingIncome:d,cashFlow:u,accountsReceivable:"fulfilled"===o.status&&o.value?.current_assets?.accounts_receivable||0,accountsPayable:"fulfilled"===o.status&&o.value?.current_liabilities?.accounts_payable||0,cashBalance:"fulfilled"===o.status&&o.value?.current_assets?.cash_and_bank||0};return console.info("‚úÖ Financial metrics fetched:",m),m})})}async getComprehensiveFinancialData(e){console.log(`üöÄ Fetching comprehensive financial data for ${e.length} date ranges...`);let t=await Promise.all(e.map(e=>this.getFinancialMetrics(e.startDate,e.endDate)));return console.log(`‚úÖ Comprehensive financial data fetched for ${e.length} date ranges`),t}async forceRefreshToken(){let e=new n.M("zoho.forceRefreshToken");try{let t=await this.refreshAccessToken(e);return await e.recordSuccess(),t}catch(t){throw await e.recordFailure(t),t}}async clearAllCaches(){await c.financialDataCache.deleteMany({}),console.log("\uD83E\uDDF9 All caches cleared")}async getCacheStats(){let e=await c.financialDataCache.findMany(),t=new Date,a=e.filter(e=>e.expiresAt>t),i=e.filter(e=>e.expiresAt<=t),r=e.reduce((e,t)=>e+t.data.length,0);return{totalCachedItems:e.length,activeItems:a.length,expiredItems:i.length,totalSize:r}}}let d=new h}};